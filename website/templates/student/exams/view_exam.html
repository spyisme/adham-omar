{% extends "student/dashboard.html" %}
{% block title %}Exam Details{% endblock %}
{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  :root {
    --primary: #4f46e5;
    --primary-hover: #4338ca;
    --primary-light: #eef2ff;
    --success: #10b981;
    --success-light: #d1fae5;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --bg-card: #ffffff;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  * {
    box-sizing: border-box;
  }

  .container {
    max-width: 896px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 2rem;
    color: white;
  }

  .page-title {
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .page-subtitle {
    font-size: 1.125rem;
    opacity: 0.95;
  }

  .card {
    background: var(--bg-card);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .card-header {
    padding: 2rem;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(to bottom, #fafafa, #ffffff);
  }

  .card-header-flex {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .card-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.875rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .badge-open {
    background: rgba(99, 102, 241, 0.1);
    color: #4338ca;
    border: 1px solid rgba(99, 102, 241, 0.3);
  }

  .badge-completed {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .badge-late {
    background: rgba(245, 158, 11, 0.1);
    color: #d97706;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .badge-expired {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }

  .card-mark {
    margin-top: 0.75rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }

  .card-mark-value {
    font-weight: 600;
    color: var(--primary);
    font-size: 1.125rem;
  }

  .card-body {
    padding: 2rem;
  }

  .card-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  .card-section:first-child {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
  }

  .description-text {
    color: var(--text-secondary);
    line-height: 1.7;
    white-space: pre-wrap;
  }

  .attachments-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .attachments-list li {
    margin-bottom: 0.75rem;
  }

  .attachments-list a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
    word-break: break-all;
  }

  .attachments-list a:hover {
    color: var(--primary-hover);
    text-decoration: underline;
  }

  .attachments-list a::before {
    content: 'üìé';
    font-size: 1.125rem;
  }

  .submission-info {
    background: var(--primary-light);
    border-left: 4px solid var(--primary);
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.9375rem;
    color: var(--text-primary);
  }

  .submission-info strong {
    font-weight: 600;
  }

  .actions-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
  }

  .btn-secondary {
    background: white;
    color: var(--text-primary);
    border-color: var(--border-color);
  }

  .btn-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }

  .btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
  }

  .file-input-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .file-input-wrapper input[type="file"] {
    display: none;
  }

  .file-input-wrapper label {
    background: white;
    color: var(--primary);
    border: 2px dashed var(--primary);
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .file-input-wrapper label:hover {
    background: var(--primary-light);
    border-color: var(--primary-hover);
  }

  #file-name {
    color: var(--text-secondary);
    font-size: 0.9375rem;
  }

  #progress-container {
    width: 100%;
    height: 0.75rem;
    background: var(--border-color);
    border-radius: 9999px;
    overflow: hidden;
    margin: 1.5rem 0;
  }

  #progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-hover));
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 9999px;
  }

  #status-message {
    font-size: 0.9375rem;
    margin: 1rem 0;
    font-weight: 500;
  }

  .hidden {
    display: none !important;
  }

  .browser-warning {
    background: var(--warning-light);
    border: 1px solid var(--warning);
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    display: none;
    color: #92400e;
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .browser-warning strong {
    font-weight: 600;
    color: #78350f;
  }

  @media (max-width: 640px) {
    .container {
      padding: 1rem;
    }

    .page-title {
      font-size: 1.875rem;
    }

    .card-header,
    .card-body {
      padding: 1.5rem;
    }

    .card-title {
      font-size: 1.5rem;
    }

    .actions-group {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }
  }
</style>

<div class="container">
  <div class="page-header">
    <h1 class="page-title">üìù Exam Details</h1>
    <p class="page-subtitle">Everything you need to submit successfully</p>
  </div>

  <div id="browser-warning" class="browser-warning">
    ‚ö†Ô∏è <strong>Browser Compatibility Notice:</strong> Uploads may fail on your current browser. For the best
    experience and reliable uploads, please use the latest version of <strong>Google Chrome</strong>.
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-header-flex">
        <h2 class="card-title">{{ assignment.title }}</h2>

        {% set is_completed = assignment.done %}
        {% set is_completed_late = assignment.done and assignment.submitted_late %}
        {% set has_extension = assignment.late_exception_active %}
        {% set is_expired = (not assignment.done) and assignment.expired_for_student %}
        {% set status_label = 'Open' %}
        {% set status_class = 'badge-open' %}
        {% if is_completed and not is_completed_late %}
        {% set status_label = 'Completed' %}
        {% set status_class = 'badge-completed' %}
        {% elif is_completed_late %}
        {% set status_label = 'Completed Late' %}
        {% set status_class = 'badge-late' %}
        {% elif is_expired %}
        {% set status_label = 'Expired' %}
        {% set status_class = 'badge-expired' %}
        {% elif has_extension %}
        {% set status_label = 'Extended' %}
        {% set status_class = 'badge-extended' %}
        {% elif (not assignment.done) and assignment.past_deadline %}
        {% set status_label = 'Deadline Passed' %}
        {% set status_class = 'badge-late' %}
        {% endif %}

        <span class="badge {{ status_class }}">{{ status_label }}</span>
      </div>

      {% if assignment.deadline_date %}
      <div class="card-meta">
        <span>üóìÔ∏è</span>
        <span>Deadline: {{ assignment.deadline_date.strftime('%B %d, %Y at %I:%M %p') }}</span>
      </div>
      {% endif %}

      {% if assignment.late_exception_active %}
      <div class="extension-note">
        You have an extension
        {% if assignment.late_exception_deadline %}
        until <strong>{{ assignment.late_exception_deadline.strftime('%B %d, %Y at %I:%M %p') }}</strong>.
        {% else %}
        with no set deadline. Please submit as soon as possible.
        {% endif %}
      </div>
      {% elif assignment.late_exception %}
      <div class="extension-note expired">
        Your extension expired
        {% if assignment.late_exception_deadline %}
        on <strong>{{ assignment.late_exception_deadline.strftime('%B %d, %Y at %I:%M %p') }}</strong>.
        {% else %}
        recently.
        {% endif %}
      </div>
      {% endif %}

      {% if assignment.submission and assignment.submission.mark is not none %}
      <div class="card-mark">
        Mark:
        <span class="card-mark-value">{{ assignment.submission.mark }}</span>
      </div>
      {% endif %}
    </div>

    <div class="card-body">
      {% if assignment.description %}
      <section>
        <h3 class="section-title">Description</h3>
        <p class="description-text">{{ assignment.description }}</p>
      </section>
      {% endif %}

      <section class="card-section">
        <h3 class="section-title">Attachments</h3>
        {% if attachments %}
        <ul class="attachments-list">
          {% for attachment in attachments %}
          {% if attachment is mapping %}
            {% if attachment.type == 'link' %}
            <li>üîó <a href="{{ attachment.url }}" target="_blank" rel="noopener">{{ attachment.name }}</a></li>
            {% elif attachment.type == 'file' %}
            <li>üìé <a href="{{ attachment.url }}" target="_blank" rel="noopener">{{ attachment.name }}</a></li>
            {% endif %}
          {% elif "http" in attachment %}
          <li>üîó <a href="{{ attachment }}" target="_blank" rel="noopener">External Link</a></li>
          {% else %}
          <li>üìé <a href="{{ url_for('student.assignment_media', filename=attachment) }}" target="_blank"
              rel="noopener">{{ attachment }}</a></li>
          {% endif %}
          {% endfor %}
        </ul>
        {% else %}
        <p class="description-text">No attachments provided.</p>
        {% endif %}

        
      <section class="card-section">
        {% if submission %}
        <h3 class="section-title">Your Submission</h3>
        <div class="submission-info">
          <strong>Submitted on:</strong> {{ submission.upload_time.strftime('%B %d, %Y at %I:%M %p') }}
        </div>
        <div class="actions-group">
          <a href="{{ url_for('student.student_submission_media_exam', exam_id=assignment.id) }}" target="_blank"
            rel="noopener" class="btn btn-secondary">
            üìÑ View Submission
          </a>
          <form method="POST" action="{{ url_for('student.delete_submission_exam', exam_id=assignment.id) }}"
            style="margin: 0;">
            <button type="submit" class="btn btn-danger"
              onclick="return confirm('Are you sure you want to delete your submission?')">
              üóëÔ∏è Delete Submission
            </button>
          </form>
        </div>

        {% if submission.mark is not none and submission.mark != "Not marked yet" and submission.assignment.out_of > 0 %}
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <div style="margin-bottom: 1rem;">
            <strong>Mark:</strong> <span style="color: var(--primary); font-weight: 600;">{{ submission.mark }}</span>
          </div>
          {% if submission.show_corrected %}
          <h4 class="section-title" style="font-size: 1.125rem;">Correction</h4>
          <a href="{{ url_for('student.corrected_pdf', submission_id=submission.id) }}" target="_blank" rel="noopener"
            class="btn btn-secondary">
            üìÑ View Correction
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if submission.show_corrected and submission.assignment.out_of == 0 %}
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h4 class="section-title" style="font-size: 1.125rem;">Correction</h4>
          <a href="{{ url_for('student.corrected_pdf', submission_id=submission.id) }}" target="_blank" rel="noopener"
            class="btn btn-secondary">
            üìÑ View Correction
          </a>
        </div>
        {% endif %}

        {% elif assignment.expired_for_student %}
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h3 class="section-title">Exam Closed</h3>
          <p class="description-text">This exam is closed and no longer accepts submissions.</p>
        </div>

        {% else %}
        <h3 class="section-title">Submit Your Exam</h3>

        {% if assignment.late_exception_active %}
        <div class="extension-note">
          You can submit
          {% if assignment.late_exception_deadline %}
          until <strong>{{ assignment.late_exception_deadline.strftime('%B %d, %Y at %I:%M %p') }}</strong>.
          {% else %}
          thanks to your granted extension.
          {% endif %}
        </div>
        {% elif assignment.past_deadline and not assignment.expired_for_student %}
        <div class="extension-note">
          The original deadline has passed, but submissions remain open for now.
        </div>
        {% endif %}

        <form id="upload-form" action="{{ url_for('student.upload_exam_chunk', exam_id=assignment.id) }}" method="POST"
          enctype="multipart/form-data" novalidate>
          <input type="hidden" id="csrf-token" name="csrf_token"
            value="{{ csrf_token() if csrf_token is defined else '' }}">

          <div class="file-input-wrapper">
            <input type="file" id="file" name="file" required
              accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,image/jpeg,image/png"
              {% if assignment.past_deadline and assignment.close_after_deadline %}disabled{% endif %}>
            <label for="file">üìé Choose File</label>
            <span id="file-name">No file chosen</span>
          </div>

          <div id="progress-container" class="hidden">
            <div id="progress-bar"></div>
          </div>

          <div id="status-message"></div>

          <button type="submit" class="btn btn-primary" {% if assignment.past_deadline and assignment.close_after_deadline %}disabled{% endif %}>‚úÖ Submit Exam</button>
        </form>
        {% endif %}
      </section>
    </div>
  </div>
</div>

<script>
  // Browser detection - show warning if not Chrome
  (function () {
    const ua = navigator.userAgent;
    const vendor = navigator.vendor || '';

    // Check for Chrome on desktop/Android (Chrome + Google Inc vendor)
    const isChromeDesktop = /Chrome/.test(ua) && /Google Inc/.test(vendor);

    // Check for Chrome on iOS (CriOS in user agent)
    const isChromeIOS = /CriOS/.test(ua);

    // Check for Chromium-based Edge
    const isEdgeChromium = /Edg/.test(ua) && /Chrome/.test(ua);

    const isChrome = isChromeDesktop || isChromeIOS || isEdgeChromium;

    if (!isChrome) {
      const warning = document.getElementById('browser-warning');
      if (warning) {
        warning.style.display = 'block';
      }
    }
  })();

  document.addEventListener('DOMContentLoaded', function () {
    const uploadForm = document.getElementById('upload-form');
    if (!uploadForm) return;

    const fileInput = document.getElementById('file');
    const fileNameSpan = document.getElementById('file-name');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const submitButton = uploadForm.querySelector('button[type="submit"]');
    const csrfTokenInput = document.getElementById('csrf-token');

    const MAX_RETRIES = 3;
    const CHUNK_TIMEOUT_MS = 30000; // 30s per chunk

    const ALLOWED_EXTS = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'jpg', 'jpeg', 'png'];
    const BLOCKED_EXTS = ['heic', 'heif'];

    function setStatus(msg, colorVar) {
      statusMessage.textContent = msg;
      statusMessage.style.color = colorVar || 'var(--text-secondary)';
    }

    function resetUploadUI() {
      submitButton.disabled = false;
      submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      progressContainer.classList.add('hidden');
      progressBar.style.width = '0%';
      fileInput.value = '';
      fileNameSpan.textContent = 'No file chosen';
    }

    function getExt(name) {
      const dot = name.lastIndexOf('.');
      return dot >= 0 ? name.slice(dot + 1).toLowerCase() : '';
    }

    function humanSize(bytes) {
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) {
        n /= 1024;
        i++;
      }
      return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
    }

    function chooseChunkSize(totalBytes) {
      if (totalBytes <= 2 * 1024 * 1024) return 512 * 1024; // <=2MB ‚Üí 512KB
      return 1024 * 1024; // default 1MB
    }

    function getCSRFToken() {
      if (csrfTokenInput && csrfTokenInput.value) return csrfTokenInput.value;
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.content) return meta.content;
      const m = document.cookie.match(/(?:^|;\s*)csrf[_-]?token=([^;]+)/i);
      return m ? decodeURIComponent(m[1]) : null;
    }

    fileInput.addEventListener('change', function () {
      fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'No file chosen';
      if (statusMessage.style.color === 'red') statusMessage.textContent = '';
    });

    uploadForm.addEventListener('submit', async function (event) {
      event.preventDefault();

      if (!fileInput.files || fileInput.files.length === 0) {
        setStatus('Please choose a file to upload.', 'var(--danger)');
        return;
      }

      const file = fileInput.files[0];
      const ext = getExt(file.name);
      const mime = (file.type || '').toLowerCase();

      // Block HEIC/HEIF early with a helpful nudge
      if (BLOCKED_EXTS.includes(ext) || mime.includes('heic') || mime.includes('heif')) {
        setStatus('‚ö†Ô∏è This device saved the image as HEIC/HEIF. Please convert to JPEG/PNG or change camera settings to "Most Compatible" and try again.', 'var(--danger)');
        resetUploadUI();
        return;
      }
      if (!ALLOWED_EXTS.includes(ext)) {
        setStatus(`‚ö†Ô∏è Invalid file type (.${ext || 'unknown'}). Allowed: ${ALLOWED_EXTS.join(', ')}`, 'var(--danger)');
        resetUploadUI();
        return;
      }

      const totalSize = file.size;
      const CHUNK_SIZE = chooseChunkSize(totalSize);
      const uploadUrl = this.action;
      const csrfToken = getCSRFToken();

      submitButton.disabled = true;
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      progressContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      setStatus(`Starting upload of ${file.name} (${humanSize(totalSize)})‚Ä¶`);

      let offset = 0;

      // XHR helper with true upload progress
      function xhrUploadChunk({ url, formData, onUploadProgress, headers = {}, withCredentials = true, timeout = CHUNK_TIMEOUT_MS }) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url, true);
          xhr.withCredentials = withCredentials;
          xhr.timeout = timeout;

          for (const [k, v] of Object.entries(headers)) {
            try {
              xhr.setRequestHeader(k, v);
            } catch (_) { }
          }

          xhr.upload.onprogress = function (e) {
            if (onUploadProgress) onUploadProgress(e);
          };

          xhr.onload = function () {
            const ct = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();

            // Session issues ‚Üí server may return HTML or 401/403
            if (xhr.status === 401 || xhr.status === 403) {
              resolve({ action: 'redirect_login' });
              return;
            }
            if (!ct.includes('application/json')) {
              resolve({ action: 'redirect_login' });
              return;
            }

            let data = null;
            try {
              data = JSON.parse(xhr.responseText || '{}');
            } catch (err) {
              reject(new Error('Invalid JSON from server.'));
              return;
            }
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(data);
            } else {
              reject(new Error((data && (data.error || data.message)) || 'Chunk upload failed.'));
            }
          };

          xhr.onerror = function () {
            reject(new Error('Network error.'));
          };
          xhr.ontimeout = function () {
            reject(new Error('Request timed out.'));
          };

          xhr.send(formData);
        });
      }

      async function postChunkWithRetry(formData, onUploadProgress) {
        const headers = {};
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
          headers['X-CSRF-Token'] = csrfToken;
        }

        for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
          try {
            return await xhrUploadChunk({
              url: uploadUrl,
              formData,
              onUploadProgress,
              headers,
              withCredentials: true,
              timeout: CHUNK_TIMEOUT_MS
            });
          } catch (err) {
            if (attempt < MAX_RETRIES) {
              const backoff = 600 * Math.pow(2, attempt);
              setStatus(`Network hiccup, retrying‚Ä¶ (${attempt + 1}/${MAX_RETRIES})`, 'var(--warning)');
              await new Promise(r => setTimeout(r, backoff));
              continue;
            }
            throw err;
          }
        }
      }

      try {
        while (offset < totalSize) {
          const end = Math.min(offset + CHUNK_SIZE, totalSize);
          const chunkBlob = new Blob([file.slice(offset, end)], { type: 'application/octet-stream' });

          const formData = new FormData();
          formData.append('file_chunk', chunkBlob, file.name);
          formData.append('filename', file.name);
          formData.append('offset', String(offset));
          formData.append('total_size', String(totalSize));

          const onUploadProgress = (e) => {
            // Smooth, byte-true global progress while the request is in flight
            const loadedInThisChunk = e && e.lengthComputable ? e.loaded : 0;
            let globalLoaded = offset + loadedInThisChunk;
            if (globalLoaded > totalSize) globalLoaded = totalSize;
            let percent = Math.floor((globalLoaded / totalSize) * 100);
            // Keep a little headroom; snap to 100% only when server confirms
            if (percent >= 100) percent = 99;
            progressBar.style.width = percent + '%';
            setStatus(`Uploading‚Ä¶ ${percent}% (${humanSize(globalLoaded)} / ${humanSize(totalSize)})`);
          };

          const result = await postChunkWithRetry(formData, onUploadProgress);

          if (!result) throw new Error('Unexpected empty response from server.');

          if (result.action === 'redirect_login') {
            alert('Your session has expired. Please log in again.');
            window.location.href = '/login';
            return;
          }
          if (result.action === 'already_submitted') {
            setStatus(`‚ö†Ô∏è ${result.error}`, 'var(--warning)');
            submitButton.disabled = true;
            setTimeout(() => window.location.reload(), 2000);
            return;
          }
          if (result.action === 'restart_upload') {
            setStatus(`‚ö†Ô∏è ${result.error || 'Please try uploading again.'}`, 'var(--danger)');
            resetUploadUI();
            return;
          }
          if (result.action === 'retry_chunk') {
            setStatus(`‚ö†Ô∏è ${result.message || 'Retrying chunk‚Ä¶'}`, 'var(--warning)');
            // do not advance offset; try this same chunk again
            continue;
          }
          if (result.action === 'invalid_file_type') {
            const allowedTypes = result.allowed_extensions ? result.allowed_extensions.join(', ') : ALLOWED_EXTS.join(', ');
            setStatus(`‚ö†Ô∏è Invalid file type. Allowed: ${allowedTypes}`, 'var(--danger)');
            resetUploadUI();
            return;
          }

          if (result.action === 'upload_complete') {
            // Final confirmation from server
            progressBar.style.width = '100%';
            setStatus('‚úÖ Upload complete! Finalizing‚Ä¶', 'var(--success)');
            setTimeout(() => window.location.reload(), 1200);
            return;
          }

          // Default/continue path
          offset = end;
          const pct = Math.min(99, Math.floor((offset / totalSize) * 100));
          progressBar.style.width = pct + '%';
          setStatus(`Uploading‚Ä¶ ${pct}% (${humanSize(offset)} / ${humanSize(totalSize)})`);
        }

      } catch (error) {
        setStatus(`‚ö†Ô∏è Upload failed: ${error.message}`, 'var(--danger)');
        resetUploadUI();
        return;
      }
    });
  });
</script>

{% endblock %}