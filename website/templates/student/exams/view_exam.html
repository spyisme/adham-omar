{% extends "student/dashboard.html" %}
{% block title %}Exam Details{% endblock %}
{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');


  /* Cards & badges */
  .card {
    transition: all .3s ease;
    transform: translateY(0);
  }

  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .1), 0 10px 10px -5px rgba(0, 0, 0, .04);
  }

  .badge {
    font-weight: 600;
    border-radius: 9999px;
    padding: .25rem .625rem;
    font-size: .75rem;
  }

  .badge-open {
    background: rgba(99, 102, 241, .12);
    color: #4f46e5;
    border: 1px solid rgba(99, 102, 241, .35);
  }

  .badge-completed {
    background: rgba(16, 185, 129, .12);
    color: #059669;
    border: 1px solid rgba(16, 185, 129, .35);
  }

  .badge-late {
    background: rgba(249, 115, 22, .12);
    color: #c2410c;
    border: 1px solid rgba(249, 115, 22, .35);
  }

  .badge-expired {
    background: rgba(239, 68, 68, .12);
    color: #b91c1c;
    border: 1px solid rgba(239, 68, 68, .35);
  }

  /* Layout */
  .container {
    max-width: 896px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .page-title {
    font-size: 2.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.75rem;
  }

  .page-subtitle {
    color: #6b7280;
  }

  .card {
    background: white;
    border-radius: 1rem;
    border: 1px solid #f3f4f6;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .05), 0 4px 6px -2px rgba(0, 0, 0, .05);
    overflow: hidden;
  }

  .card-header {
    padding: 1.5rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .card-body {
    padding: 1.5rem;
  }

  .card-header-flex {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    overflow: hidden;
    word-break: break-word;
  }

  .card-meta {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-mark {
    margin-top: 0.5rem;
    font-size: 0.875rem;
  }

  .card-mark-value {
    font-weight: 600;
    color: #4f46e5;
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.75rem;
  }

  .card-divider {
    border: 0;
    border-top: 1px solid #e5e7eb;
    margin: 2rem 0;
  }

  .submission-info {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .submission-info strong {
    color: #1f2937;
    font-weight: 500;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
    border: 1px solid transparent;
    transition: all 0.2s ease-in-out;
    cursor: pointer;
    text-decoration: none;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background-color: #4f46e5;
    color: white;
    border-color: #4f46e5;
  }

  .btn-primary:hover:not(:disabled) {
    background-color: white;
    color: #4338ca;
    border-color: #4f46e5;
  }

  .btn-secondary {
    background-color: white;
    color: #374151;
    border-color: #e5e7eb;
  }

  .btn-secondary:hover {
    border-color: #d1d5db;
    color: #111827;
  }

  .btn-danger {
    background-color: #dc2626;
    color: white;
    border-color: #dc2626;
  }

  .btn-danger:hover {
    background-color: white;
    color: #b91c1c;
    border-color: #fca5a5;
  }

  .file-upload-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .file-upload-label {
    background-color: white;
    color: #4338ca;
    border-color: #c7d2fe;
  }

  .file-upload-label:hover {
    border-color: #a5b4fc;
    color: #3730a3;
  }

  .file-name-display {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .progress-container {
    width: 100%;
    background-color: #e5e7eb;
    border-radius: 9999px;
    height: 0.625rem;
  }

  .progress-bar {
    background-color: #4f46e5;
    height: 0.625rem;
    border-radius: 9999px;
    width: 0%;
    transition: width 0.3s ease;
  }

  .status-message {
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .attachments-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .attachments-list li:not(:last-child) {
    margin-bottom: 0.5rem;
  }

  .attachments-list a {
    color: #4f46e5;
    text-decoration: underline;
    word-break: break-all;
  }

  .attachments-list a:hover {
    color: #3730a3;
  }

  .hidden {
    display: none;
  }

  .space-y-3>*+* {
    margin-top: 0.75rem;
  }

  .space-y-4>*+* {
    margin-top: 1rem;
  }

  .space-y-8>*+* {
    margin-top: 2rem;
  }

  .browser-warning {
    background-color: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    display: none;
    color: #92400e;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .browser-warning strong {
    font-weight: 600;
    color: #78350f;
  }

  @media (min-width: 640px) {
    .page-title {
      font-size: 3rem;
    }

    .card-header,
    .card-body {
      padding: 2rem;
    }
  }
</style>

<div>
  <div class="container">

    <div class="page-header">
      <h1 class="page-title">ğŸ“ Exam Details</h1>
      <p class="page-subtitle">Everything you need to submit successfully</p>
    </div>

    <div id="browser-warning" class="browser-warning">
      âš ï¸ <strong>Browser Compatibility Notice:</strong> Uploads may fail on your current browser. For the best
      experience and reliable uploads, please use the latest version of <strong>Google Chrome</strong>.
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-flex">
          <h2 class="card-title" title="{{ assignment.title }}">
            {{ assignment.title }}
          </h2>

          {% set is_completed = assignment.done %}
          {% set is_completed_late = assignment.done and assignment.past_deadline %}
          {% set is_expired = (not assignment.done) and assignment.past_deadline %}
          {% set status_label = 'Open' %}
          {% set status_class = 'badge-open' %}
          {% if is_completed %}
          {% set status_label = 'Completed' %}
          {% set status_class = 'badge-completed' %}
          {% elif is_completed_late %}
          {% set status_label = 'Completed Late' %}
          {% set status_class = 'badge-late' %}
          {% elif is_expired %}
          {% set status_label = 'Expired (You can still submit)' %}
          {% set status_class = 'badge-expired' %}
          {% endif %}

          <span class="badge {{ status_class }}">{{ status_label }}</span>
        </div>

        {% if assignment.deadline_date %}
        <div class="card-meta">
          <span aria-hidden="true">ğŸ—“ï¸</span>
          <span>Deadline: {{ assignment.deadline_date.strftime('%B %d, %Y at %I:%M %p') }}</span>
        </div>
        {% endif %}

        {% if assignment.submission and assignment.submission.mark is not none %}
        <div class="card-mark">
          Mark:
          <span class="card-mark-value">{{ assignment.submission.mark }}</span>
        </div>
        {% endif %}
      </div>

      <div class="card-body">

        {% if assignment.description %}
        <section>
          <h3 class="section-title">Description</h3>
          <p>{{ assignment.description }}</p>
        </section>
        {% endif %}

        <section>
          <h3 class="section-title">Attachments</h3>
          {% if attachments %}
          <ul class="attachments-list">
            {% for attachment in attachments %}
            {% if "http" in attachment %}
            <li>
              <a href="{{ attachment }}" target="_blank" rel="noopener">External Link</a>
            </li>
            {% else %}
            <li>
              <a href="{{ url_for('student.exam_media', filename=attachment) }}" target="_blank" rel="noopener">
                {{ attachment }}
              </a>
            </li>
            {% endif %}
            {% endfor %}
          </ul>
          {% else %}
          <p style="color: #6b7280;">No attachments provided.</p>
          {% endif %}
        </section>

        <hr class="card-divider">

        {% if submission %}
        <section class="space-y-3">
          <h3 class="section-title">Your Submission</h3>

          {% if submission.upload_time %}
          <div class="submission-info">
            Submitted on:
            <strong>
              {{ submission.upload_time.strftime('%B %d, %Y at %I:%M %p') }}
            </strong>
          </div>
          {% endif %}

          <div>
            <a href="{{ url_for('student.student_submission_media_exam', exam_id=assignment.id) }}" target="_blank"
              rel="noopener" class="btn btn-secondary">
              ğŸ“ View Submission
            </a>
          </div>

          {% if submission.mark is not none and submission.mark != "Not marked yet" %}
          <hr>
          <div class="exam-mark">
            <h3 class="section-title">Exam Mark</h3>
            <p style="color: #1f2937;">{{ submission.mark }}</p>
          </div>
          <div>
            <a href="{{ url_for('student.corrected_pdf', submission_id=submission.id) }}" target="_blank" rel="noopener"
              class="btn btn-secondary">
              ğŸ“ View Correction
            </a>
          </div>
          {% endif %}


          <form method="POST" action="{{ url_for('student.delete_submission_exam', exam_id=assignment.id) }}">
            <button type="submit"
              onclick="return confirmAction(event,'Are you sure you want to delete your submission?')"
              class="btn btn-danger">
              ğŸ—‘ï¸ Delete Submission
            </button>
          </form>
        </section>
        {% else %}
        <section>
          <h3 class="section-title">Submit Your Exam</h3>

          <form id="upload-form" action="{{ url_for('student.upload_exam_chunk', exam_id=assignment.id) }}"
            method="POST" enctype="multipart/form-data" class="space-y-4" novalidate>
            <input type="hidden" id="csrf-token" name="csrf_token"
              value="{{ csrf_token() if csrf_token is defined else '' }}">

            <div class="file-upload-wrapper">
              <input type="file" id="file" name="file" class="hidden" required
                accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,image/jpeg,image/png">
              <label for="file" class="btn file-upload-label">
                ğŸ“ Choose File
              </label>
              <span id="file-name" class="file-name-display">No file chosen</span>
            </div>

            <div id="progress-container" class="progress-container hidden">
              <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="status-message" class="status-message"></div>
            <button type="submit" class="btn btn-primary">
              âœ… Submit Exam
            </button>
          </form>
        </section>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<script>
  // Browser detection - show warning if not Chrome
  (function () {
    const ua = navigator.userAgent;
    const vendor = navigator.vendor || '';

    // Check for Chrome on desktop/Android (Chrome + Google Inc vendor)
    const isChromeDesktop = /Chrome/.test(ua) && /Google Inc/.test(vendor);

    // Check for Chrome on iOS (CriOS in user agent)
    const isChromeIOS = /CriOS/.test(ua);

    // Check for Chromium-based Edge
    const isEdgeChromium = /Edg/.test(ua) && /Chrome/.test(ua);

    const isChrome = isChromeDesktop || isChromeIOS || isEdgeChromium;

    if (!isChrome) {
      const warning = document.getElementById('browser-warning');
      if (warning) {
        warning.style.display = 'block';
      }
    }
  })();

  function confirmAction(event, message) {
    if (!confirm(message)) {
      event.preventDefault();
      return false;
    }
    return true;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const uploadForm = document.getElementById('upload-form');
    if (!uploadForm) return;

    const fileInput = document.getElementById('file');
    const fileNameSpan = document.getElementById('file-name');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const submitButton = uploadForm.querySelector('button[type="submit"]');
    const csrfTokenInput = document.getElementById('csrf-token');

    const MAX_RETRIES = 3;
    const CHUNK_TIMEOUT_MS = 30000; // 30s per chunk

    const ALLOWED_EXTS = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'jpg', 'jpeg', 'png'];
    const BLOCKED_EXTS = ['heic', 'heif'];

    function setStatus(msg, colorVar) {
      statusMessage.textContent = msg;
      statusMessage.style.color = colorVar || 'var(--text-secondary)';
    }
    function resetUploadUI() {
      submitButton.disabled = false;
      submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      progressContainer.classList.add('hidden');
      progressBar.style.width = '0%';
      fileInput.value = '';
      fileNameSpan.textContent = 'No file chosen';
    }
    function getExt(name) {
      const dot = name.lastIndexOf('.');
      return dot >= 0 ? name.slice(dot + 1).toLowerCase() : '';
    }
    function humanSize(bytes) {
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(n >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
    }
    function chooseChunkSize(totalBytes) {
      if (totalBytes <= 2 * 1024 * 1024) return 512 * 1024; // <=2MB â†’ 512KB
      return 1024 * 1024;                                   // default 1MB
    }
    function getCSRFToken() {
      if (csrfTokenInput && csrfTokenInput.value) return csrfTokenInput.value;
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.content) return meta.content;
      const m = document.cookie.match(/(?:^|;\s*)csrf[_-]?token=([^;]+)/i);
      return m ? decodeURIComponent(m[1]) : null;
    }

    fileInput.addEventListener('change', function () {
      fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'No file chosen';
      if (statusMessage.style.color === 'red') statusMessage.textContent = '';
    });

    uploadForm.addEventListener('submit', async function (event) {
      event.preventDefault();

      if (!fileInput.files || fileInput.files.length === 0) {
        setStatus('Please choose a file to upload.', 'var(--danger)');
        return;
      }

      const file = fileInput.files[0];
      const ext = getExt(file.name);
      const mime = (file.type || '').toLowerCase();

      // Block HEIC/HEIF early with a helpful nudge
      if (BLOCKED_EXTS.includes(ext) || mime.includes('heic') || mime.includes('heif')) {
        setStatus('âš ï¸ This device saved the image as HEIC/HEIF. Please convert to JPEG/PNG or change camera settings to "Most Compatible" and try again.', 'var(--danger)');
        resetUploadUI();
        return;
      }
      if (!ALLOWED_EXTS.includes(ext)) {
        setStatus(`âš ï¸ Invalid file type (.${ext || 'unknown'}). Allowed: ${ALLOWED_EXTS.join(', ')}`, 'var(--danger)');
        resetUploadUI();
        return;
      }

      const totalSize = file.size;
      const CHUNK_SIZE = chooseChunkSize(totalSize);
      const uploadUrl = this.action;
      const csrfToken = getCSRFToken();

      submitButton.disabled = true;
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      progressContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      setStatus(`Starting upload of ${file.name} (${humanSize(totalSize)})â€¦`);

      let offset = 0;

      // XHR helper with true upload progress
      function xhrUploadChunk({ url, formData, onUploadProgress, headers = {}, withCredentials = true, timeout = CHUNK_TIMEOUT_MS }) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url, true);
          xhr.withCredentials = withCredentials;
          xhr.timeout = timeout;

          for (const [k, v] of Object.entries(headers)) {
            try { xhr.setRequestHeader(k, v); } catch (_) { }
          }

          xhr.upload.onprogress = function (e) {
            if (onUploadProgress) onUploadProgress(e);
          };

          xhr.onload = function () {
            const ct = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();

            // Session issues â†’ server may return HTML or 401/403
            if (xhr.status === 401 || xhr.status === 403) {
              resolve({ action: 'redirect_login' });
              return;
            }
            if (!ct.includes('application/json')) {
              resolve({ action: 'redirect_login' });
              return;
            }

            let data = null;
            try {
              data = JSON.parse(xhr.responseText || '{}');
            } catch (err) {
              reject(new Error('Invalid JSON from server.'));
              return;
            }
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(data);
            } else {
              reject(new Error((data && (data.error || data.message)) || 'Chunk upload failed.'));
            }
          };

          xhr.onerror = function () { reject(new Error('Network error.')); };
          xhr.ontimeout = function () { reject(new Error('Request timed out.')); };

          xhr.send(formData);
        });
      }

      async function postChunkWithRetry(formData, onUploadProgress) {
        const headers = {};
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
          headers['X-CSRF-Token'] = csrfToken;
        }

        for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
          try {
            return await xhrUploadChunk({
              url: uploadUrl,
              formData,
              onUploadProgress,
              headers,
              withCredentials: true,
              timeout: CHUNK_TIMEOUT_MS
            });
          } catch (err) {
            if (attempt < MAX_RETRIES) {
              const backoff = 600 * Math.pow(2, attempt);
              setStatus(`Network hiccup, retryingâ€¦ (${attempt + 1}/${MAX_RETRIES})`, 'var(--warning)');
              await new Promise(r => setTimeout(r, backoff));
              continue;
            }
            throw err;
          }
        }
      }

      try {
        while (offset < totalSize) {
          const end = Math.min(offset + CHUNK_SIZE, totalSize);
          const chunkBlob = new Blob([file.slice(offset, end)], { type: 'application/octet-stream' });

          const formData = new FormData();
          formData.append('file_chunk', chunkBlob, file.name);
          formData.append('filename', file.name);
          formData.append('offset', String(offset));
          formData.append('total_size', String(totalSize));

          const onUploadProgress = (e) => {
            // Smooth, byte-true global progress while the request is in flight
            const loadedInThisChunk = e && e.lengthComputable ? e.loaded : 0;
            let globalLoaded = offset + loadedInThisChunk;
            if (globalLoaded > totalSize) globalLoaded = totalSize;
            let percent = Math.floor((globalLoaded / totalSize) * 100);
            // Keep a little headroom; snap to 100% only when server confirms
            if (percent >= 100) percent = 99;
            progressBar.style.width = percent + '%';
            setStatus(`Uploadingâ€¦ ${percent}% (${humanSize(globalLoaded)} / ${humanSize(totalSize)})`);
          };

          const result = await postChunkWithRetry(formData, onUploadProgress);

          if (!result) throw new Error('Unexpected empty response from server.');

          if (result.action === 'redirect_login') {
            alert('Your session has expired. Please log in again.');
            window.location.href = '/login';
            return;
          }
          if (result.action === 'already_submitted') {
            setStatus(`âš ï¸ ${result.error}`, 'var(--warning)');
            submitButton.disabled = true;
            setTimeout(() => window.location.reload(), 2000);
            return;
          }
          if (result.action === 'restart_upload') {
            setStatus(`âš ï¸ ${result.error || 'Please try uploading again.'}`, 'var(--danger)');
            resetUploadUI();
            return;
          }
          if (result.action === 'retry_chunk') {
            setStatus(`âš ï¸ ${result.message || 'Retrying chunkâ€¦'}`, 'var(--warning)');
            // do not advance offset; try this same chunk again
            continue;
          }
          if (result.action === 'invalid_file_type') {
            const allowedTypes = result.allowed_extensions ? result.allowed_extensions.join(', ') : ALLOWED_EXTS.join(', ');
            setStatus(`âš ï¸ Invalid file type. Allowed: ${allowedTypes}`, 'var(--danger)');
            resetUploadUI();
            return;
          }

          if (result.action === 'upload_complete') {
            // Final confirmation from server
            progressBar.style.width = '100%';
            setStatus('âœ… Upload complete! Finalizingâ€¦', 'var(--success)');
            setTimeout(() => window.location.reload(), 1200);
            return;
          }

          // Default/continue path
          offset = end;
          const pct = Math.min(99, Math.floor((offset / totalSize) * 100));
          progressBar.style.width = pct + '%';
          setStatus(`Uploadingâ€¦ ${pct}% (${humanSize(offset)} / ${humanSize(totalSize)})`);
        }

      } catch (error) {
        setStatus(`âš ï¸ Upload failed: ${error.message}`, 'var(--danger)');
        resetUploadUI();
        return;
      }
    });
  });
</script>

{% endblock %}