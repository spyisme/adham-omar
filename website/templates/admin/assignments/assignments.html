{% extends "admin/dashboard.html" %}
{% block title %}Manage Assignments{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* --- Page & Filter Layout --- */
    .container {
        padding-top: 1.5rem;
    }

    .filters-card {
        margin-bottom: 2rem;
    }

    .search-row-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    #searchInput {
        width: 100%;
        max-width: 800px;
        font-size: 1rem;
    }

    .filters-row-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
    }

    .filters-row-wrapper .filter-dropdown {
        min-width: 200px;
        flex-grow: 1;
    }

    .filter-dropdown.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .multi.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* --- Skeleton Loader --- */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.4rem;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .skeleton-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .skeleton-h3 {
        height: 1.5rem;
        width: 60%;
        margin-bottom: 1rem;
    }

    .skeleton-p {
        height: 1rem;
        width: 80%;
        margin-bottom: 0.5rem;
    }

    .skeleton-p.short {
        width: 40%;
    }

    .skeleton-footer {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .skeleton-badge {
        height: 1.5rem;
        width: 70px;
    }

    .skeleton-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1rem 0;
    }

    /* --- Multi-select dropdown styles for edit modal --- */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-size: 0.9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    #edit-ms-groups-container {
        position: relative;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }

    /* --- Settings Modal Styles --- */
    .settings-info {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .settings-info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .settings-info-item:last-child {
        border-bottom: none;
    }

    .settings-info-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .settings-info-value {
        color: #334155;
        font-size: 0.875rem;
        text-align: right;
    }

    .settings-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .settings-action-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
        text-align: left;
    }

    .settings-action-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        transform: translateX(4px);
    }

    .settings-action-btn.edit-action:hover {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .settings-action-btn.toggle-action:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #f59e0b;
    }

    .settings-action-btn.delete-action:hover {
        background: #fef2f2;
        border-color: #ef4444;
        color: #ef4444;
    }

    .settings-action-btn svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    /* --- Assignments Grid & Cards --- */
    .assignments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .assignment-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        cursor: pointer;
        overflow: hidden;
    }

    .assignment-card.hidden-assignment {
        opacity: 0.7;
        background-color: #fafafa;
    }

    .assignment-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .card-main-content {
        padding: 1.5rem;
        flex-grow: 1;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .assignment-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-primary, #333);
        margin: 0;
    }

    .assignment-due {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #666);
        margin-top: 0.25rem;
    }

    .card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .detail-item {
        color: var(--color-text-secondary, #666);
    }

    .detail-item strong {
        display: block;
        color: var(--color-text, #333);
        margin-bottom: 0.15rem;
    }

    .card-actions {
        position: relative;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-footer {
        border-top: 1px solid var(--color-border, #e0e0e0);
        background-color: #f9fafb;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-around;
        text-align: center;
    }

    .stat-item .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        display: block;
    }

    .stat-item .stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--color-text-secondary, #666);
    }

    .stat-value.green {
        color: var(--color-success, #28a745);
    }

    .stat-value.red {
        color: var(--color-danger, #dc3545);
    }

    /* --- No Assignments Message --- */
    .no-assignments-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        color: var(--color-text-secondary, #666);
    }

    /* --- Attachment System Styles --- */
    .attachment-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        position: relative;
    }

    .attachment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .attachment-item-number {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .attachment-remove-btn {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        color: #ef4444;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .attachment-remove-btn:hover {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .attachment-fields {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .attachment-name-input {
        width: 100%;
    }

    .attachment-type-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .attachment-type-btn {
        flex: 1;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .attachment-type-btn.active {
        background: #eef2ff;
        border-color: #4338ca;
        color: #4338ca;
    }

    .attachment-input-wrapper {
        position: relative;
    }

    .attachment-file-input,
    .attachment-link-input {
        width: 100%;
    }

    #add-attachment-btn {
        background: #fff;
        border: 2px dashed #cbd5e1;
        color: #64748b;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    #add-attachment-btn:hover {
        border-color: #94a3b8;
        background: #f8fafc;
        color: #475569;
    }

    .existing-attachment-item {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .existing-attachment-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .existing-attachment-name {
        font-weight: 600;
        color: #0c4a6e;
    }

    .existing-attachment-type {
        font-size: 0.75rem;
        color: #0284c7;
        text-transform: uppercase;
    }

    .existing-attachment-delete {
        color: #ef4444;
        text-decoration: none;
        font-weight: 500;
        padding: 0.25rem 0.75rem;
        border: 1px solid #ef4444;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .existing-attachment-delete:hover {
        background: #ef4444;
        color: #fff;
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .filters-row-wrapper .filter-dropdown {
            min-width: 150px;
        }
    }

    @media (max-width: 600px) {
        .filters-row-wrapper {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .assignments-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .card-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">

    <div class="page-header-content">
        <h1 class="page-title">{% if filter_group_id %}{{ group.name }} Assignments{% else %}All Assignments{% endif %}
        </h1>
        {% if current_user.role == "super_admin" %}
        <button id="openAddAssignmentDesktop" class="btn btn-primary">Create Assignment</button>
        {% endif %}
    </div>
</header>

<main class="container">
    <div class="card filters-card">
        <div class="card-content">
            <div class="search-row-wrapper">
                <input type="text" id="searchInput" class="form-input" placeholder="Search by assignment title..."
                    disabled>
            </div>
            {% if not filter_group_id %}
            <div class="filters-row-wrapper">
                <div class="filter-dropdown disabled" id="groupDropdown">
                    <button type="button" class="btn form-input filter-dropdown-btn" id="groupDropdownBtn">All Groups
                        ‚ñº</button>
                    <div class="filter-dropdown-list" id="groupDropdownList">
                        <label class="dropdown-all"><input type="checkbox" value="" checked>All Groups</label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="assignmentsGrid" class="assignments-grid">
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
    </div>
</main>

<div id="assignmentModal" class="modal-overlay">
    <div class="modal-content">
        <form method="POST" enctype="multipart/form-data">
            {% if filter_group_id %}
            <input type="hidden" name="locked_group_id" value="{{ filter_group_id }}">
            {% endif %}
            <div class="modal-header">
                <h2>Add New Assignment</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <label class="form-label">Title (Required)</label>
                    <input type="text" name="title" required placeholder="e.g., Chapter 5 Review Questions"
                        class="form-input">
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea name="description" rows="4" placeholder="Provide instructions, topics, or details here..."
                        class="form-textarea"></textarea>
                </div>
                <div>
                    <label class="form-label">
                        <input type="checkbox" name="student_whatsapp" value="true" checked>
                        Send WhatsApp notification to student
                    </label>
                </div>
                <div>
                    <label class="form-label">
                        <input type="checkbox" name="parent_whatsapp" value="true" checked>
                        Send WhatsApp notification to parent
                    </label>
                </div>

                <div>
                    <label class="form-label">
                        <input type="checkbox" name="close_after_deadline" value="true" checked>
                        Close after deadline (Disable submissions after deadline)
                    </label>
                </div>


                <div>
                    <label class="form-label">Out of (Full Mark)</label>
                    <input type="number" name="out_of" min="0"
                        placeholder="e.g., 100 (leave empty for ungraded assignment)" class="form-input">
                </div>

                <div>
                    <label class="form-label">Group</label>
                    {% if filter_group_id %}
                    <div class="form-input" style="background-color: #f0f0f0; cursor: not-allowed; opacity: 0.7;">
                        {{ group.name }}
                    </div>
                    <input type="hidden" name="groups[]" value="{{ filter_group_id }}">
                    {% else %}
                    <div class="multi" id="ms-groups">
                        <button type="button" class="btn form-input multi-btn" id="ms-groups-btn">All Groups
                            ‚ñº</button>
                        <div class="multi-list" id="ms-groups-list">
                            <label class="multi-all"><input type="checkbox" value="" checked>All Groups</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <label class="form-label">Deadline Date (Required)</label>
                    <input type="datetime-local" name="deadline_date" required class="form-input">
                </div>
                <div>
                    <label class="form-label">Attachments</label>
                    <div id="attachments-container">
                        <!-- Dynamic attachment fields will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" id="add-attachment-btn" style="margin-top: 0.5rem;">
                        + Add Attachment
                    </button>
                </div>
                <div>
                    <label class="form-label">Points (Optional)</label>
                    <input type="number" name="points" placeholder="0 (for the website leaderboard)" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Assignment</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Assignment Modal -->
<div id="editAssignmentModal" class="modal-overlay">
    <div class="modal-content">
        <form id="editAssignmentForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Edit Assignment</h2>
                <button type="button" class="modal-close" id="editModalClose">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="editModalFooter" style="display: none;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Assignment Settings</h2>
            <button type="button" class="modal-close" id="settingsModalClose">&times;</button>
        </div>
        <div class="modal-body" id="settingsModalBody">
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        </div>
    </div>
</div>

<!-- Repost Assignment Modal -->
<div id="repostAssignmentModal" class="modal-overlay">
    <div class="modal-content">
        <form id="repostAssignmentForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Repost Assignment</h2>
                <button type="button" class="modal-close" id="repostModalClose">&times;</button>
            </div>
            <div class="modal-body" id="repostModalBody">
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="repostModalFooter" style="display: none;">
                <button type="button" class="btn btn-secondary" id="repostModalCancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Repost Assignment</button>
            </div>
        </form>
    </div>
</div>

<script id="assignmentsScript" data-filter-group-id="{% if filter_group_id %}{{ filter_group_id }}{% endif %}">
    
    // Global state
    let allAssignments = [];
    let groups = [];
    let isLoading = true;
    let currentEditingAssignmentId = null;
    const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId ? parseInt(document.getElementById('assignmentsScript').dataset.filterGroupId) : null;

    // --- Modal Logic ---
    const modal = document.getElementById('assignmentModal');
    const editModal = document.getElementById('editAssignmentModal');
    const settingsModal = document.getElementById('settingsModal');
    const repostModal = document.getElementById('repostAssignmentModal');
    const openModalBtns = [document.getElementById('openAddAssignmentDesktop')];
    const closeModalBtn = document.querySelector('.modal-close');
    const editModalCloseBtn = document.getElementById('editModalClose');
    const settingsModalCloseBtn = document.getElementById('settingsModalClose');
    const repostModalCloseBtn = document.getElementById('repostModalClose');
    const repostModalCancelBtn = document.getElementById('repostModalCancelBtn');

    openModalBtns.forEach(btn => {
        if (btn) btn.onclick = () => {
            modal.classList.add('show');
            // Reset attachments when opening modal
            document.getElementById('attachments-container').innerHTML = '';
            attachmentCounter = 0;
        };
    });
    if (closeModalBtn) closeModalBtn.onclick = () => { modal.classList.remove('show'); };
    if (editModalCloseBtn) editModalCloseBtn.onclick = () => { editModal.classList.remove('show'); };
    if (settingsModalCloseBtn) settingsModalCloseBtn.onclick = () => { settingsModal.classList.remove('show'); };
    if (repostModalCloseBtn) repostModalCloseBtn.onclick = () => { repostModal.classList.remove('show'); };
    if (repostModalCancelBtn) repostModalCancelBtn.onclick = () => { repostModal.classList.remove('show'); };

    modal.onclick = e => {
        if (e.target === modal) modal.classList.remove('show');
    };
    editModal.onclick = e => {
        if (e.target === editModal) editModal.classList.remove('show');
    };
    settingsModal.onclick = e => {
        if (e.target === settingsModal) settingsModal.classList.remove('show');
    };
    repostModal.onclick = e => {
        if (e.target === repostModal) repostModal.classList.remove('show');
    };

    // --- Attachment Management System ---
    let attachmentCounter = 0;
    let editAttachmentCounter = 0;
    let repostAttachmentCounter = 0;

    function addAttachmentField(container, prefix = '', existingData = null) {
        let counter;
        if (prefix === 'edit-') {
            counter = ++editAttachmentCounter;
        } else if (prefix === 'repost-') {
            counter = ++repostAttachmentCounter;
        } else {
            counter = ++attachmentCounter;
        }
        
        const attachmentId = `${prefix}attachment-${counter}`;

        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.id = attachmentId;

        const defaultType = existingData ? existingData.type : 'file';
        const defaultName = existingData ? existingData.name : '';
        const defaultUrl = existingData && existingData.type === 'link' ? existingData.url : '';

        attachmentItem.innerHTML = `
            <div class="attachment-item-header">
                <span class="attachment-item-number">Attachment #${counter}</span>
                <button type="button" class="attachment-remove-btn" onclick="removeAttachment('${attachmentId}')">
                    Remove
                </button>
            </div>
            <div class="attachment-fields">
                <input type="text" 
                       name="${prefix}attachment_name_${counter}" 
                       placeholder="Enter attachment name (e.g., Chapter 5 Notes)" 
                       class="form-input attachment-name-input"
                       value="${defaultName}"
                       required>
                
                <div class="attachment-type-selector">
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'file' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'file')">
                        üìÅ File Upload
                    </button>
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'link' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'link')">
                        üîó External Link
                    </button>
                </div>
                
                <div class="attachment-input-wrapper">
                    <input type="file" 
                           name="${prefix}attachment_file_${counter}" 
                           class="form-input attachment-file-input"
                           style="display: ${defaultType === 'file' ? 'block' : 'none'};">
                    
                    <input type="url" 
                           name="${prefix}attachment_link_${counter}" 
                           placeholder="https://example.com/resource" 
                           class="form-input attachment-link-input"
                           value="${defaultUrl}"
                           style="display: ${defaultType === 'link' ? 'block' : 'none'};">
                </div>
                
                <input type="hidden" 
                       name="${prefix}attachment_type_${counter}" 
                       value="${defaultType}">
            </div>
        `;

        container.appendChild(attachmentItem);
    }

    // Make removeAttachment globally available
    window.removeAttachment = function (attachmentId) {
        const element = document.getElementById(attachmentId);
        if (element) {
            element.remove();
        }
    };

    // Make toggleAttachmentType globally available
    window.toggleAttachmentType = function (attachmentId, type) {
        const attachmentItem = document.getElementById(attachmentId);
        if (!attachmentItem) return;

        const fileBtn = attachmentItem.querySelector('.attachment-type-btn:first-child');
        const linkBtn = attachmentItem.querySelector('.attachment-type-btn:last-child');
        const fileInput = attachmentItem.querySelector('.attachment-file-input');
        const linkInput = attachmentItem.querySelector('.attachment-link-input');
        const typeInput = attachmentItem.querySelector('input[type="hidden"]');

        if (type === 'file') {
            fileBtn.classList.add('active');
            linkBtn.classList.remove('active');
            fileInput.style.display = 'block';
            linkInput.style.display = 'none';
            linkInput.value = ''; // Clear link input
        } else {
            fileBtn.classList.remove('active');
            linkBtn.classList.add('active');
            fileInput.style.display = 'none';
            linkInput.style.display = 'block';
            fileInput.value = ''; // Clear file input
        }

        typeInput.value = type;
    };

    // Add attachment button event listeners using event delegation
    document.addEventListener('click', function (e) {
        // Handle add attachment button for main modal
        if (e.target && e.target.id === 'add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('attachments-container');
            addAttachmentField(container);
        }

        // Handle add attachment button for edit modal
        if (e.target && e.target.id === 'edit-add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('edit-attachments-container');
            if (container) {
                addAttachmentField(container, 'edit-');
            }
        }
    });

    // --- Dropdown/Multiselect Logic ---
    function setupDropdown(dropdownId, btnId, listId, labelAll, updateCallback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');

        const getCheckboxes = () => Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            if (dropdown.classList.contains('disabled')) return;
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.filter-dropdown, .multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) {
                dropdown.classList.add('open');
            }
        };

        const updateHandler = function () {
            const checkboxes = getCheckboxes();
            if (this.value === "") {
                if (this.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
            } else {
                if (this.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
            }
            updateBtnLabel();
            if (updateCallback) updateCallback();
        };

        list.addEventListener('change', e => {
            if (e.target.type === 'checkbox') {
                updateHandler.call(e.target);
            }
        });

        function updateBtnLabel() {
            let selected = getCheckboxes().filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ‚ñº";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 15) + (selected[0].length > 15 ? '...' : '') + " ‚ñº";
            } else {
                btn.textContent = selected.length + " selected ‚ñº";
            }
        }
        updateBtnLabel();
    }

    // Close dropdowns on outside click
    document.addEventListener('click', function (e) {
        document.querySelectorAll('.filter-dropdown.open, .multi.open').forEach(d => {
            if (!d.contains(e.target)) {
                d.classList.remove('open');
            }
        });
    });

    // --- Toast utility ---
    function showToast(message, type = 'info', opts = {}) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.position = 'fixed';
            container.style.right = '1rem';
            container.style.bottom = '1rem';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '0.5rem';
            container.style.zIndex = '9999';
            container.style.pointerEvents = 'none';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.minWidth = '260px';
        toast.style.maxWidth = '92vw';
        toast.style.background = type === 'success' ? '#065f46' : type === 'error' ? '#7f1d1d' : '#1e3a8a';
        toast.style.color = '#f9fafb';
        toast.style.borderRadius = '8px';
        toast.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
        toast.style.padding = '0.75rem 1rem';
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.gap = '0.5rem';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(8px)';
        toast.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        toast.style.pointerEvents = 'auto';
        const msg = document.createElement('div');
        msg.textContent = message;
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úï';
        closeBtn.style.background = 'transparent';
        closeBtn.style.border = 'none';
        closeBtn.style.color = 'inherit';
        closeBtn.style.fontSize = '1.1rem';
        closeBtn.style.lineHeight = '1';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.padding = '0.25rem';
        closeBtn.style.borderRadius = '0.25rem';
        const removeToast = () => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 200); };
        closeBtn.onclick = removeToast;
        toast.appendChild(msg);
        toast.appendChild(closeBtn);
        container.appendChild(toast);
        void toast.offsetHeight;
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        const duration = typeof opts.duration === 'number' ? opts.duration : 3500;
        const timer = setTimeout(removeToast, duration);
        toast.addEventListener('mouseenter', () => clearTimeout(timer));
    }

    // --- GENERAL ACTION CONFIRMATION (Promise-based, no form submit) ---
    function confirmAction(event, message) {
        if (event && event.preventDefault) {
            event.preventDefault();
        }
        return Swal.fire({
            title: "Confirm Action",
            html: message,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "var(--button-bg, #3085d6)",
            cancelButtonColor: "var(--flash-danger-bg, #d33)",
            confirmButtonText: "Yes, proceed",
            cancelButtonText: "No, cancel",
            background: "var(--card-bg, #fff)",
            color: "var(--text-color, #333)",
        }).then((result) => {
            return result.isConfirmed;
        });
    }

    // --- API Calls ---
    async function fetchAssignments() {
        try {
            let url = '/admin/api/assignments-data';
            if (filterGroupId) {
                url += `?group_id=${filterGroupId}`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch assignments');
            const data = await response.json();
            return data || [];
        } catch (error) {
            console.error('Error fetching assignments:', error);
            return [];
        }
    }
    // --- Intercept form submit to POST without refresh ---
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('#assignmentModal form');
        if (!form) return;
        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Posting...'; }
            try {
                const formData = new FormData(form);

                // Process attachments
                const attachmentItems = document.querySelectorAll('#attachments-container .attachment-item');
                let attachmentCount = 0;
                attachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counter = itemId.replace('attachment-', '');

                    const nameInput = item.querySelector(`input[name="attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`attachments[${attachmentCount}][name]`, nameInput.value);
                        formData.append(`attachments[${attachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`attachments[${attachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`attachments[${attachmentCount}][url]`, linkInput.value);
                        }
                        attachmentCount++;
                    }
                });

                const resp = await fetch('/admin/assignments', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.success && data.assignment) {
                    allAssignments.unshift(data.assignment);
                    filterAssignments();
                    modal.classList.remove('show');
                    form.reset();
                    document.getElementById('attachments-container').innerHTML = '';
                    attachmentCounter = 0;
                    const msGroupsBtn = document.getElementById('ms-groups-btn');
                    if (msGroupsBtn) {
                        msGroupsBtn.textContent = 'All Groups ‚ñº';
                    }
                    showToast(data.message || 'Assignment created successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to create assignment', 'error');
                }
            } catch (err) {
                console.error('Create assignment failed', err);
                showToast('Failed to create assignment', 'error');
            } finally {
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Add Assignment'; }
            }
        });
    });


    async function fetchFilters() {
        try {
            const response = await fetch('/admin/api/filters');
            if (!response.ok) throw new Error('Failed to fetch filters');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching filters:', error);
            return { groups: [] };
        }
    }

    // --- SETTINGS MODAL FUNCTION ---
    async function openSettingsModal(assignmentId) {
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalBody = document.getElementById('settingsModalBody');

        settingsModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        `;
        settingsModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/assignment/${assignmentId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch assignment data', 'error');
                settingsModal.classList.remove('show');
                return;
            }

            const assignment = data.assignment;
            const createdAt = assignment.created_at ? assignment.created_at : 'N/A';
            const modifiedAt = assignment.last_edited_at ? assignment.last_edited_at : 'N/A';
            const createdBy = assignment.created_by || 'N/A';
            const modifiedBy = assignment.last_edited_by || 'N/A';
            const currentStatus = assignment.status === 'Show' ? 'Visible' : 'Hidden';
            const toggleAction = assignment.status === 'Show' ? 'Hide' : 'Show';

            settingsModalBody.innerHTML = `
                <div class="settings-info">
                    <div class="settings-info-item">
                        <span class="settings-info-label">Created By:</span>
                        <span class="settings-info-value">${escapeHtml(String(createdBy))}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Created At:</span>
                        <span class="settings-info-value">${createdAt}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Last Modified By:</span>
                        <span class="settings-info-value">${escapeHtml(String(modifiedBy))}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Last Modified At:</span>
                        <span class="settings-info-value">${modifiedAt}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Status:</span>
                        <span class="settings-info-value">${currentStatus}</span>
                    </div>
                </div>

                <div class="settings-actions">
                    <button class="settings-action-btn edit-action" data-action="edit" data-id="${assignment.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
                            <path d="m15 5 4 4"/>
                        </svg>
                        <span>Edit Assignment</span>
                    </button>

                    <button class="settings-action-btn edit-action" data-action="repost" data-id="${assignment.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                        </svg>
                        <span>Repost Assignment</span>
                    </button>

                    <button class="settings-action-btn toggle-action" data-action="toggle" data-id="${assignment.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            ${assignment.status === 'Show' ? `
                                <path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/>
                                <path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/>
                                <path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/>
                                <path d="m2 2 20 20"/>
                            ` : `
                                <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                                <circle cx="12" cy="12" r="3"/>
                            `}
                        </svg>
                        <span>${toggleAction} Assignment</span>
                    </button>

                    <button class="settings-action-btn delete-action" data-action="delete" data-id="${assignment.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            <path d="M3 6h18"/>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        <span>Delete Assignment</span>
                    </button>
                </div>
            `;

            settingsModalBody.querySelectorAll('.settings-action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const action = btn.getAttribute('data-action');
                    const id = btn.getAttribute('data-id');

                    console.log('Settings button clicked:', { action, id });

                    if (action === 'edit') {
                        settingsModal.classList.remove('show');
                        openEditModal(parseInt(id));
                    } else if (action === 'repost') {
                        settingsModal.classList.remove('show');
                        openRepostModal(parseInt(id));
                    } else if (action === 'delete') {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'You want to delete this assignment? This action cannot be undone.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (!result.isConfirmed) return;

                        settingsModal.classList.remove('show');

                        try {
                            // Check if we're on a group-filtered page
                            const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId;
                            let deleteUrl;

                            console.log('Filter group ID:', filterGroupId);

                            if (filterGroupId) {
                                deleteUrl = `/admin/group/${filterGroupId}/assignments/delete/${id}`;
                            } else {
                                deleteUrl = `/admin/assignments/delete/${id}`;
                            }

                            console.log('Delete URL:', deleteUrl);

                            const resp = await fetch(deleteUrl, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json'
                                }
                            });

                            console.log('Delete response:', resp.status, resp.statusText);

                            const data = await resp.json().catch(() => ({}));
                            console.log('Delete response data:', data);

                            if (resp.ok && data.success) {
                                allAssignments = allAssignments.filter(a => String(a.id) !== String(id));
                                filterAssignments();
                                showToast(data.message || 'Assignment deleted', 'success');
                            } else {
                                showToast((data && data.message) || 'Failed to delete assignment', 'error');
                            }
                        } catch (err) {
                            console.error('Delete failed', err);
                            showToast('Failed to delete assignment', 'error');
                        }
                    } else if (action === 'toggle') {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'You want to toggle the visibility of this assignment?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Yes, toggle it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (!result.isConfirmed) return;

                        settingsModal.classList.remove('show');

                        try {
                            // Check if we're on a group-filtered page
                            const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId;
                            let visibilityUrl;

                            if (filterGroupId) {
                                visibilityUrl = `/admin/group/${filterGroupId}/assignments/visibility/${id}`;
                            } else {
                                visibilityUrl = `/admin/assignments/visibility/${id}`;
                            }

                            const resp = await fetch(visibilityUrl, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json'
                                }
                            });
                            const data = await resp.json().catch(() => ({}));
                            if (resp.ok && data.success) {
                                const idx = allAssignments.findIndex(a => String(a.id) === String(id));
                                if (idx >= 0) { allAssignments[idx].status = data.status; }
                                filterAssignments();
                                showToast(data.message || 'Visibility updated', 'success');
                            } else {
                                showToast((data && data.message) || 'Failed to update visibility', 'error');
                            }
                        } catch (err) {
                            console.error('Toggle failed', err);
                            showToast('Failed to update visibility', 'error');
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Error fetching assignment:', error);
            showToast('Failed to fetch assignment data', 'error');
            settingsModal.classList.remove('show');
        }
    }

    // --- EDIT ASSIGNMENT FUNCTIONS ---
    async function openEditModal(assignmentId) {
        currentEditingAssignmentId = assignmentId;
        const editModal = document.getElementById('editAssignmentModal');
        const editModalBody = document.getElementById('editModalBody');
        const editModalFooter = document.getElementById('editModalFooter');

        editModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        `;
        editModalFooter.style.display = 'none';
        editModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/assignment/${assignmentId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch assignment data', 'error');
                editModal.classList.remove('show');
                return;
            }

            populateEditForm(data.assignment);
            editModalFooter.style.display = 'flex';
        } catch (error) {
            console.error('Error fetching assignment:', error);
            showToast('Failed to fetch assignment data', 'error');
            editModal.classList.remove('show');
        }
    }

    function populateEditForm(assignment) {
        const editModalBody = document.getElementById('editModalBody');

        const availableGroups = groups;

        // Reset edit attachment counter
        editAttachmentCounter = 0;

        editModalBody.innerHTML = `
            <div>
                <label class="form-label">Title</label>
                <input type="text" name="title" required value="${escapeHtml(assignment.title || '')}" class="form-input">
            </div>
            <div>
                <label class="form-label">Description</label>
                <textarea name="description" rows="4" class="form-textarea">${escapeHtml(assignment.description || '')}</textarea>
            </div>
            <div>
                <label class="form-label">
                    <input type="checkbox" name="student_whatsapp" value="true" ${assignment.student_whatsapp ? 'checked' : ''}>
                    Send WhatsApp notification to student
                </label>
            </div>
            <div>
                <label class="form-label">
                    <input type="checkbox" name="parent_whatsapp" value="true" ${assignment.parent_whatsapp ? 'checked' : ''}>
                    Send WhatsApp notification to parent
                </label>
            </div>
            <div>
                <label class="form-label">
                    <input type="checkbox" name="close_after_deadline" value="true" ${assignment.close_after_deadline ? 'checked' : ''}>
                    Close after deadline (Disable submissions after deadline)
                </label>
            </div>
            <div>
                <label class="form-label">Out of (Full Mark) (Make it 0 for ungraded assignment)</label>
                <input type="number" name="out_of" min="0" value="${assignment.out_of || ''}" class="form-input">
            </div>
            <div>
                <label class="form-label">Group</label>
                <div id="edit-ms-groups-container" style="position: relative;"></div>
                <div id="edit-group-ids-container"></div>
            </div>
            <div>
                <label class="form-label">Deadline Date</label>
                <input type="datetime-local" name="deadline_date" required value="${assignment.deadline_date || ''}" class="form-input">
            </div>
            <div>
                <label class="form-label">Current Attachments</label>
                <div id="edit-existing-attachments">
                    ${renderExistingAttachments(assignment.attachments || [], assignment.id)}
                </div>
            </div>
            <div>
                <label class="form-label">Add New Attachments</label>
                <div id="edit-attachments-container">
                    <!-- Dynamic attachment fields will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" id="edit-add-attachment-btn" style="margin-top: 0.5rem;">
                    + Add Attachment
                </button>
            </div>
        `;

        setupEditGroupMultiSelect(assignment.groups_mm || [], availableGroups);
    }

    function setupEditGroupMultiSelect(selectedGroups, availableGroups) {
        let editSelectedGroups = selectedGroups.map(g => ({ id: String(g.id), name: g.name }));

        const multiSelect = document.createElement('div');
        multiSelect.className = 'multi-select';
        multiSelect.id = 'edit-multiSelectGroups';
        multiSelect.onclick = () => toggleEditGroupDropdown();

        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'edit-multiInputGroups';
        input.placeholder = 'Type or select groups...';
        input.oninput = () => filterEditGroups();

        multiSelect.appendChild(input);

        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-list';
        dropdown.id = 'edit-dropdownListGroups';
        dropdown.style.display = 'none';

        availableGroups.forEach(group => {
            const div = document.createElement('div');
            div.dataset.id = String(group.id);
            div.textContent = group.name;
            dropdown.appendChild(div);
        });

        dropdown.onclick = (e) => {
            if (e.target.dataset.id) {
                const id = e.target.dataset.id;
                const name = e.target.textContent;
                if (!editSelectedGroups.find(g => g.id === id)) {
                    editSelectedGroups.push({ id, name });
                    renderEditGroupTags();
                }
                input.value = '';
                filterEditGroups();
                dropdown.style.display = 'none';
            }
        };

        const container = document.getElementById('edit-ms-groups-container');
        const existingMultiSelect = container.querySelector('.multi-select');
        const existingDropdown = container.querySelector('.dropdown-list');

        if (existingMultiSelect) existingMultiSelect.remove();
        if (existingDropdown) existingDropdown.remove();

        container.appendChild(multiSelect);
        container.appendChild(dropdown);

        function renderEditGroupTags() {
            while (multiSelect.firstChild && multiSelect.firstChild !== input) {
                multiSelect.removeChild(multiSelect.firstChild);
            }
            editSelectedGroups.forEach(g => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '√ó';
                btn.onclick = () => {
                    editSelectedGroups = editSelectedGroups.filter(group => group.id !== g.id);
                    renderEditGroupTags();
                };
                tag.textContent = g.name + ' ';
                tag.appendChild(btn);
                multiSelect.insertBefore(tag, input);
            });

            // Update hidden inputs for form submission
            const hiddenContainer = document.getElementById('edit-group-ids-container');
            hiddenContainer.innerHTML = '';
            editSelectedGroups.forEach(g => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'groups[]';
                hiddenInput.value = g.id;
                hiddenContainer.appendChild(hiddenInput);
            });
        }

        window.toggleEditGroupDropdown = () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (dropdown.style.display === 'block') input.focus();
        };

        window.filterEditGroups = () => {
            const filter = input.value.toLowerCase();
            Array.from(dropdown.children).forEach(option => {
                const isSelected = editSelectedGroups.some(g => g.id === option.dataset.id);
                if (isSelected) {
                    option.style.display = 'none';
                } else {
                    option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
                }
            });
            dropdown.style.display = 'block';
        };

        renderEditGroupTags();

        document.addEventListener('click', (e) => {
            const container = document.getElementById('edit-ms-groups-container');
            if (container && !container.contains(e.target) && dropdown) {
                dropdown.style.display = 'none';
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Move handleDeleteAttachmentGroup to global scope so it's always defined
    window.handleDeleteAttachmentGroup = function(btn, assignmentId, attachmentIdx) {
        // Show SweetAlert
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete the attachment.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e3342f',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Get filter group ID if any
                    const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId;
                    let deleteUrl;
                    if (filterGroupId) {
                        deleteUrl = `/admin/group/${filterGroupId}/assignments/delete-attachment/${assignmentId}/${attachmentIdx}`;
                    } else {
                        deleteUrl = `/admin/assignments/delete-attachment/${assignmentId}/${attachmentIdx}`;
                    }

                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(resp => resp.json().catch(() => ({})))
                    .then(data => {
                        if (data && data.success) {
                            // Remove the attachment from the DOM
                            const attachmentItem = btn.closest('.existing-attachment-item');
                            if (attachmentItem) attachmentItem.remove();

                            // If no more attachments, show placeholder
                            const remaining = document.querySelectorAll('#edit-existing-attachments .existing-attachment-item');
                            if (remaining.length === 0) {
                                document.getElementById('edit-existing-attachments').innerHTML = '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
                            }

                            Swal.fire(
                                'Deleted!',
                                data.message || 'Attachment deleted successfully.',
                                'success'
                            );
                        } else {
                            Swal.fire(
                                'Error',
                                (data && data.message) || 'Failed to delete attachment.',
                                'error'
                            );
                        }
                    })
                    .catch(err => {
                        Swal.fire(
                            'Error',
                            'Failed to delete attachment.',
                            'error'
                        );
                    });
                }
            });
        } else {
            // Fallback if no SweetAlert
            if (confirm('Are you sure you want to delete this attachment?')) {
                // Get filter group ID if any
                const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId;
                let deleteUrl;
                if (filterGroupId) {
                    deleteUrl = `/admin/group/${filterGroupId}/assignments/delete-attachment/${assignmentId}/${attachmentIdx}`;
                } else {
                    deleteUrl = `/admin/assignments/delete-attachment/${assignmentId}/${attachmentIdx}`;
                }

                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                .then(resp => resp.json().catch(() => ({})))
                .then(data => {
                    if (data && data.success) {
                        // Remove the attachment from the DOM
                        const attachmentItem = btn.closest('.existing-attachment-item');
                        if (attachmentItem) attachmentItem.remove();

                        // If no more attachments, show placeholder
                        const remaining = document.querySelectorAll('#edit-existing-attachments .existing-attachment-item');
                        if (remaining.length === 0) {
                            document.getElementById('edit-existing-attachments').innerHTML = '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
                        }

                        alert(data.message || 'Attachment deleted successfully.');
                    } else {
                        alert((data && data.message) || 'Failed to delete attachment.');
                    }
                })
                .catch(err => {
                    alert('Failed to delete attachment.');
                });
            }
        }
    };

    function renderExistingAttachments(attachments, assignmentId) {
        if (!attachments || attachments.length === 0) {
            return '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
        }

        // Handle both old format (array of strings) and new format (array of objects)
        return attachments.map(function(attachment, index) {
            var name, type, url;

            if (typeof attachment === 'string') {
                // Old format - backward compatibility
                name = attachment;
                type = attachment.startsWith('http') ? 'link' : 'file';
                url = type === 'link' ? attachment : '/student/assignments/uploads/' + attachment;
            } else {
                // New format
                name = attachment.name || 'Unnamed Attachment';
                type = attachment.type || 'file';
                url = attachment.url || '#';
            }

            // Use single quotes inside HTML string, double quotes for attributes
            // SweetAlert confirmation + group delete link logic for attachment deletion
            return (
                '<div class="existing-attachment-item" data-index="' + index + '">' +
                    '<div class="existing-attachment-info">' +
                        '<span class="existing-attachment-name">' + escapeHtml(name) + '</span>' +
                        '<span class="existing-attachment-type">' + type + '</span>' +
                        '<span class="existing-attachment-link">' +
                            '<a href="' + escapeHtml(url) + '" target="_blank" rel="noopener noreferrer">View</a>' +
                        '</span>' +
                    '</div>' +
                    '<div class="existing-attachment-actions">' +
                        '<button ' +
                            'type="button" ' +
                            'class="btn btn-danger btn-sm" ' +
                            'style="cursor:pointer; display:inline-block;" ' +
                            'onclick="handleDeleteAttachmentGroup(this, ' + assignmentId + ', ' + index + ')">' +
                            'Delete' +
                        '</button>' +
                    '</div>' +
                '</div>'
            );
        }).join('');
    }

    // Make deleteExistingAttachment globally available
    window.deleteExistingAttachment = async function (event, assignmentId, attachmentIndex) {
        const confirmed = await confirmAction(event, 'Are you sure you want to delete this attachment?');
        if (!confirmed) return;

        try {
            // Check if we're on a group-filtered page
            const filterGroupId = document.getElementById('assignmentsScript').dataset.filterGroupId;
            let deleteUrl;

            if (filterGroupId) {
                deleteUrl = `/admin/group/${filterGroupId}/assignments/delete-attachment/${assignmentId}/${attachmentIndex}`;
            } else {
                deleteUrl = `/admin/assignments/delete-attachment/${assignmentId}/${attachmentIndex}`;
            }

            const resp = await fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            });

            const data = await resp.json().catch(() => ({}));

            if (resp.ok && data.success) {
                // Remove the attachment from the DOM
                const attachmentItem = document.querySelector(`#edit-existing-attachments .existing-attachment-item[data-index="${attachmentIndex}"]`);
                if (attachmentItem) {
                    attachmentItem.remove();
                }

                // Check if there are no more attachments
                const remainingAttachments = document.querySelectorAll('#edit-existing-attachments .existing-attachment-item');
                if (remainingAttachments.length === 0) {
                    document.getElementById('edit-existing-attachments').innerHTML = '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
                }

                showToast(data.message || 'Attachment deleted successfully', 'success');
            } else {
                showToast((data && data.message) || 'Failed to delete attachment', 'error');
            }
        } catch (err) {
            console.error('Delete attachment failed', err);
            showToast('Failed to delete attachment', 'error');
        }
    };

    // Handle edit form submission
    document.addEventListener('DOMContentLoaded', function () {
        const editForm = document.getElementById('editAssignmentForm');
        if (!editForm) return;

        editForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentEditingAssignmentId) return;

            const submitBtn = editForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            }

            try {
                const formData = new FormData(editForm);

                // Process new attachments for edit form
                const editAttachmentItems = document.querySelectorAll('#edit-attachments-container .attachment-item');
                let editAttachmentCount = 0;
                editAttachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counter = itemId.replace('edit-attachment-', '');

                    const nameInput = item.querySelector(`input[name="edit-attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="edit-attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="edit-attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="edit-attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`new_attachments[${editAttachmentCount}][name]`, nameInput.value);
                        formData.append(`new_attachments[${editAttachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`new_attachments[${editAttachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`new_attachments[${editAttachmentCount}][url]`, linkInput.value);
                        }
                        editAttachmentCount++;
                    }
                });

                const resp = await fetch(`/admin/assignments/edit/${currentEditingAssignmentId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.success && data.assignment) {
                    const idx = allAssignments.findIndex(a => a.id === currentEditingAssignmentId);
                    if (idx >= 0) {
                        allAssignments[idx] = data.assignment;
                    }
                    filterAssignments();
                    editModal.classList.remove('show');
                    editForm.reset();
                    document.getElementById('edit-attachments-container').innerHTML = '';
                    editAttachmentCounter = 0;
                    currentEditingAssignmentId = null;
                    showToast(data.message || 'Assignment updated successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to update assignment', 'error');
                }
            } catch (err) {
                console.error('Update assignment failed', err);
                showToast('Failed to update assignment', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || 'Save Changes';
                }
            }
        });
    });

    // --- REPOST ASSIGNMENT FUNCTIONS ---
    async function openRepostModal(assignmentId) {
        const repostModal = document.getElementById('repostAssignmentModal');
        const repostModalBody = document.getElementById('repostModalBody');
        const repostModalFooter = document.getElementById('repostModalFooter');

        repostModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        `;
        repostModalFooter.style.display = 'none';
        repostModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/assignment/${assignmentId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch assignment data', 'error');
                repostModal.classList.remove('show');
                return;
            }

            populateRepostForm(data.assignment, assignmentId);
            repostModalFooter.style.display = 'flex';
        } catch (error) {
            console.error('Error fetching assignment:', error);
            showToast('Failed to fetch assignment data', 'error');
            repostModal.classList.remove('show');
        }
    }

    function populateRepostForm(assignment, originalAssignmentId) {
        const repostModalBody = document.getElementById('repostModalBody');
        const availableGroups = groups;

        // Reset repost attachment counter
        let repostAttachmentCounter = 0;

        // Parse existing attachments
        const existingAttachments = assignment.attachments || [];

        repostModalBody.innerHTML = `
            <input type="hidden" name="original_assignment_id" value="${originalAssignmentId}">
            
            <div class="form-group">
                <label for="repost-title">Title <span style="color: #dc3545;">*</span></label>
                <input type="text" id="repost-title" name="title" class="form-control" value="${escapeHtml(assignment.title || '')}" required>
            </div>

            <div class="form-group">
                <label for="repost-description">Description</label>
                <textarea id="repost-description" name="description" class="form-control" rows="4">${escapeHtml(assignment.description || '')}</textarea>
            </div>

            <div class="form-group">
                <label for="repost-deadline">Deadline</label>
                <input type="datetime-local" id="repost-deadline" name="deadline_date" class="form-control" value="${assignment.deadline_date ? assignment.deadline_date.replace(' ', 'T').substring(0, 16) : ''}">
            </div>

            <div class="form-group">
                <label for="repost-out-of">Out Of (Full Mark)</label>
                <input type="number" id="repost-out-of" name="out_of" class="form-control" value="${assignment.out_of || 0}" min="0">
            </div>

            <div class="form-group">
                <label>Groups <span style="color: #dc3545;">*</span></label>
                <div id="repost-ms-groups-container"></div>
            </div>

            <div class="form-group">
                <label>Existing Attachments</label>
                <div id="repost-existing-attachments">
                    ${renderExistingAttachments(existingAttachments, originalAssignmentId)}
                </div>
            </div>

            <div class="form-group">
                <label>Add New Attachments</label>
                <div id="repost-attachments-container"></div>
                <button type="button" class="btn" id="repost-add-attachment-btn">
                    + Add Attachment
                </button>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="student_whatsapp" value="true" ${assignment.student_whatsapp ? 'checked' : ''}>
                    Send WhatsApp to Students
                </label>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="parent_whatsapp" value="true" ${assignment.parent_whatsapp ? 'checked' : ''}>
                    Send WhatsApp to Parents
                </label>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="close_after_deadline" value="true" ${assignment.close_after_deadline ? 'checked' : ''}>
                    Close After Deadline
                </label>
            </div>
        `;

        setupRepostGroupMultiSelect(assignment.groups_mm || [], availableGroups);

        // Add event listener for add attachment button
        document.getElementById('repost-add-attachment-btn').addEventListener('click', function(e) {
            e.preventDefault();
            const container = document.getElementById('repost-attachments-container');
            addAttachmentField(container, 'repost-');
        });
    }

    function setupRepostGroupMultiSelect(selectedGroups, availableGroups) {
        let repostSelectedGroups = selectedGroups.map(g => ({ id: String(g.id), name: g.name }));

        const multiSelect = document.createElement('div');
        multiSelect.className = 'multi-select';
        multiSelect.id = 'repost-multiSelectGroups';
        multiSelect.onclick = () => toggleRepostGroupDropdown();

        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'repost-multiInputGroups';
        input.placeholder = 'Type or select groups...';
        input.oninput = () => filterRepostGroups();

        multiSelect.appendChild(input);

        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-list';
        dropdown.id = 'repost-dropdownListGroups';
        dropdown.style.display = 'none';

        availableGroups.forEach(group => {
            const div = document.createElement('div');
            div.textContent = group.name;
            div.dataset.id = group.id;
            dropdown.appendChild(div);
        });

        dropdown.onclick = (e) => {
            if (e.target.dataset.id) {
                const groupId = e.target.dataset.id;
                const groupName = e.target.textContent;
                const exists = repostSelectedGroups.some(g => g.id === groupId);
                if (!exists) {
                    repostSelectedGroups.push({ id: groupId, name: groupName });
                    renderRepostGroupTags();
                }
                document.getElementById('repost-multiInputGroups').value = '';
                filterRepostGroups();
            }
        };

        const container = document.getElementById('repost-ms-groups-container');
        const existingMultiSelect = container.querySelector('.multi-select');
        const existingDropdown = container.querySelector('.dropdown-list');

        if (existingMultiSelect) existingMultiSelect.remove();
        if (existingDropdown) existingDropdown.remove();

        container.appendChild(multiSelect);
        container.appendChild(dropdown);

        function renderRepostGroupTags() {
            const tagContainer = document.getElementById('repost-multiSelectGroups');
            const input = document.getElementById('repost-multiInputGroups');
            const form = document.getElementById('repostAssignmentForm');

            // Remove existing tags (but keep the input)
            Array.from(tagContainer.children).forEach(child => {
                if (child !== input) child.remove();
            });

            // Remove existing hidden inputs from the form
            const existingHiddenInputs = form.querySelectorAll('input[type="hidden"][name="groups[]"]');
            existingHiddenInputs.forEach(inp => inp.remove());

            // Add new tags inside the multi-select
            repostSelectedGroups.forEach(group => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${escapeHtml(group.name)}
                    <button type="button" onclick="removeRepostGroup('${group.id}')">&times;</button>
                `;
                tagContainer.insertBefore(tag, input);
            });

            // Add hidden inputs directly to the form (not visible in DOM structure)
            repostSelectedGroups.forEach(group => {
                const inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'groups[]';
                inp.value = group.id;
                form.appendChild(inp);
            });
        }

        window.toggleRepostGroupDropdown = () => {
            const dropdown = document.getElementById('repost-dropdownListGroups');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        };

        window.filterRepostGroups = () => {
            const searchValue = document.getElementById('repost-multiInputGroups').value.toLowerCase();
            const dropdown = document.getElementById('repost-dropdownListGroups');
            Array.from(dropdown.children).forEach(div => {
                const text = div.textContent.toLowerCase();
                div.style.display = text.includes(searchValue) ? 'block' : 'none';
            });
        };

        window.removeRepostGroup = (groupId) => {
            repostSelectedGroups = repostSelectedGroups.filter(g => g.id !== groupId);
            renderRepostGroupTags();
        };

        renderRepostGroupTags();

        document.addEventListener('click', (e) => {
            const container = document.getElementById('repost-ms-groups-container');
            if (container && !container.contains(e.target)) {
                const dropdown = document.getElementById('repost-dropdownListGroups');
                if (dropdown) dropdown.style.display = 'none';
            }
        });
    }

    // Handle repost form submission
    document.addEventListener('DOMContentLoaded', function () {
        const repostForm = document.getElementById('repostAssignmentForm');
        if (!repostForm) return;

        repostForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = repostForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Reposting...';
            }

            try {
                const formData = new FormData(repostForm);

                // Process new attachments for repost form
                const repostAttachmentItems = document.querySelectorAll('#repost-attachments-container .attachment-item');
                let repostAttachmentCount = 0;
                repostAttachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counter = itemId.replace('repost-attachment-', '');

                    const nameInput = item.querySelector(`input[name="repost-attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="repost-attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="repost-attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="repost-attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`new_attachments[${repostAttachmentCount}][name]`, nameInput.value);
                        formData.append(`new_attachments[${repostAttachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`new_attachments[${repostAttachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`new_attachments[${repostAttachmentCount}][url]`, linkInput.value);
                        }
                        repostAttachmentCount++;
                    }
                });

                const resp = await fetch('/admin/assignments/repost', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.success && data.assignment) {
                    // Add the new assignment to the list
                    allAssignments.unshift(data.assignment);
                    filterAssignments();
                    repostModal.classList.remove('show');
                    repostForm.reset();
                    document.getElementById('repost-attachments-container').innerHTML = '';
                    showToast(data.message || 'Assignment reposted successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to repost assignment', 'error');
                }
            } catch (err) {
                console.error('Repost assignment failed', err);
                showToast('Failed to repost assignment', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || 'Repost Assignment';
                }
            }
        });
    });

    // --- RENDER FUNCTION ---
    function renderAssignments(assignments) {
        const grid = document.getElementById('assignmentsGrid');
        if (!assignments || !assignments.length) {
            grid.innerHTML = `<div class="no-assignments-message"><h3>No assignments found.</h3><p>Try adjusting your filters or create a new assignment to get started.</p></div>`;
            return;
        }

        grid.innerHTML = assignments.map(a => {
            const groupStr = (a.groups && a.groups.length) ? a.groups.join(', ') : 'All Groups';
            const due = a.deadline_date ? a.deadline_date : 'Not set';
            const hiddenClass = a.status !== 'Show' ? 'hidden-assignment' : '';
            const viewHref = filterGroupId ? `/admin/assignments/${a.id}/submissions?group_id=${filterGroupId}` : `/admin/assignments/${a.id}/submissions`;
            const editHref = filterGroupId ? `/admin/assignments/edit/${a.id}?group_id=${filterGroupId}` : `/admin/assignments/edit/${a.id}`;
            const missing = (a.qualified_students_count || 0) - (a.submitted_students_count || 0);

            return `
            <div class="assignment-card ${hiddenClass}" 
                 data-href="${viewHref}"
                 data-group="${a.groups ? a.groups.join(',') : ''}" 
                 data-title="${(a.title || '').toLowerCase()}">
                
                <div class="card-main-content">
                    <div class="card-header">
                        <div>
                            <h3 class="assignment-title">${a.title}</h3>
                            <p class="assignment-due">Due: ${due}</p>
                            <p class="assignment-out_of">Out of: ${a.out_of || 'N/A'}</p>
                            <p class="assignment-points">Points: ${a.points || 'N/A'}</p>
                            <p class="assignment-close_after_deadline">Close after deadline: <span style="color: ${a.close_after_deadline ? 'green' : 'red'}; font-weight: bold;">${a.close_after_deadline ? 'Yes' : 'No'}</span></p>
                            <p class="assignment-student_whatsapp">Messages are sent to students via WhatsApp: <span style="color: ${a.student_whatsapp ? 'green' : 'red'}; font-weight: bold;">${a.student_whatsapp ? 'Yes' : 'No'}</span></p>
                            <p class="assignment-parent_whatsapp">Messages are sent to parents via WhatsApp: <span style="color: ${a.parent_whatsapp ? 'green' : 'red'}; font-weight: bold;">${a.parent_whatsapp ? 'Yes' : 'No'}</span></p>
                        </div>
                        <div class="card-actions">
                            <div class="action-buttons">
                                ${a.status !== 'Show' ? '<span class="badge badge-orange">HIDDEN</span>' : ''}
                        {% if current_user.role == "super_admin" %}

                                <button data-settings-id="${a.id}" class="btn-action js-settings" title="Settings">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                        {% endif %}

                            </div>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="detail-item"><strong>Group(s)</strong> ${groupStr}</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="stat-item">
                        <span class="stat-value green">${a.submitted_students_count || 0}</span>
                        <span class="stat-label">Submitted</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value red">${missing < 0 ? 0 : missing}</span>
                        <span class="stat-label">Missing</span>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // --- FILTERING LOGIC ---
    function getCheckedValues(listId) {
        const list = document.getElementById(listId);
        if (!list) return [];
        const allCheckbox = list.querySelector('input[type="checkbox"][value=""]');
        if (!allCheckbox || allCheckbox.checked) return [];
        return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value).filter(Boolean);
    }

    function filterAssignments() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sGroups = getCheckedValues('groupDropdownList');

        const filteredAssignments = allAssignments.filter(assignment => {
            const title = (assignment.title || '').toLowerCase();
            const groups = assignment.groups || [];

            const searchMatch = title.includes(search);
            const groupMatch = sGroups.length === 0 || (groups.length > 0 && sGroups.some(val => groups.includes(val)));

            const groupCatchAll = sGroups.length === 0 && groups.length === 0;

            return searchMatch && (groupMatch || groupCatchAll);
        });

        renderAssignments(filteredAssignments);
    }

    function enableFilters() {
        document.getElementById('searchInput').disabled = false;
        const groupDropdown = document.getElementById('groupDropdown');
        if (groupDropdown) {
            groupDropdown.classList.remove('disabled');
        }
        isLoading = false;
    }

    function populateFilterDropdowns() {
        const groupList = document.getElementById('groupDropdownList');
        if (groupList) {
            groupList.querySelectorAll('label:not(.dropdown-all)').forEach(l => l.remove());
            groups.forEach(group => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${group.name}"> ${group.name}`;
                groupList.appendChild(label);
            });
        }
    }

    function populateModalDropdowns() {
        const groupList = document.getElementById('ms-groups-list');
        if (groupList) {
            groupList.querySelectorAll('label:not(.multi-all)').forEach(l => l.remove());
            groups.forEach(group => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="groups[]" value="${group.id}"> ${group.name}`;
                groupList.appendChild(label);
            });
        }
    }

    async function initializePage() {
        try {
            const [assignmentsData, filtersData] = await Promise.all([
                fetchAssignments(),
                fetchFilters()
            ]);

            allAssignments = assignmentsData;
            groups = filtersData.groups || [];

            populateFilterDropdowns();
            populateModalDropdowns();

            // Only setup group dropdown if it exists (not present when filtering by specific group)
            if (document.getElementById('groupDropdown')) {
                setupDropdown('groupDropdown', 'groupDropdownBtn', 'groupDropdownList', 'All Groups', filterAssignments);
            }
            // Only setup group multi-select if it exists (not present when filtering by specific group)
            if (document.getElementById('ms-groups')) {
                setupDropdown('ms-groups', 'ms-groups-btn', 'ms-groups-list', 'All Groups');
            }

            renderAssignments(allAssignments);
            enableFilters();

            document.getElementById('searchInput').addEventListener('input', filterAssignments);

            const gridEl = document.getElementById('assignmentsGrid');
            gridEl.addEventListener('click', async function (e) {
                const card = e.target.closest('.assignment-card');

                const settingsBtn = e.target.closest('.js-settings');
                if (settingsBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = settingsBtn.getAttribute('data-settings-id');
                    openSettingsModal(parseInt(id));
                    return;
                }

                if (card && card.dataset.href) {
                    window.location.href = card.dataset.href;
                }
            });

        } catch (error) {
            console.error('Error initializing assignments page:', error);
            const grid = document.getElementById('assignmentsGrid');
            grid.innerHTML = `<div class="no-assignments-message"><h3>Error loading assignments.</h3><p>Please refresh the page to try again.</p></div>`;
            enableFilters();
        }
    }
    document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>

{% endblock %}