{% extends "admin/dashboard.html" %}
{% block title %}Submissions for {{ assignment.title }}{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    .assistant-assignment-panel {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .assistant-assignment-panel h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 1rem;
    }

    .assistants-grid {
        display: grid;
        gap: 1rem;
    }

    .assistant-card {
        background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 1.25rem;
        border: 2px solid #e2e8f0;
        transition: all 0.3s;
    }

    .assistant-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .assistant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .assistant-info h4 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.25rem;
    }

    .assistant-info p {
        font-size: 0.875rem;
        color: #718096;
    }

    .assistant-stats {
        text-align: right;
    }

    .assistant-stats .assigned-count {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .assignment-form {
        display: grid;
        grid-template-columns: 1fr 1fr auto auto;
        gap: 0.75rem;
        align-items: end;
    }

    .assignment-form .form-group {
        margin-bottom: 0;
    }

    .assignment-form label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.375rem;
    }

    .assignment-form input[type="number"] {
        width: 100%;
        padding: 0.625rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .assignment-form input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-assign {
        padding: 0.625rem 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        font-size: 0.875rem;
    }

    .btn-assign:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-unassign {
        padding: 0.625rem 1.25rem;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
        font-size: 0.875rem;
    }

    .btn-unassign:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(245, 87, 108, 0.4);
    }

    .stats-grid-new {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card-new {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid transparent;
        transition: all 0.3s;
    }

    .stat-card-new:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .stat-card-new.unassigned {
        border-left-color: #cbd5e0;
    }

    .stat-card-new.approved {
        border-left-color: #38ef7d;
    }

    .stat-card-new.waiting {
        border-left-color: #f5576c;
    }

    .stat-card-new.not-corrected {
        border-left-color: #fbbf24;
    }

    .stat-label-new {
        font-size: 0.75rem;
        color: #718096;
        margin-bottom: 0.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value-new {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a202c;
    }

    .assigned-to-column {
        color: #667eea;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .assigned-to-column.unassigned {
        color: #cbd5e0;
    }

    @media (max-width: 768px) {
        .assignment-form {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}

{% set total_students = submissions|length + not_submitted_students|length %}
{% set submitted_count = submissions|length %}
{% set missing_count = not_submitted_students|length %}
{% set late_count = namespace(value=0) %}
{% for sub in submissions %}
{% if sub.upload_time > sub.assignment.deadline_date %}
{% set late_count.value = late_count.value + 1 %}
{% endif %}
{% endfor %}

{% set total_submissions = submissions|length %}
{% set unassigned_count = submissions|selectattr('assigned_to_id', 'none')|list|length %}
{% set approved_count = submissions|selectattr('reviewed', 'equalto', true)|list|length %}
{% set waiting_approval_count = submissions|selectattr('corrected', 'equalto', true)|rejectattr('reviewed', 'equalto', true)|list|length %}
{% set not_corrected_assigned = submissions|rejectattr('corrected', 'equalto', true)|rejectattr('assigned_to_id', 'none')|list|length %}






<header class="page-header">
    <div class="page-header-content">
        {% if group_id and group %}
        <a href="{{ url_for('admin.group_assignments', group_id=group_id) }}" class="back-button">‚Üê Back to {{
            group.name }} Assignments</a>
        {% else %}
        <a href="{{ url_for('admin.assignments') }}" class="back-button">‚Üê Back to Assignments</a>
        {% endif %}
        <h1 class="page-title">Assignment Details</h1>
    </div>
</header>

<div class="container">
    <div class="card info-card">
        <div class="info-card-details">
            <h2>{{ assignment.title }}</h2>
            <div class="info-card-meta">
                <span class="meta-item"><span class="meta-dot" style="background-color: var(--color-info);"></span> Due:
                    {{ assignment.deadline_date.strftime('%b %d, %Y at %I:%M %p') }}</span>
                <span class="meta-item"><span class="meta-dot" style="background-color: var(--color-warning);"></span>
                    {{ assignment.points }} Points</span>
            </div>
        </div>
        <div>
            Completion:
            <strong style="font-size: 1.5rem;">
                {% if total_students > 0 %}{{ "%.0f"|format((submitted_count / total_students) * 100) }}{% else %}0{%
                endif %}%
            </strong>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/student.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Total Students</p>
                <p class="value">{{ total_students }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/submit.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Submitted</p>
                <p class="value">{{ submitted_count }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/incomplete.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Missing</p>
                <p class="value">{{ missing_count }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/overdue.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Late</p>
                <p class="value">{{ late_count.value }}</p>
            </div>
        </div>
    </div>

    <!-- New Assignment Statistics -->
    <div class="stats-grid-new">
        <div class="stat-card-new unassigned">
            <div class="stat-label-new">Unassigned Submissions</div>
            <div class="stat-value-new">{{ unassigned_count }}</div>
        </div>
        <div class="stat-card-new approved">
            <div class="stat-label-new">Approved Submissions</div>
            <div class="stat-value-new">{{ approved_count }}</div>
        </div>
        <div class="stat-card-new waiting">
            <div class="stat-label-new">Waiting Approval</div>
            <div class="stat-value-new">{{ waiting_approval_count }}</div>
        </div>
        <div class="stat-card-new not-corrected">
            <div class="stat-label-new">Not Corrected (Assigned)</div>
            <div class="stat-value-new">{{ not_corrected_assigned }}</div>
        </div>
    </div>

    <!-- Assistant Assignment Panel (Super Admin Only) -->
    {% if current_user.role == "super_admin" and assistants %}
    <div class="assistant-assignment-panel">
        <h3>üìã Assign Submissions to Assistants</h3>
        <div class="assistants-grid">
            {% for assistant in assistants %}
            {% set assistant_assigned = submissions|selectattr('assigned_to_id', 'equalto', assistant.id)|list %}
            {% set assistant_assigned_count = assistant_assigned|length %}
            <div class="assistant-card">
                <div class="assistant-header">
                    <div class="assistant-info">
                        <h4>{{ assistant.name }}</h4>
                        <p>{{ assistant.email }}</p>
                    </div>
                    <div class="assistant-stats">
                        <div class="assigned-count">{{ assistant_assigned_count }}</div>
                        <small style="color: #718096;">assigned</small>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('admin.assign_submissions_to_assistant', assignment_id=assignment.id) }}" class="assignment-form">
                    <input type="hidden" name="assistant_id" value="{{ assistant.id }}">
                    {% if group_id %}
                    <input type="hidden" name="group_id" value="{{ group_id }}">
                    {% endif %}
                    <div class="form-group">
                        <label for="start_{{ assistant.id }}">Start Index</label>
                        <input type="number" id="start_{{ assistant.id }}" name="start_index" min="1" max="{{ total_submissions }}" placeholder="1" required>
                    </div>
                    <div class="form-group">
                        <label for="end_{{ assistant.id }}">End Index</label>
                        <input type="number" id="end_{{ assistant.id }}" name="end_index" min="1" max="{{ total_submissions }}" placeholder="{{ total_submissions }}" required>
                    </div>
                    <button type="submit" class="btn-assign">
                        ‚úì Assign
                    </button>
                    {% if assistant_assigned_count > 0 %}
                    <button type="submit" formaction="{{ url_for('admin.unassign_submissions', assignment_id=assignment.id) }}" class="btn-unassign" onclick="return confirm('Unassign all submissions from {{ assistant.name }}?')">
                        ‚úó Unassign
                    </button>
                    {% endif %}
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card" style="overflow: visible;">
        <div class="card-header"
            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h3>Student Submissions</h3>
                <p>Review and grade submitted assignments.</p>
            </div>
            {% if current_user.role == "super_admin" %}
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button onclick="approveAllSubmissions()" class="btn btn-success" style="
                    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-weight: 600;
                    border: none;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(56, 239, 125, 0.3);
                    transition: all 0.3s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(56, 239, 125, 0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(56, 239, 125, 0.3)';">
                    ‚úì Approve All Corrected
                </button>
                <button onclick="openBulkApprovalPanel()" class="btn btn-primary" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-weight: 600;
                    border: none;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    transition: all 0.3s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                    ‚òëÔ∏è Bulk Approve
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Bulk Approval Panel -->
        {% if current_user.role == "super_admin" %}
        <div id="bulkApprovalPanel" style="
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="color: white;">
                    <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">
                        <span id="selectedCount">0</span> Selected
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" onclick="selectAllSubmissions()" style="
                            padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 0.9rem;
                            transition: all 0.2s;
                        ">Select All</button>
                        <button type="button" onclick="deselectAllSubmissions()" style="
                            padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 0.9rem;
                            transition: all 0.2s;
                        ">Deselect All</button>
                        <button type="button" onclick="selectCorrected()" style="
                            padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2);
                            color: white;
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 0.9rem;
                            transition: all 0.2s;
                        ">Select Corrected</button>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button type="button" id="btnApproveSelected" onclick="approveSelected()" disabled style="
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 700;
                        font-size: 1rem;
                        box-shadow: 0 4px 12px rgba(56, 239, 125, 0.3);
                        transition: all 0.3s;
                    ">
                        ‚úì Approve Selected
                    </button>
                    <button type="button" onclick="openRangeModal()" style="
                        padding: 12px 24px;
                        background: rgba(255, 255, 255, 0.95);
                        color: #667eea;
                        border: 2px solid white;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 700;
                        font-size: 1rem;
                        transition: all 0.3s;
                    ">
                        üìä Approve by Range
                    </button>
                    <button type="button" onclick="closeBulkApprovalPanel()" style="
                        padding: 12px 24px;
                        background: rgba(255, 255, 255, 0.2);
                        color: white;
                        border: 1px solid rgba(255, 255, 255, 0.5);
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 1rem;
                        transition: all 0.3s;
                    ">
                        Close
                    </button>
                    <div id="bulkLoadingSpinner" style="display: none; margin-left: 10px;">
                        <div style="
                            width: 24px;
                            height: 24px;
                            border: 3px solid rgba(255,255,255,0.3);
                            border-radius: 50%;
                            border-top-color: white;
                            animation: spin 0.8s linear infinite;
                        "></div>
                    </div>
                </div>
            </div>
        </div>
        <style>
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            #btnApproveSelected:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .submission-row.selected {
                background: rgba(102, 126, 234, 0.1) !important;
                border-left: 4px solid #667eea;
            }
        </style>
        {% endif %}
        <div class="card-content no-padding" style="overflow: visible;">
            <div class="table-wrapper" style="overflow: visible;">
                <table style="position: relative;">
                    <thead>
                        <tr>
                            {% if current_user.role == "super_admin" %}
                            <th style="width: 50px; text-align: center;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()" style="
                                    width: 20px;
                                    height: 20px;
                                    cursor: pointer;
                                    accent-color: #667eea;
                                ">
                            </th>
                            {% endif %}
                            <th>#</th>
                            <th>Student</th>
                            <th>Submission Time</th>
                            {% if assignment.out_of > 0 %}
                            <th>Grade</th>
                            {%else%}
                            <th>Corrected</th>
                            {% endif %}
                            <th>Status</th>
                            <th>Assigned To</th>
                            <th>Original File</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for submission in submissions %}
                        {% if submission.student_id in submitted_student_ids %}
                        <tr class="submission-row" data-submission-id="{{ submission.id }}" data-corrected="{{ submission.corrected }}" data-reviewed="{{ submission.reviewed }}">
                            {% if current_user.role == "super_admin" %}
                            <td style="text-align: center;">
                                {% if submission.corrected and not submission.reviewed %}
                                <input type="checkbox" class="submission-checkbox" data-submission-id="{{ submission.id }}" onchange="updateSelectionCount()" style="
                                    width: 20px;
                                    height: 20px;
                                    cursor: pointer;
                                    accent-color: #667eea;
                                ">
                                {% else %}
                                <span style="color: #ccc;">‚Äî</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td data-label="#" style="font-weight: 600; color: #666;">{{ loop.index }}</td>
                            <td data-label="Student" class="student-name">
                                <a href="{{ url_for('admin.student', user_id=submission.student.id) }}">{{
                                    submission.student.name }}</a>
                                <div class="assignment-due">{{ submission.student.code }}</div>
                            </td>
                            <td data-label="Time"
                                class="submission-time {% if submission.upload_time > submission.assignment.deadline_date %}late{% endif %}">
                                {{ submission.upload_time.strftime('%b %d, %Y %I:%M %p') }}
                            </td>
                            {% if assignment.out_of > 0 %}
                            <td data-label="Grade">
                                <form method="POST" class="grade-form"
                                    style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="hidden" name="submission_id" value="{{ submission.id }}">
                                    <input type="text" name="mark"
                                        value="{{ submission.mark if submission.mark is not none else '' }}"
                                        placeholder="Grade" style="
                                            width: 100px;
                                            padding: 6px 10px;
                                            border: 1px solid #ccc;
                                            border-radius: 4px;
                                            font-size: 1rem;
                                            background: #fafbfc;
                                            transition: border-color 0.2s;
                                        " onfocus="this.style.borderColor='#007bff';"
                                        onblur="this.style.borderColor='#ccc';">
                                    <button type="submit" style="
                                            padding: 6px 16px;
                                            background-color: #007bff;
                                            color: #fff;
                                            border: none;
                                            border-radius: 4px;
                                            font-size: 1rem;
                                            cursor: pointer;
                                            transition: background 0.2s;
                                        " onmouseover="this.style.backgroundColor='#0056b3';"
                                        onmouseout="this.style.backgroundColor='#007bff';">Save</button>
                                </form>
                            </td>
                            {%else%}
                            {% if submission.corrected %}
                            <td>
                                <a href="{{ url_for('admin.get_pdf2', submission_id=submission.id) }}" target="_blank"
                                    class="btn btn-primary btn-open btn-small">Open Corrected File</a>
                            </td>
                            {% else %}
                            <td>
                                Not Corrected
                                {{submission.corrected}}
                            </td>
                            {% endif %}

                            {% endif %}

                            <td data-label="Status">
                                {% if submission.corrected and submission.reviewed %}
                                <span class="badge badge-success"
                                    style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">‚úì
                                    Approved</span>
                                {% elif submission.corrected and not submission.reviewed %}
                                <span class="badge badge-warning"
                                    style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); color: #2d3436; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">‚è≥
                                    Pending Review</span>
                                {% else %}
                                <span class="badge badge-secondary"
                                    style="background: #e0e0e0; color: #666; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">‚Äî
                                    Not Corrected</span>
                                {% endif %}
                            </td>

                            <td data-label="Assigned To">
                                {% if submission.assigned_to %}
                                <span class="assigned-to-column">{{ submission.assigned_to.name }}</span>
                                {% else %}
                                <span class="assigned-to-column unassigned">Unassigned</span>
                                {% endif %}
                            </td>

                            <td>
                                <a href="{{ url_for('admin.get_pdf', submission_id=submission.id) }}" target="_blank"
                                    class="btn btn-primary btn-open btn-small">Open Original File</a>
                            </td>
                            <td data-label="Actions">
                                <!-- Actions Popup Menu -->
                                <div class="actions-dropdown">
                                    <button type="button"
                                        class="btn btn-primary btn-open btn-small actions-menu-button">Actions
                                        &#x25BC;</button>
                                    <div class="actions-menu">
                                        {% if current_user.role == "super_admin" and submission.corrected and not
                                        submission.reviewed %}
                                        <button type="button" class="actions-menu-item"
                                            style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; font-weight: 600;"
                                            onclick="closeAllMenus(); approveSubmission({{ submission.id }}, '{{ submission.student.name }}');">
                                            ‚úì Approve Correction
                                        </button>
                                        {% endif %}
                                        <button type="button" class="actions-menu-item"
                                            data-submission-id="{{ submission.id }}"
                                            data-student-name="{{ submission.student.name }}"
                                            data-current-mark="{{ submission.mark if submission.mark is not none else '' }}"
                                            onclick="closeAllMenus(); openUploadModal(this.getAttribute('data-submission-id'), this.getAttribute('data-student-name'), this.getAttribute('data-current-mark'));">
                                            üì§ Upload Corrected PDF
                                        </button>
                                        <a href="{{ url_for('admin.edit_pdf', submission_id=submission.id) }}"
                                            class="actions-menu-item">
                                            ‚úèÔ∏è Correct Student PDF
                                        </a>
                                        {% if submission.mark or submission.corrected %}
                                        <a href="{{ url_for('admin.edit_pdf2', submission_id=submission.id) }}"
                                         class="actions-menu-item">
                                            üñäÔ∏è Edit on Corrected PDF
                                        </a>
                                        <a href="{{ url_for('admin.get_pdf2', submission_id=submission.id) }}" target="_blank"
                                         class="actions-menu-item">
                                            üëÅÔ∏è Open Corrected PDF
                                        </a>

                                        <form method="POST"
                                            action="{{ url_for('admin.delete_submission', submission_id=submission.id) }}"
                                            style="display:inline; margin: 0;"
                                            onsubmit="return confirmAction(event,'Are you sure you want to delete this submission? <br> <p style=&quot;color: red;&quot;>This can\'t be undone</p>');">
                                            <button type="submit" class="actions-menu-item actions-menu-item-danger">
                                                üóëÔ∏è Delete Student Submission
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- /Actions Popup Menu -->
                            </td>
                        </tr>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem;">No submissions yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helpers for dropdown menu
        function closeAllMenus() {
            document.querySelectorAll('.actions-menu').forEach(menu => {
                menu.style.display = 'none';
                // Reset positioning
                menu.style.right = '0';
                menu.style.left = 'auto';
            });
            document.querySelectorAll('.actions-menu-button').forEach(btn => btn.classList.remove('open'));
        }

        // Toggle menu on Actions button click, close others
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.actions-dropdown').forEach(function (dropdown) {
                var btn = dropdown.querySelector('.actions-menu-button');
                var menu = dropdown.querySelector('.actions-menu');
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    // Close all others first
                    closeAllMenus();
                    // Toggle this one
                    if (menu.style.display === 'block') {
                        menu.style.display = 'none';
                        btn.classList.remove('open');
                    } else {
                        menu.style.display = 'block';
                        btn.classList.add('open');

                        // Smart positioning: Check if menu goes off-screen
                        setTimeout(function () {
                            var rect = menu.getBoundingClientRect();
                            var viewportWidth = window.innerWidth;

                            // If menu goes off right edge, position it on the left side
                            if (rect.right > viewportWidth - 10) {
                                menu.style.right = 'auto';
                                menu.style.left = '0';
                            }

                            // If menu goes off left edge, position it on the right side
                            if (rect.left < 10) {
                                menu.style.left = 'auto';
                                menu.style.right = '0';
                            }
                        }, 0);
                    }
                });
            });
            // Click outside closes all
            document.body.addEventListener('click', function () {
                closeAllMenus();
            });
            // Stop clicking the menu from bubbling up (don't close when clicking inside)
            document.querySelectorAll('.actions-menu').forEach(function (menu) {
                menu.addEventListener('click', function (e) { e.stopPropagation(); });
            });
        });
    </script>
    <style>
        /* Actions Dropdown Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .actions-menu {
            display: none;
            position: absolute;
            z-index: 9999;
            right: 0;
            top: 100%;
            margin-top: 4px;
            min-width: 220px;
            background: #fff;
            border: 1px solid #e3e3e3;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            overflow: hidden;
        }

        .actions-menu-item {
            display: block;
            width: 100%;
            border: none;
            background: none;
            text-align: left;
            padding: 12px 16px;
            cursor: pointer;
            color: #374151;
            text-decoration: none;
            font-size: 0.95rem;
            transition: background-color 0.15s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .actions-menu-item:last-child,
        .actions-menu form:last-child .actions-menu-item {
            border-bottom: none;
        }

        .actions-menu-item:hover,
        .actions-menu-item:focus {
            background-color: #f3f4f6;
            outline: none;
        }

        .actions-menu-item-danger {
            color: #dc2626;
        }

        .actions-menu-item-danger:hover {
            background-color: #fee2e2;
        }

        .actions-menu-button.open {
            background: #5050ee;
            color: #fff;
        }

        /* Mobile responsive positioning */
        @media (max-width: 768px) {
            .actions-menu {
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                min-width: 200px;
            }

            /* Adjust if menu is at the edge */
            .actions-dropdown:last-child .actions-menu {
                right: 0;
                left: auto;
                transform: none;
            }
        }

        /* Ensure table cells don't clip the dropdown */
        tbody tr {
            position: relative;
        }

        tbody td {
            overflow: visible;
        }
    </style>


    <div class="card">
        <div class="card-header">
            <h3>Missing Submissions</h3>
            <p>Students who did not submit this assignment.</p>
        </div>
        <div class="card-content no-padding">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Class/Group</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in not_submitted_students %}
                        <tr>
                            <td data-label="Student" class="student-name">
                                <a href="{{ url_for('admin.student', user_id=student.id) }}">{{ student.name }}</a>
                                <div class="assignment-due">{{ student.code }}</div>
                            </td>
                            <td data-label="Class">{{ student.group.name if student.group else 'N/A' }}</td>
                            <td data-label="Status">

                                <div>
                                    <span class="badge badge-red">Missing</span>
                                </div>


                            </td>
                            <td data-label="Action">
                                <div>

                                    <form method="POST"
                                        action="{{ url_for('admin.send_late_message_for_submission', assignment_id=assignment.id, student_id=student.id) }}"
                                        class="send-reminder-form" data-student-name="{{ student.name }}"
                                        data-parent-phone="{{ student.parent_phone_number }}">
                                        <input type="hidden" name="student_id" value="{{ student.id }}">
                                        {% set sent = notification_status.get(student.id) %}
                                        <button type="submit" class="btn btn-reminder btn-small" {% if sent %}disabled
                                            style="background-color: #ccc; color: #888; cursor: not-allowed;" {% endif
                                            %}>
                                            {% if sent %}Sent{% else %}Send Reminder{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 2rem;">All students have submitted.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    // Toast function
    function showToast(message, success = true) {
        let toast = document.createElement("div");
        toast.className = "custom-toast" + (success ? " toast-success" : " toast-fail");
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add("show");
        }, 50);
        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => document.body.removeChild(toast), 400);
        }, 3000);
    }

    // CSS for the toast
    if (!document.getElementById("custom-toast-style")) {
        let style = document.createElement("style");
        style.id = "custom-toast-style";
        style.innerHTML = `
        .custom-toast {
            visibility: hidden;
            min-width: 180px;
            margin-left: -90px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 12px 22px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 40px;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.4s, visibility 0.4s;
        }
        .custom-toast.show {
            visibility: visible;
            opacity: 1;
        }
        .custom-toast.toast-success {
            background-color: #22c55e;
            color: #fff;
        }
        .custom-toast.toast-fail {
            background-color: #dc2626;
            color: #fff;
        }
        `;
        document.head.appendChild(style);
    }


    // AJAX submit for reminder forms
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".send-reminder-form").forEach(function (form) {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const button = form.querySelector("button[type='submit']");
                button.disabled = true;
                button.textContent = "Sending...";
                fetch(form.action, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: new FormData(form)
                })
                    .then(res => res.json())
                    .then(data => {
                        let success = data.status === 'success';
                        if (success) {
                            button.textContent = "Sent";
                            button.style.backgroundColor = "#ccc";
                            button.style.color = "#888";
                            button.style.cursor = "not-allowed";
                        } else {
                            button.disabled = false;
                            button.textContent = "Failed to Send";
                            button.style.backgroundColor = "#dc2626";
                            button.style.color = "#fff";
                            button.style.cursor = "pointer";
                        }
                        showToast(
                            data.message ||
                            (success
                                ? "Reminder sent."
                                : "Failed to send reminder."),
                            success
                        );
                    })
                    .catch(error => {
                        button.disabled = false;
                        button.textContent = "Failed to Send";
                        button.style.backgroundColor = "#dc2626";
                        button.style.color = "#fff";
                        button.style.cursor = "pointer";
                        showToast("Failed to send reminder.", false);
                    });
            });
        });
    });
</script>
<!-- Single Modal for uploading corrected PDF (outside loop) -->
<div id="uploadModal" class="modal-upload-corrected">
    <div class="modal-content-upload">
        <span class="close-upload-modal" onclick="closeUploadModal()">&times;</span>
        <h3 style="margin-bottom: 0.5rem;">Upload Corrected PDF</h3>
        <p id="modal-student-name" style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"></p>

        <!-- Alert for errors -->
        <div id="upload-alert"
            style="display:none; background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.97rem;">
        </div>

        <form id="upload-corrected-form">
            <input type="hidden" id="modal-submission-id" value="">


            {% if assignment.out_of > 0 %}
            <div style="margin-bottom: 1rem;">
                <label for="modal-mark"
                    style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Grade/Mark:</label>
                <input type="text" id="modal-mark" name="mark" placeholder="Enter grade"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
            </div>
            {% endif %}
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Corrected PDF File:</label>

                <div id="drop-zone" style="
                    border: 2px dashed #ccc;
                    border-radius: 8px;
                    padding: 2rem 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: #fafbfc;
                ">
                    <input type="file" id="modal-file" accept="application/pdf" style="display: none;">
                    <div id="drop-zone-content">
                        <p style="margin: 0; color: #666; font-size: 0.95rem;">üìÅ Drag & drop PDF here</p>
                        <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.85rem;">or click to browse</p>
                    </div>
                    <div id="file-selected" style="display: none;">
                        <p style="margin: 0; color: #007bff; font-weight: 500;">‚úì <span id="selected-file-name"></span>
                        </p>
                        <p style="margin: 0.25rem 0 0 0; color: #999; font-size: 0.85rem;">Click to change file</p>
                    </div>
                </div>
            </div>

            <div id="upload-progress-container" style="display: none; margin-bottom: 1rem;">
                <div style="
                    height: 8px;
                    background: #e5e7eb;
                    border-radius: 9999px;
                    overflow: hidden;
                    margin-bottom: 0.5rem;
                ">
                    <div id="upload-progress-bar" style="
                        height: 100%;
                        background: linear-gradient(90deg, #4f46e5, #7c3aed);
                        border-radius: 9999px;
                        transition: width 0.2s linear;
                        width: 0%;
                    "></div>
                </div>
                <p id="upload-status-text" style="margin: 0; font-size: 0.85rem; color: #666; text-align: center;"></p>
            </div>

            <div style="display: flex; gap: 0.75rem;">
                <button type="submit" id="submit-upload-btn" class="btn btn-primary btn-small" style="flex: 1;"
                    disabled>
                    Submit
                </button>
                <button type="button" class="btn btn-secondary btn-small" onclick="closeUploadModal()"
                    style="background: #ccc; color: #222;">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    #submit-upload-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: red;
    }

    #submit-upload-btn {
        flex: 1;
    }

    .modal-upload-corrected {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content-upload {
        background-color: #fff;
        margin: 3% auto;
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        position: relative;
    }

    @media (max-width: 640px) {
        .modal-content-upload {
            margin: 10% auto;
            width: 95%;
            padding: 1.25rem;
        }
    }

    .close-upload-modal {
        color: #aaa;
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
        line-height: 1;
    }

    .close-upload-modal:hover {
        color: #333;
    }

    #drop-zone.drag-over {
        border-color: #007bff;
        background: #f0f8ff;
    }
</style>

<script>
    let currentSubmissionId = null;

    function openUploadModal(submissionId, studentName, currentMark) {
        currentSubmissionId = submissionId;
        document.getElementById('modal-submission-id').value = submissionId;
        document.getElementById('modal-student-name').textContent = 'Student: ' + studentName;
        {% if assignment.out_of > 0 %}
        document.getElementById('modal-mark').value = currentMark || '';
        {% endif %}
        // Reset file input
        document.getElementById('modal-file').value = '';
        document.getElementById('file-selected').style.display = 'none';
        document.getElementById('drop-zone-content').style.display = 'block';
        document.getElementById('upload-progress-container').style.display = 'none';
        document.getElementById('upload-progress-bar').style.width = '0%';

        // Hide alert
        document.getElementById('upload-alert').style.display = 'none';
        document.getElementById('upload-alert').textContent = '';

        // Disable submit button initially
        document.getElementById('submit-upload-btn').disabled = true;
        document.getElementById('submit-upload-btn').textContent = 'Submit';

        document.getElementById('uploadModal').style.display = 'block';

        // Trigger validation in case mark is prefilled
        validateUploadForm();
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
        currentSubmissionId = null;
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('uploadModal');
        if (event.target === modal) {
            closeUploadModal();
        }
    };

    // Drag and drop functionality
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('modal-file');
    {% if assignment.out_of > 0 %}
    const markInput = document.getElementById('modal-mark');
    {% endif %}
    const submitBtn = document.getElementById('submit-upload-btn');
    const uploadAlert = document.getElementById('upload-alert');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            updateFileDisplay(files[0]);
            validateUploadForm();
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            updateFileDisplay(e.target.files[0]);
        }
        validateUploadForm();
    });

    {% if assignment.out_of > 0 %}
    markInput.addEventListener('input', validateUploadForm);
    {% endif %}

    function updateFileDisplay(file) {
        document.getElementById('selected-file-name').textContent = file.name;
        document.getElementById('file-selected').style.display = 'block';
        document.getElementById('drop-zone-content').style.display = 'none';
    }

    function validateUploadForm() {
        const file = fileInput.files[0];
        {% if assignment.out_of > 0 %}
        const mark = markInput.value.trim();
        // Enable only if both file and mark are present and mark is not empty
        if (file && mark.length > 0) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
        {% else %}
        // Enable if file is present (no mark required for ungraded assignments)
        if (file) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
        {% endif %}
    }

    // Chunked upload form submission
    document.getElementById('upload-corrected-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const submissionId = document.getElementById('modal-submission-id').value;
        {% if assignment.out_of > 0 %}
        const mark = document.getElementById('modal-mark').value;
        {% else %}
        const mark = '';
        {% endif %}
        const file = fileInput.files[0];

        // Hide previous alert
        uploadAlert.style.display = 'none';
        uploadAlert.textContent = '';

        {% if assignment.out_of > 0 %}
        if (!mark) {
            uploadAlert.textContent = 'Please enter a grade/mark.';
            uploadAlert.style.display = 'block';
            return;
        }
        {% endif %}

        if (!file) {
            uploadAlert.textContent = 'Please select a PDF file to upload.';
            uploadAlert.style.display = 'block';
            return;
        }

        if (file.type !== 'application/pdf') {
            uploadAlert.textContent = 'Please select a valid PDF file.';
            uploadAlert.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');
        const statusText = document.getElementById('upload-status-text');

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusText.textContent = 'Starting upload...';
        statusText.style.color = '#666';

        const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
        const totalSize = file.size;
        let offset = 0;

        try {
            while (offset < totalSize) {
                const end = Math.min(offset + CHUNK_SIZE, totalSize);
                const chunk = file.slice(offset, end);

                const formData = new FormData();
                formData.append('file_chunk', chunk);
                formData.append('filename', file.name);
                formData.append('offset', offset);
                formData.append('total_size', totalSize);
                formData.append('mark', mark);

                const response = await fetch(`/admin/upload-corrected-pdf-chunk/${submissionId}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();

                if (result.action === 'upload_complete') {
                    progressBar.style.width = '100%';
                    statusText.textContent = '‚úì Upload complete!';
                    statusText.style.color = '#059669';

                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    return;
                }

                offset = end;
                const percent = Math.floor((offset / totalSize) * 100);
                progressBar.style.width = percent + '%';
                statusText.textContent = `Uploading... ${percent}%`;
            }
        } catch (error) {
            statusText.textContent = '‚úó Upload failed: ' + error.message;
            statusText.style.color = '#dc2626';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
            uploadAlert.textContent = 'Upload failed: ' + error.message;
            uploadAlert.style.display = 'block';
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const reminderForms = document.querySelectorAll('.send-reminder-form');
        reminderForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                const submitButton = form.querySelector('button[type="submit"]');

                const studentName = form.dataset.studentName;
                const parentPhone = form.dataset.parentPhone;
                const confirmationMessage = `Send WhatsApp reminder to this student and parent?\n\nStudent: ${studentName}\nParent: ${parentPhone}`;

                if (confirm(confirmationMessage)) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Sending...';

                    fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok.');
                            return response.json();
                        })
                        .then(data => {
                            console.log('Success:', data);
                            submitButton.textContent = 'Sent!';
                            submitButton.classList.add('sent');
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to send message. Please try again.');
                            submitButton.disabled = false;
                            submitButton.textContent = 'Send Reminder';
                        });
                }
            });
        });
    });

    // Approve individual submission
    window.approveSubmission = function (submissionId, studentName) {
        Swal.fire({
            title: 'Approve Correction?',
            html: `
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">Are you sure you want to approve the correction for <strong>${studentName}</strong>?</p>
                <p style="color: #666; font-size: 0.95rem;">This will send WhatsApp notifications to the student and parent.</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#11998e',
            cancelButtonColor: '#d33',
            confirmButtonText: '‚úì Yes, Approve',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'Approving...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Make POST request to approve
                fetch(`/admin/submissions/review/approve/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Approved!',
                                text: 'The correction has been approved and notifications sent.',
                                icon: 'success',
                                confirmButtonColor: '#11998e'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Failed to approve submission.',
                                icon: 'error',
                                confirmButtonColor: '#d33'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while approving.',
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    });
            }
        });
    }

    // Approve all corrected submissions
    window.approveAllSubmissions = function () {
        // Get all pending review submissions
        const pendingReviews = document.querySelectorAll('.badge-warning');
        const pendingCount = pendingReviews.length;

        if (pendingCount === 0) {
            Swal.fire({
                title: 'No Pending Reviews',
                text: 'There are no submissions awaiting review.',
                icon: 'info',
                confirmButtonColor: '#11998e'
            });
            return;
        }

        Swal.fire({
            title: 'Approve All Corrections?',
            html: `
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">You are about to approve <strong>${pendingCount}</strong> correction(s).</p>
                <p style="color: #666; font-size: 0.95rem;">This will send WhatsApp notifications to all students and parents.</p>
                <p style="color: #d33; font-size: 0.9rem; margin-top: 1rem;"><strong>‚ö†Ô∏è This action cannot be undone!</strong></p>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#11998e',
            cancelButtonColor: '#d33',
            confirmButtonText: `‚úì Yes, Approve All ${pendingCount}`,
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'Approving All...',
                    text: 'This may take a moment',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Make POST request to approve all
                fetch(`/admin/assignments/{{ assignment.id }}/approve-all-submissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Success!',
                                html: `
                                <p style="font-size: 1.1rem;">${data.approved_count} correction(s) approved!</p>
                                <p style="color: #666; font-size: 0.95rem; margin-top: 0.5rem;">Notifications have been sent.</p>
                            `,
                                icon: 'success',
                                confirmButtonColor: '#11998e'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message || 'Failed to approve submissions.',
                                icon: 'error',
                                confirmButtonColor: '#d33'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while approving.',
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    });
            }
        });
    }

    // ===== BULK APPROVAL FUNCTIONS =====
    
    function openBulkApprovalPanel() {
        document.getElementById('bulkApprovalPanel').style.display = 'block';
        updateSelectionCount();
    }

    function closeBulkApprovalPanel() {
        document.getElementById('bulkApprovalPanel').style.display = 'none';
        deselectAllSubmissions();
    }

    function updateSelectionCount() {
        const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
        const count = checkboxes.length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('btnApproveSelected').disabled = count === 0;
        
        // Update row styling
        document.querySelectorAll('.submission-row').forEach(row => {
            const checkbox = row.querySelector('.submission-checkbox');
            if (checkbox && checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });

        // Update "select all" checkbox state
        const allCheckboxes = document.querySelectorAll('.submission-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }
    }

    function toggleAllCheckboxes() {
        const selectAll = document.getElementById('selectAllCheckbox').checked;
        document.querySelectorAll('.submission-checkbox').forEach(cb => {
            cb.checked = selectAll;
        });
        updateSelectionCount();
    }

    function selectAllSubmissions() {
        document.querySelectorAll('.submission-checkbox').forEach(cb => {
            cb.checked = true;
        });
        updateSelectionCount();
    }

    function deselectAllSubmissions() {
        document.querySelectorAll('.submission-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateSelectionCount();
    }

    function selectCorrected() {
        document.querySelectorAll('.submission-checkbox').forEach(cb => {
            const row = cb.closest('.submission-row');
            const corrected = row.dataset.corrected === 'True';
            const reviewed = row.dataset.reviewed === 'True';
            cb.checked = corrected && !reviewed;
        });
        updateSelectionCount();
    }

    async function approveSelected() {
        const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
        const submissionIds = Array.from(checkboxes).map(cb => cb.dataset.submissionId);
        
        if (submissionIds.length === 0) {
            Swal.fire({
                title: 'No Selection',
                text: 'Please select at least one submission to approve.',
                icon: 'warning',
                confirmButtonColor: '#11998e'
            });
            return;
        }

        const result = await Swal.fire({
            title: 'Approve Selected?',
            html: `
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">You are about to approve <strong>${submissionIds.length}</strong> submission(s).</p>
                <p style="color: #666; font-size: 0.95rem;">This will send WhatsApp notifications to students and parents.</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#11998e',
            cancelButtonColor: '#d33',
            confirmButtonText: `‚úì Approve ${submissionIds.length}`,
            cancelButtonText: 'Cancel'
        });

        if (!result.isConfirmed) return;

        const spinner = document.getElementById('bulkLoadingSpinner');
        spinner.style.display = 'inline-block';

        try {
            const response = await fetch('/admin/submissions/approve-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ submission_ids: submissionIds })
            });

            const data = await response.json();
            spinner.style.display = 'none';

            if (data.success) {
                await Swal.fire({
                    title: 'Success!',
                    html: `
                        <p style="font-size: 1.1rem;">${data.approved_count} submission(s) approved!</p>
                        <p style="color: #666; font-size: 0.95rem; margin-top: 0.5rem;">Notifications have been sent.</p>
                    `,
                    icon: 'success',
                    confirmButtonColor: '#11998e'
                });
                location.reload();
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Failed to approve submissions.',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        } catch (error) {
            spinner.style.display = 'none';
            Swal.fire({
                title: 'Error',
                text: 'An error occurred: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        }
    }

    function openRangeModal() {
        Swal.fire({
            title: 'Approve by Range',
            html: `
                <div style="margin: 1.5rem 0;">
                    <div style="display: flex; gap: 1rem; align-items: center; justify-content: center; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; text-align: left;">From Index:</label>
                            <input type="number" id="rangeFrom" min="1" class="swal2-input" style="width: 100%; margin: 0;" value="1">
                        </div>
                        <div style="margin-top: 2rem; font-size: 1.5rem; font-weight: 700; color: #667eea;">‚Üí</div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; text-align: left;">To Index:</label>
                            <input type="number" id="rangeTo" min="1" class="swal2-input" style="width: 100%; margin: 0;" value="${document.querySelectorAll('.submission-row').length}">
                        </div>
                    </div>
                    <div id="rangePreview" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.95rem; color: #666;"></div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#11998e',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Approve Range',
            cancelButtonText: 'Cancel',
            didOpen: () => {
                const updatePreview = () => {
                    const from = parseInt(document.getElementById('rangeFrom').value) || 1;
                    const to = parseInt(document.getElementById('rangeTo').value) || 1;
                    const count = Math.max(0, to - from + 1);
                    document.getElementById('rangePreview').textContent = 
                        `Will approve submissions #${from} to #${to} (${count} total)`;
                };
                document.getElementById('rangeFrom').addEventListener('input', updatePreview);
                document.getElementById('rangeTo').addEventListener('input', updatePreview);
                updatePreview();
            },
            preConfirm: () => {
                const from = parseInt(document.getElementById('rangeFrom').value);
                const to = parseInt(document.getElementById('rangeTo').value);
                const maxIndex = document.querySelectorAll('.submission-row').length;
                
                if (!from || !to || from < 1 || to < 1) {
                    Swal.showValidationMessage('Please enter valid indices');
                    return false;
                }
                if (from > to) {
                    Swal.showValidationMessage('From index must be ‚â§ To index');
                    return false;
                }
                if (from > maxIndex || to > maxIndex) {
                    Swal.showValidationMessage(`Indices must be between 1 and ${maxIndex}`);
                    return false;
                }
                return { from, to };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                const { from, to } = result.value;
                await approveByRange(from, to);
            }
        });
    }

    async function approveByRange(fromIndex, toIndex) {
        const spinner = document.getElementById('bulkLoadingSpinner');
        spinner.style.display = 'inline-block';

        try {
            // Get submission IDs from the range
            const rows = Array.from(document.querySelectorAll('.submission-row'));
            const submissionsInRange = rows.slice(fromIndex - 1, toIndex);
            const submissionIds = submissionsInRange
                .map(row => {
                    const checkbox = row.querySelector('.submission-checkbox');
                    return checkbox ? checkbox.dataset.submissionId : null;
                })
                .filter(id => id !== null);

            if (submissionIds.length === 0) {
                spinner.style.display = 'none';
                Swal.fire({
                    title: 'No Eligible Submissions',
                    text: 'No corrected submissions found in the specified range.',
                    icon: 'info',
                    confirmButtonColor: '#11998e'
                });
                return;
            }

            const response = await fetch('/admin/submissions/approve-bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ submission_ids: submissionIds })
            });

            const data = await response.json();
            spinner.style.display = 'none';

            if (data.success) {
                await Swal.fire({
                    title: 'Success!',
                    html: `
                        <p style="font-size: 1.1rem;">${data.approved_count} submission(s) approved!</p>
                        <p style="color: #666; font-size: 0.95rem; margin-top: 0.5rem;">From #${fromIndex} to #${toIndex}</p>
                    `,
                    icon: 'success',
                    confirmButtonColor: '#11998e'
                });
                location.reload();
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Failed to approve submissions.',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        } catch (error) {
            spinner.style.display = 'none';
            Swal.fire({
                title: 'Error',
                text: 'An error occurred: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        }
    }
</script>
{% endblock %}