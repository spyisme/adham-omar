{% extends "admin/dashboard.html" %}
{% block title %}Edit Assignment{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* Multi-select dropdown styles */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: .5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: .4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: .25rem .65rem;
        font-size: .9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: .4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    .dropdown {
        position: relative;
        width: 100%;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: .5rem .75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }

    .late-exception-card {
        border-top: 1px solid #e2e8f0;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }

    .late-exception-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.95rem;
    }

    .late-exception-table th,
    .late-exception-table td {
        padding: 0.6rem 0.75rem;
        border: 1px solid #e2e8f0;
        text-align: left;
    }

    .late-exception-table th {
        background: #f1f5f9;
        font-weight: 600;
    }

    .late-exception-status-active {
        color: #15803d;
        font-weight: 600;
    }

    .late-exception-status-expired {
        color: #dc2626;
        font-weight: 600;
    }

    .late-exception-actions form {
        display: inline-flex;
    }

    .late-exception-form {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1.25rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px dashed #cbd5f5;
    }

    .late-exception-form label {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .late-exception-form input[type="text"],
    .late-exception-form input[type="datetime-local"] {
        flex: 1 1 220px;
        min-width: 200px;
    }

    .late-exception-form button {
        flex: 0 0 auto;
    }

    /* --- Attachment System Styles --- */
    .attachment-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .attachment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .attachment-item-number {
        font-weight: 600;
        color: #4338ca;
    }

    .attachment-remove-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.35rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .attachment-remove-btn:hover {
        background: #dc2626;
    }

    .attachment-fields {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .attachment-name-input {
        width: 100%;
    }

    .attachment-type-selector {
        display: flex;
        gap: 0.5rem;
    }

    .attachment-type-btn {
        flex: 1;
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .attachment-type-btn.active {
        background: #4338ca;
        color: white;
        border-color: #4338ca;
    }

    .attachment-type-btn.drive {
        background: #4285f4;
        color: white;
        border-color: #4285f4;
    }
    
    .attachment-type-btn.drive:hover {
        background: #3367d6;
    }
    
    .attachment-type-btn.drive.active {
        background: #1a73e8;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.3);
    }

    .attachment-input-wrapper {
        width: 100%;
    }

    .attachment-file-input,
    .attachment-link-input {
        width: 100%;
    }

    #edit-add-attachment-btn {
        background: #6366f1;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    #edit-add-attachment-btn:hover {
        background: #4f46e5;
    }

    .existing-attachment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f1f5f9;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .existing-attachment-info {
        flex: 1;
        min-width: 0;
    }

    .existing-attachment-name {
        font-weight: 500;
        word-break: break-word;
    }

    .existing-attachment-type {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    .existing-attachment-delete {
        background: transparent;
        color: #ef4444;
        border: 1px solid #ef4444;
        padding: 0.35rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        margin-left: 1rem;
        flex-shrink: 0;
    }

    .existing-attachment-delete:hover {
        background: #ef4444;
        color: #fff;
    }
</style>

<!-- Google Drive API Scripts -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

{% endblock %}

{% block content %}
<header class="page-header">
    <div class="page-header-content">
        {% if group_id and group %}
        <a href="{{ url_for('admin.group_assignments', group_id=group_id) }}" class="back-button">‚Üê Back to {{
            group.name }} Assignments</a>
        {% else %}
        <a href="{{ url_for('admin.assignments') }}" class="back-button">‚Üê Back to Assignments</a>
        {% endif %}
        <h1 class="page-title">Edit Assignment</h1>
    </div>
</header>

<main class="container">
    <div class="card" style="max-width: 700px; margin: 0 auto;">
        <form class="card-content" method="POST" enctype="multipart/form-data">
            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div>
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" value="{{ assignment.title }}" required
                        class="form-input" />
                </div>

                <div>
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-textarea"
                        style="min-height:90px; resize:vertical;">{{ assignment.description }}</textarea>
                </div>

                <div>
                    <label for="deadline_date" class="form-label">Deadline</label>
                    <input type="datetime-local" id="deadline_date" name="deadline_date"
                        value="{{ assignment.deadline_date.strftime('%Y-%m-%dT%H:%M') }}" class="form-input">
                </div>

                <div>
                    <label for="subject" class="form-label">Subject</label>
                    <div class="multi" id="ms-subjects">
                        <button type="button" class="btn form-input multi-btn" id="ms-subjects-btn">
                            {{ assignment.subject.name if assignment.subject else 'Select Subject' }} ‚ñº
                        </button>
                        <div class="multi-list" id="ms-subjects-list">
                            {% for subject in subjects %}
                            <label>
                                <input type="radio" name="subject" value="{{ subject.id }}" required {% if
                                    assignment.subject and assignment.subject.id==subject.id %}checked{% endif %}>
                                {{ subject.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Schools</label>
                    <div class="dropdown">
                        <div id="multiSelectSchools" class="multi-select" onclick="toggleSchoolDropdown()">
                            <input type="text" id="multiInputSchools" placeholder="Type or select schools..."
                                oninput="filterSchools()">
                        </div>
                        <div id="dropdownListSchools" class="dropdown-list">
                            {% for school in schools %}
                            <div data-id="{{ school.id }}">{{ school.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="school_ids" id="selectedSchools">
                    {% if assignment.schools_mm %}
                    <script type="application/json" id="preselected-schools-data">
                        [{% for school in assignment.schools_mm %}{"id": "{{ school.id }}", "name": "{{ school.name|e }}"}{{ "," if not loop.last }}{% endfor %}]
                    </script>
                    {% endif %}
                </div>

                <div>
                    <label class="form-label">Years</label>
                    <div class="multi" id="ms-stages">
                        <button type="button" class="btn form-input multi-btn" id="ms-stages-btn">All Stages ‚ñº</button>
                        <div class="multi-list" id="ms-stages-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not assignment.stages_mm
                                    %}checked{% endif %}>All Stages</label>
                            {% for stage in stages %}
                            <label>
                                <input type="checkbox" name="stages[]" value="{{ stage.id }}" {% if assignment.stages_mm
                                    and stage in assignment.stages_mm %}checked{% endif %}>
                                {{ stage.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Classes</label>
                    <div class="multi" id="ms-groups">
                        <button type="button" class="btn form-input multi-btn" id="ms-groups-btn">All Classes ‚ñº</button>
                        <div class="multi-list" id="ms-groups-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not assignment.groups_mm
                                    %}checked{% endif %}>All Classes</label>
                            {% for group in groups %}
                            <label>
                                <input type="checkbox" name="groups[]" value="{{ group.id }}" {% if assignment.groups_mm
                                    and group in assignment.groups_mm %}checked{% endif %}>
                                {{ group.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <hr style="margin: var(--space-2) 0;">

                <div>
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-4);">Existing Attachments</h3>
                    {% if attachments %}
                    <div style="margin-bottom: 1rem;">
                        {% for attachment in attachments %}
                        <div class="existing-attachment-item">
                            <div class="existing-attachment-info">
                                <div class="existing-attachment-name">
                                    <a href="{{ attachment.url }}" target="_blank" style="color: #4338ca; text-decoration: none;">
                                        {{ attachment.name }}
                                    </a>
                                </div>
                                <div class="existing-attachment-type">
                                    Type: {% if attachment.type == 'file' %}üìÅ File{% elif attachment.type == 'link' %}üîó Link{% elif attachment.type == 'drive' %}üìÇ Google Drive{% else %}{{ attachment.type }}{% endif %}
                                </div>
                            </div>
                            <form method="POST" action="{{ url_for('admin.delete_attachment', assignment_id=assignment.id, attachment_index=loop.index0) }}" style="display: inline;">
                                <button type="submit" class="existing-attachment-delete" onclick="return confirm('Are you sure you want to delete this attachment?');">
                                    Delete
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">No existing attachments.</p>
                    {% endif %}
                    
                    <label class="form-label">Add New Attachments</label>
                    <div id="edit-attachments-container">
                        <!-- New attachments will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" id="edit-add-attachment-btn" style="margin-top: 0.5rem;">
                        + Add Attachment
                    </button>
                </div>

                <div class="late-exception-card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-2);">Late Submission Exceptions</h3>
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Grant individual students access to submit after the deadline. An optional extended deadline overrides the original deadline for that student.
                    </p>

                    {% if late_exceptions %}
                    <div style="overflow-x: auto;">
                        <table class="late-exception-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Extension Deadline</th>
                                    <th>Status</th>
                                    <th style="width: 140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in late_exceptions %}
                                <tr>
                                    <td>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 600;">{{ item.student.name or 'Unnamed' }}</span>
                                            <span style="font-size: 0.85rem; color: var(--color-text-secondary);">{{ item.student.email }}</span>
                                            <span style="font-size: 0.8rem; color: var(--color-text-secondary);">ID: {{ item.student.id }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.aware_deadline %}
                                        {{ item.aware_deadline.strftime('%B %d, %Y at %I:%M %p') }}
                                        {% else %}
                                        <em>No deadline</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_active %}
                                        <span class="late-exception-status-active">Active</span>
                                        {% else %}
                                        <span class="late-exception-status-expired">Expired</span>
                                        {% endif %}
                                    </td>
                                    <td class="late-exception-actions">
                                        <form method="POST" action="{{ url_for('admin.remove_late_exception', assignment_id=assignment.id, exception_id=item.exception.id) }}" onsubmit="return confirm('Remove late submission exception for {{ item.student.name or item.student.email }}?');">
                                            <input type="hidden" name="source" value="assignment_edit">
                                            <input type="hidden" name="exception_student_id" value="{{ item.student.id }}">
                                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem;">No late submission exceptions have been granted yet.</p>
                    {% endif %}

                    <form method="POST" action="{{ url_for('admin.add_late_exception', assignment_id=assignment.id) }}" class="late-exception-form">
                        <input type="hidden" name="source" value="assignment_edit">
                        <label for="student-identifier">Student ID or Email</label>
                        <input type="text" id="student-identifier" name="student_identifier" placeholder="e.g. 1024 or user@example.com" required>
                        <label for="extended-deadline">Extended Deadline (optional)</label>
                        <input type="datetime-local" id="extended-deadline" name="extended_deadline">
                        <button type="submit" class="btn btn-secondary">Grant Exception</button>
                    </form>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
    // Multi-select schools functionality
    const schoolDropdown = document.getElementById('dropdownListSchools');
    const schoolMultiSelect = document.getElementById('multiSelectSchools');
    const schoolInput = document.getElementById('multiInputSchools');
    const schoolHiddenInput = document.getElementById('selectedSchools');
    let selectedSchools = [];

    function toggleSchoolDropdown() {
        schoolDropdown.style.display = schoolDropdown.style.display === 'block' ? 'none' : 'block';
        if (schoolDropdown.style.display === 'block') {
            schoolInput.focus();
        }
    }

    function filterSchools() {
        const filter = schoolInput.value.toLowerCase();
        Array.from(schoolDropdown.children).forEach(option => {
            const isSelected = selectedSchools.some(s => s.id === option.dataset.id);
            if (isSelected) {
                option.style.display = 'none';
            } else {
                option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
            }
        });
        schoolDropdown.style.display = 'block';
    }

    schoolDropdown.addEventListener('click', (e) => {
        if (e.target.dataset.id) {
            const id = e.target.dataset.id;
            const name = e.target.textContent;
            if (!selectedSchools.find(s => s.id === id)) {
                selectedSchools.push({ id, name });
                renderSchoolTags();
            }
            schoolInput.value = '';
            filterSchools();
            schoolDropdown.style.display = 'none';
        }
    });

    function renderSchoolTags() {
        // Clear current tags, but keep the input
        while (schoolMultiSelect.firstChild && schoolMultiSelect.firstChild !== schoolInput) {
            schoolMultiSelect.removeChild(schoolMultiSelect.firstChild);
        }

        selectedSchools.forEach(s => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${s.name} <button type="button" onclick="removeSchoolTag('${s.id}')">√ó</button>`;
            schoolMultiSelect.insertBefore(tag, schoolInput);
        });
        schoolHiddenInput.value = selectedSchools.map(s => s.id).join(',');
    }

    function removeSchoolTag(id) {
        selectedSchools = selectedSchools.filter(s => s.id !== id);
        renderSchoolTags();
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
        if (!schoolMultiSelect.parentElement.contains(e.target)) {
            schoolDropdown.style.display = 'none';
        }
    });

    // Pre-populate selected schools if editing
    document.addEventListener('DOMContentLoaded', function () {
        const preselectedData = document.getElementById('preselected-schools-data');
        if (preselectedData) {
            try {
                selectedSchools = JSON.parse(preselectedData.textContent);
                renderSchoolTags();
            } catch (e) {
                console.error('Error parsing preselected schools data:', e);
            }
        }
    });

    function setupDropdown(dropdownId, btnId, listId, labelAll) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');
        const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) dropdown.classList.add('open');
        };

        if (allCheckbox) {
            allCheckbox.onchange = function () {
                if (allCheckbox.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
                updateBtnLabel();
            };
        }

        checkboxes.forEach(cb => {
            cb.onchange = function () {
                if (cb.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
                updateBtnLabel();
            };
        });

        function updateBtnLabel() {
            let selected = checkboxes.filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ‚ñº";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 20) + (selected[0].length > 20 ? '...' : '') + " ‚ñº";
            } else {
                btn.textContent = selected.length + " selected ‚ñº";
            }
        }
        updateBtnLabel();
    }

    document.addEventListener('click', function (e) {
        document.querySelectorAll('.multi.open').forEach(d => {
            if (!d.contains(e.target)) d.classList.remove('open');
        });
    });

    // Setup for multi-selects (keeping stages and groups with old system)
    setupDropdown('ms-stages', 'ms-stages-btn', 'ms-stages-list', 'All Stages');
    setupDropdown('ms-groups', 'ms-groups-btn', 'ms-groups-list', 'All Classes');

    // Setup for single-select (radio)
    const subjectDropdown = document.getElementById('ms-subjects');
    const subjectBtn = document.getElementById('ms-subjects-btn');
    const subjectList = document.getElementById('ms-subjects-list');

    if (subjectDropdown) {
        subjectBtn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = subjectDropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) subjectDropdown.classList.add('open');
        };
        subjectList.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.onchange = function () {
                const selectedLabel = this.parentElement.textContent.trim();
                subjectBtn.textContent = selectedLabel + " ‚ñº";
                subjectDropdown.classList.remove('open');
            };
        });
    }

    // ============================================
    // ATTACHMENT SYSTEM
    // ============================================
    let editAttachmentCounter = 0;

    function addAttachmentField(container, prefix = 'edit-', existingData = null) {
        const counter = ++editAttachmentCounter;
        const attachmentId = `${prefix}attachment-${counter}`;

        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.id = attachmentId;

        const defaultType = existingData ? existingData.type : 'file';
        const defaultName = existingData ? existingData.name : '';
        const defaultUrl = existingData && existingData.type === 'link' ? existingData.url : '';

        attachmentItem.innerHTML = `
            <div class="attachment-item-header">
                <span class="attachment-item-number">Attachment #${counter}</span>
                <button type="button" class="attachment-remove-btn" onclick="removeAttachment('${attachmentId}')">
                    Remove
                </button>
            </div>
            <div class="attachment-fields">
                <input type="text" 
                       name="new_attachments[${counter}][name]"
                       placeholder="Enter attachment name (e.g., Chapter 5 Notes)" 
                       class="form-input attachment-name-input"
                       value="${defaultName}"
                       required>
                
                <div class="attachment-type-selector">
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'file' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'file')">
                        üìÅ File Upload
                    </button>
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'link' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'link')">
                        üîó External Link
                    </button>
                    <button type="button" 
                            class="attachment-type-btn drive ${defaultType === 'drive' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'drive')">
                        üìÇ Google Drive
                    </button>
                </div>
                
                <div class="attachment-input-wrapper">
                    <input type="file" 
                           name="new_attachments[${counter}][file]"
                           class="form-input attachment-file-input"
                           style="display: ${defaultType === 'file' ? 'block' : 'none'};">
                    
                    <input type="url" 
                           name="new_attachments[${counter}][url]"
                           placeholder="https://example.com/resource" 
                           class="form-input attachment-link-input"
                           value="${defaultUrl}"
                           style="display: ${defaultType === 'link' ? 'block' : 'none'};">
                    
                    <div class="attachment-drive-input" style="display: ${defaultType === 'drive' ? 'block' : 'none'};">
                        <button type="button" 
                                class="btn btn-primary" 
                                onclick="openDrivePickerForAttachment('${attachmentId}')"
                                style="width: 100%;">
                            Select from Google Drive
                        </button>
                        <input type="hidden" 
                               name="new_attachments[${counter}][url]"
                               class="attachment-drive-link"
                               value="${defaultType === 'drive' ? defaultUrl : ''}">
                        <input type="hidden" 
                               name="new_attachments[${counter}][drive_token]"
                               class="attachment-drive-token"
                               value="">
                        <div class="attachment-drive-status" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;"></div>
                    </div>
                </div>
                
                <input type="hidden" 
                       name="new_attachments[${counter}][type]"
                       value="${defaultType}">
            </div>
        `;

        container.appendChild(attachmentItem);
    }

    window.removeAttachment = function (attachmentId) {
        const element = document.getElementById(attachmentId);
        if (element) {
            element.remove();
        }
    };

    window.toggleAttachmentType = function (attachmentId, type) {
        const attachmentItem = document.getElementById(attachmentId);
        if (!attachmentItem) return;

        const buttons = attachmentItem.querySelectorAll('.attachment-type-btn');
        const fileBtn = buttons[0];
        const linkBtn = buttons[1];
        const driveBtn = buttons[2];
        
        const fileInput = attachmentItem.querySelector('.attachment-file-input');
        const linkInput = attachmentItem.querySelector('.attachment-link-input');
        const driveInput = attachmentItem.querySelector('.attachment-drive-input');
        const typeInput = attachmentItem.querySelector('input[type="hidden"][name*="[type]"]');

        // Reset all buttons and inputs
        fileBtn.classList.remove('active');
        linkBtn.classList.remove('active');
        driveBtn.classList.remove('active');
        fileInput.style.display = 'none';
        linkInput.style.display = 'none';
        driveInput.style.display = 'none';

        if (type === 'file') {
            fileBtn.classList.add('active');
            fileInput.style.display = 'block';
            linkInput.value = '';
        } else if (type === 'link') {
            linkBtn.classList.add('active');
            linkInput.style.display = 'block';
            fileInput.value = '';
        } else if (type === 'drive') {
            driveBtn.classList.add('active');
            driveInput.style.display = 'block';
            fileInput.value = '';
            linkInput.value = '';
        }

        typeInput.value = type;
    };

    // Add attachment button click handler
    document.getElementById('edit-add-attachment-btn').addEventListener('click', function() {
        const container = document.getElementById('edit-attachments-container');
        addAttachmentField(container, 'edit-');
    });

    // ============================================
    // GOOGLE DRIVE PICKER INTEGRATION
    // ============================================
    
    const GOOGLE_CLIENT_ID = '409298735327-1ue4kf7g0f4se11vbjekple6t5bjq7jn.apps.googleusercontent.com';
    const GOOGLE_API_KEY = 'AIzaSyDKCt492H5f6_KvVLgbJ3YQyTt5JEzHZWY';
    const GOOGLE_APP_ID = '409298735327';
    const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    let tokenClient;
    let accessToken = null;
    let gapiReady = false;
    let gisReady = false;
    let currentAttachmentId = null;

    window.onload = function() {
        gapi.load('client:picker', initializeGapi);
        initializeGis();
    };

    function initializeGapi() {
        gapi.client.load('drive', 'v3', () => {
            gapiReady = true;
            console.log('Google Drive API loaded');
        });
    }

    function initializeGis() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: DRIVE_SCOPES,
            callback: handleAuthResponse
        });
        gisReady = true;
        console.log('Google Identity Services loaded');
    }

    function handleAuthResponse(response) {
        if (response.error) {
            alert(`Authorization failed: ${response.error}`);
            return;
        }
        accessToken = response.access_token;
        
        if (currentAttachmentId) {
            createPicker(currentAttachmentId);
        }
    }

    window.openDrivePickerForAttachment = function(attachmentId) {
        currentAttachmentId = attachmentId;
        
        if (!gapiReady || !gisReady) {
            alert('Google Drive API is still loading. Please try again.');
            return;
        }

        if (!accessToken) {
            tokenClient.requestAccessToken({ prompt: '' });
        } else {
            createPicker(attachmentId);
        }
    };

    function createPicker(attachmentId) {
        if (!accessToken) {
            alert('Please authorize Google Drive first');
            return;
        }

        const view = new google.picker.View(google.picker.ViewId.DOCS);
        
        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setAppId(GOOGLE_APP_ID)
            .setOAuthToken(accessToken)
            .setDeveloperKey(GOOGLE_API_KEY)
            .setCallback((data) => pickerCallback(data, attachmentId))
            .build();

        picker.setVisible(true);
    }

    async function pickerCallback(data, attachmentId) {
        if (data.action === google.picker.Action.PICKED) {
            const document = data[google.picker.Response.DOCUMENTS][0];
            const fileId = document[google.picker.Document.ID];
            
            const attachmentItem = document.getElementById(attachmentId);
            if (!attachmentItem) return;

            const statusDiv = attachmentItem.querySelector('.attachment-drive-status');
            statusDiv.textContent = 'Loading file information...';

            try {
                const response = await gapi.client.drive.files.get({
                    'fileId': fileId,
                    'fields': 'id, name, webViewLink, webContentLink'
                });

                const file = response.result;
                const fileLink = file.webViewLink || file.webContentLink;

                if (fileLink) {
                    const linkInput = attachmentItem.querySelector('.attachment-drive-link');
                    const tokenInput = attachmentItem.querySelector('.attachment-drive-token');
                    const nameInput = attachmentItem.querySelector('.attachment-name-input');

                    linkInput.value = fileLink;
                    tokenInput.value = accessToken;
                    
                    if (!nameInput.value) {
                        nameInput.value = file.name;
                    }

                    statusDiv.textContent = `‚úì Selected: ${file.name}`;
                    statusDiv.style.color = '#155724';
                } else {
                    statusDiv.textContent = 'Could not retrieve file link';
                    statusDiv.style.color = '#721c24';
                }
            } catch (err) {
                console.error('Error fetching file metadata:', err);
                statusDiv.textContent = 'Error fetching file information';
                statusDiv.style.color = '#721c24';
            }
        }
    }
</script>
{% endblock %}
