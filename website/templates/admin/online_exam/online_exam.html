{% extends "admin/dashboard.html" %}
{% block title %}Manage Exams{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* --- Page & Filter Layout --- */
    .container {
        padding-top: 1.5rem;
    }

    .filters-card {
        margin-bottom: 2rem;
    }

    .search-row-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    #searchInput {
        width: 100%;
        max-width: 800px;
        font-size: 1rem;
    }

    .filters-row-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
    }

    .filters-row-wrapper .filter-dropdown {
        min-width: 200px;
        flex-grow: 1;
    }

    .filter-dropdown.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .multi.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* --- Skeleton Loader --- */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.4rem;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .skeleton-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .skeleton-h3 {
        height: 1.5rem;
        width: 60%;
        margin-bottom: 1rem;
    }

    .skeleton-p {
        height: 1rem;
        width: 80%;
        margin-bottom: 0.5rem;
    }

    .skeleton-p.short {
        width: 40%;
    }

    .skeleton-footer {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .skeleton-badge {
        height: 1.5rem;
        width: 70px;
    }

    .skeleton-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1rem 0;
    }

    /* --- Multi-select dropdown styles for edit modal --- */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-size: 0.9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    #edit-ms-groups-container,
    #repost-ms-groups-container {
        position: relative;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }

    /* --- Settings Modal Styles --- */
    .settings-info {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .settings-info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .settings-info-item:last-child {
        border-bottom: none;
    }

    .settings-info-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .settings-info-value {
        color: #334155;
        font-size: 0.875rem;
        text-align: right;
    }

    .settings-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .settings-action-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
        text-align: left;
    }

    .settings-action-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        transform: translateX(4px);
    }

    .settings-action-btn.edit-action:hover {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .settings-action-btn.toggle-action:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #f59e0b;
    }

    .settings-action-btn.delete-action:hover {
        background: #fef2f2;
        border-color: #ef4444;
        color: #ef4444;
    }

    .settings-action-btn svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    /* --- Attachment System Styles --- */
    .attachment-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        position: relative;
    }

    .attachment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .attachment-item-number {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .attachment-remove-btn {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        color: #ef4444;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .attachment-remove-btn:hover {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .attachment-fields {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .attachment-name-input {
        width: 100%;
    }

    .attachment-type-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .attachment-type-btn {
        flex: 1;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .attachment-type-btn.active {
        background: #eef2ff;
        border-color: #4338ca;
        color: #4338ca;
    }

    .attachment-input-wrapper {
        position: relative;
    }

    .attachment-file-input,
    .attachment-link-input {
        width: 100%;
    }

    #add-attachment-btn {
        background: #fff;
        border: 2px dashed #cbd5e1;
        color: #64748b;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    #add-attachment-btn:hover {
        border-color: #94a3b8;
        background: #f8fafc;
        color: #475569;
    }

    /* --- NEW Google Drive Button Style --- */
    .btn-google-drive {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background-color: #fff;
        color: #444;
        border: 1px solid #ddd;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 0.5rem;
        width: 100%;
    }

    .btn-google-drive:hover {
        background-color: #f8f8f8;
        border-color: #ccc;
    }

    .btn-google-drive img {
        width: 18px;
        height: 18px;
    }
    /* ------------------------------------- */

    .existing-attachment-item {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .existing-attachment-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .existing-attachment-name {
        font-weight: 600;
        color: #0c4a6e;
    }

    .existing-attachment-type {
        font-size: 0.75rem;
        color: #0284c7;
        text-transform: uppercase;
    }

    .existing-attachment-delete {
        color: #ef4444;
        text-decoration: none;
        font-weight: 500;
        padding: 0.25rem 0.75rem;
        border: 1px solid #ef4444;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .existing-attachment-delete:hover {
        background: #ef4444;
        color: #fff;
    }

    /* --- Exams Grid & Cards --- */
    .exams-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .exam-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        cursor: pointer;
        overflow: hidden;
    }

    .exam-card.hidden-exam {
        opacity: 0.7;
        background-color: #fafafa;
    }

    .exam-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .card-main-content {
        padding: 1.5rem;
        flex-grow: 1;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .exam-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-primary, #333);
        margin: 0;
    }

    .exam-due {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #666);
        margin-top: 0.25rem;
    }

    .card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .detail-item {
        color: var(--color-text-secondary, #666);
    }

    .detail-item strong {
        display: block;
        color: var(--color-text, #333);
        margin-bottom: 0.15rem;
    }

    .card-actions {
        position: relative;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-footer {
        border-top: 1px solid var(--color-border, #e0e0e0);
        background-color: #f9fafb;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-around;
        text-align: center;
    }

    .stat-item .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        display: block;
    }

    .stat-item .stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--color-text-secondary, #666);
    }

    .stat-value.green {
        color: var(--color-success, #28a745);
    }

    .stat-value.red {
        color: var(--color-danger, #dc3545);
    }

    /* --- No Exams Message --- */
    .no-exams-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        color: var(--color-text-secondary, #666);
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .filters-row-wrapper .filter-dropdown {
            min-width: 150px;
        }
    }

    @media (max-width: 600px) {
        .filters-row-wrapper {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .exams-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .card-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">{% if filter_group_id %}{{ group.name }} Exams{% else %}All Exams{% endif %}</h1>
        <button id="openAddExamDesktop" class="btn btn-primary">Create Exam</button>
    </div>
</header>

<main class="container">
    <div class="card filters-card">
        <div class="card-content">
            <div class="search-row-wrapper">
                <input type="text" id="searchInput" class="form-input" placeholder="Search by exam title..." disabled>
            </div>
            {% if not filter_group_id %}
            <div class="filters-row-wrapper">
                <div class="filter-dropdown disabled" id="schoolDropdown">
                    <button type="button" class="btn form-input filter-dropdown-btn" id="schoolDropdownBtn">All Groups
                        ‚ñº</button>
                    <div class="filter-dropdown-list" id="schoolDropdownList">
                        <label class="dropdown-all"><input type="checkbox" value="" checked>All Groups</label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="examsGrid" class="exams-grid">
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
    </div>
</main>

<div id="examModal" class="modal-overlay">
    <div class="modal-content">
        <form method="POST" enctype="multipart/form-data">
            {% if filter_group_id %}
            <input type="hidden" name="locked_group_id" value="{{ filter_group_id }}">
            {% endif %}
            <div class="modal-header">
                <h2>Add New Exam</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <label class="form-label">Title</label>
                    <input type="text" name="title" required placeholder="e.g., Midterm Exam" class="form-input">
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea name="description" rows="4" placeholder="Provide instructions, topics, or details here..."
                        class="form-textarea"></textarea>
                </div>

                <div>
                    <label class="form-label">
                        <input type="checkbox" name="student_whatsapp" value="true" checked>
                        Send WhatsApp notification to student
                    </label>
                </div>
                <div>
                    <label class="form-label">
                        <input type="checkbox" name="parent_whatsapp" value="true" checked>
                        Send WhatsApp notification to parent
                    </label>
                </div>

                <div>
                    <label class="form-label">
                        <input type="checkbox" name="close_after_deadline" value="true" checked>
                        Close after deadline (Disable submissions after deadline)
                    </label>
                </div>
                <div>
                    <label class="form-label">Out of</label>
                    <input type="number" name="out_of" placeholder="e.g., 100 (leave empty for ungraded exam)"
                        class="form-input">
                </div>
                <div>
                    <label class="form-label">Group</label>
                    {% if filter_group_id %}
                    <div class="form-input" style="background-color: #f0f0f0; cursor: not-allowed; opacity: 0.7;">
                        {{ group.name }}
                    </div>
                    <input type="hidden" name="groups[]" value="{{ filter_group_id }}">
                    {% else %}
                    <div class="multi" id="ms-schools">
                        <button type="button" class="btn form-input multi-btn" id="ms-schools-btn">All Groups
                            ‚ñº</button>
                        <div class="multi-list" id="ms-schools-list">
                            <label class="multi-all"><input type="checkbox" value="" checked>All Groups</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <label class="form-label">Exam Date</label>
                    <input type="datetime-local" name="deadline_date" required class="form-input">
                </div>
                <div>
                    <label class="form-label">Attachments</label>
                    <div id="attachments-container">
                        <!-- Dynamic attachment fields will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" id="add-attachment-btn" style="margin-top: 0.5rem;">
                        + Add Attachment
                    </button>
                    <!-- NEW GOOGLE DRIVE BUTTON -->
                    <button type="button" class="btn btn-google-drive" id="add-drive-attachment-btn">
                        <img src="https://www.google.com/images/icons/product/drive-32.png" alt="Google Drive icon">
                        Choose from Google Drive
                    </button>
                    <!-- END NEW BUTTON -->
                </div>
                <div>
                    <label class="form-label">Points (Optional)</label>
                    <input type="number" name="points" placeholder="0" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Exam Modal -->
<div id="editExamModal" class="modal-overlay">
    <div class="modal-content">
        <form id="editExamForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Edit Exam</h2>
                <button type="button" class="modal-close" id="editModalClose">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Skeleton loader will be shown initially -->
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="editModalFooter" style="display: none;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Exam Settings</h2>
            <button type="button" class="modal-close" id="settingsModalClose">&times;</button>
        </div>
        <div class="modal-body" id="settingsModalBody">
            <!-- Skeleton loader will be shown initially -->
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        </div>
    </div>
</div>

<!-- Repost Exam Modal -->
<div id="repostExamModal" class="modal-overlay">
    <div class="modal-content">
        <form id="repostExamForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Repost Exam</h2>
                <button type="button" class="modal-close" id="repostModalClose">&times;</button>
            </div>
            <div class="modal-body" id="repostModalBody">
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="repostModalFooter" style="display: none;">
                <button type="button" class="btn btn-secondary" id="repostModalCancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Repost Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- NEW GOOGLE API SCRIPTS -->
<!-- IMPORTANT: Load these *before* your main examsScript -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<!-- END GOOGLE API SCRIPTS -->

<script id="examsScript" data-filter-group-id="{% if filter_group_id %}{{ filter_group_id }}{% endif %}">
    
    // --- NEW GOOGLE DRIVE PICKER CONFIG ---
    // !!! ACTION REQUIRED: Fill these in with your credentials from Google Cloud Console
    const GOOGLE_CLIENT_ID = 'YOUR_NEW_WEB_APP_CLIENT_ID.apps.googleusercontent.com'; // The "Web application" Client ID
    const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY_HERE'; // The one starting with 'AIza...'
    const GOOGLE_APP_ID = 'YOUR_NEW_NUMERIC_APP_ID'; // The numeric part of the Client ID

    // We need full drive access to change permissions
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive';

    let googleTokenClient = null;
    let googleAccessToken = null;
    let googleGapiReady = false;
    let googleGisReady = false;
    let pendingPickerRequest = null; // Stores the picker request if auth is needed
    // --- END NEW GOOGLE DRIVE PICKER CONFIG ---

    // Global state
    let allExams = [];
    let groups = [];
    let isLoading = true;
    let currentEditingExamId = null;
    const filterGroupId = document.getElementById('examsScript').dataset.filterGroupId ? parseInt(document.getElementById('examsScript').dataset.filterGroupId) : null;

    // --- Modal Logic ---
    const modal = document.getElementById('examModal');
    const editModal = document.getElementById('editExamModal');
    const settingsModal = document.getElementById('settingsModal');
    const repostModal = document.getElementById('repostExamModal');
    const openModalBtns = [document.getElementById('openAddExamDesktop')];
    const closeModalBtn = document.querySelector('#examModal .modal-close'); // Be specific
    const editModalCloseBtn = document.getElementById('editModalClose');
    const settingsModalCloseBtn = document.getElementById('settingsModalClose');
    const repostModalCloseBtn = document.getElementById('repostModalClose');
    const repostModalCancelBtn = document.getElementById('repostModalCancelBtn');

    openModalBtns.forEach(btn => {
        if (btn) btn.onclick = () => { 
            modal.classList.add('show'); 
            // Reset attachments when opening modal
            document.getElementById('attachments-container').innerHTML = '';
            attachmentCounter = 0;
        };
    });
    if (closeModalBtn) closeModalBtn.onclick = () => { modal.classList.remove('show'); };
    if (editModalCloseBtn) editModalCloseBtn.onclick = () => { editModal.classList.remove('show'); };
    if (settingsModalCloseBtn) settingsModalCloseBtn.onclick = () => { settingsModal.classList.remove('show'); };
    if (repostModalCloseBtn) repostModalCloseBtn.onclick = () => { repostModal.classList.remove('show'); };
    if (repostModalCancelBtn) repostModalCancelBtn.onclick = () => { repostModal.classList.remove('show'); };

    modal.onclick = e => {
        if (e.target === modal) modal.classList.remove('show');
    };
    editModal.onclick = e => {
        if (e.target === editModal) editModal.classList.remove('show');
    };
    settingsModal.onclick = e => {
        if (e.target === settingsModal) settingsModal.classList.remove('show');
    };
    repostModal.onclick = e => {
        if (e.target === repostModal) repostModal.classList.remove('show');
    };

    // --- Attachment Management System ---
    let attachmentCounter = 0;
    let editAttachmentCounter = 0;
    let repostAttachmentCounter = 0;

    function addAttachmentField(container, prefix = '', existingData = null) {
        let counter;
        if (prefix === 'edit-') {
            counter = ++editAttachmentCounter;
        } else if (prefix === 'repost-') {
            counter = ++repostAttachmentCounter;
        } else {
            counter = ++attachmentCounter;
        }
        
        const attachmentId = `${prefix}attachment-${counter}`;

        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.id = attachmentId;

        const defaultType = existingData ? existingData.type : 'file';
        const defaultName = existingData ? existingData.name : '';
        const defaultUrl = existingData && existingData.type === 'link' ? existingData.url : '';

        attachmentItem.innerHTML = `
            <div class="attachment-item-header">
                <span class="attachment-item-number">Attachment #${counter}</span>
                <button type="button" class="attachment-remove-btn" onclick="removeAttachment('${attachmentId}')">
                    Remove
                </button>
            </div>
            <div class="attachment-fields">
                <input type="text" 
                       name="${prefix}attachment_name_${counter}" 
                       placeholder="Enter attachment name (e.g., Exam Instructions)" 
                       class="form-input attachment-name-input"
                       value="${defaultName}"
                       required>
                
                <div class="attachment-type-selector">
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'file' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'file')">
                        üìÅ File Upload
                    </button>
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'link' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'link')">
                        üîó External Link
                    </button>
                </div>
                
                <div class="attachment-input-wrapper">
                    <input type="file" 
                           name="${prefix}attachment_file_${counter}" 
                           class="form-input attachment-file-input"
                           style="display: ${defaultType === 'file' ? 'block' : 'none'};">
                    
                    <input type="url" 
                           name="${prefix}attachment_link_${counter}" 
                           placeholder="https://example.com/resource" 
                           class="form-input attachment-link-input"
                           value="${defaultUrl}"
                           style="display: ${defaultType === 'link' ? 'block' : 'none'};">
                </div>
                
                <input type="hidden" 
                       name="${prefix}attachment_type_${counter}" 
                       value="${defaultType}">
            </div>
        `;

        container.appendChild(attachmentItem);

        // If data came from Drive, ensure the 'link' view is active
        if (existingData && existingData.type === 'link') {
            toggleAttachmentType(attachmentId, 'link');
        }
    }

    // Make removeAttachment globally available
    window.removeAttachment = function (attachmentId) {
        const element = document.getElementById(attachmentId);
        if (element) {
            element.remove();
        }
    };

    // Make toggleAttachmentType globally available
    window.toggleAttachmentType = function (attachmentId, type) {
        const attachmentItem = document.getElementById(attachmentId);
        if (!attachmentItem) return;

        const fileBtn = attachmentItem.querySelector('.attachment-type-btn:first-child');
        const linkBtn = attachmentItem.querySelector('.attachment-type-btn:last-child');
        const fileInput = attachmentItem.querySelector('.attachment-file-input');
        const linkInput = attachmentItem.querySelector('.attachment-link-input');
        const typeInput = attachmentItem.querySelector('input[type="hidden"]');

        if (type === 'file') {
            fileBtn.classList.add('active');
            linkBtn.classList.remove('active');
            fileInput.style.display = 'block';
            linkInput.style.display = 'none';
            // Do not clear linkInput.value if pre-filled
        } else {
            fileBtn.classList.remove('active');
            linkBtn.classList.add('active');
            fileInput.style.display = 'none';
            linkInput.style.display = 'block';
            fileInput.value = ''; // Clear file input
        }

        typeInput.value = type;
    };

    // Add attachment button event listeners using event delegation
    document.addEventListener('click', function (e) {
        // Handle add attachment button for main modal
        if (e.target && e.target.id === 'add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('attachments-container');
            if (container) addAttachmentField(container);
        }

        // Handle add attachment button for edit modal
        if (e.target && e.target.id === 'edit-add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('edit-attachments-container');
            if (container) addAttachmentField(container, 'edit-');
        }

        // --- NEW GOOGLE DRIVE BUTTON HANDLERS ---
        if (e.target && e.target.id === 'add-drive-attachment-btn') {
            e.preventDefault();
            // Pass the ID of the container where the attachment field should be added
            initiatePicker('attachments-container');
        }

        if (e.target && e.target.id === 'edit-add-drive-attachment-btn') {
            e.preventDefault();
            // Pass the ID of the edit modal's container
            initiatePicker('edit-attachments-container');
        }
        // --- END NEW GOOGLE DRIVE BUTTON HANDLERS ---
    });

    // --- Dropdown/Multiselect Logic ---
    function setupDropdown(dropdownId, btnId, listId, labelAll, updateCallback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');

        const getCheckboxes = () => Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            if (dropdown.classList.contains('disabled')) return;
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.filter-dropdown, .multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) {
                dropdown.classList.add('open');
            }
        };

        const updateHandler = function () {
            const checkboxes = getCheckboxes();
            if (this.value === "") { // "All" checkbox
                if (this.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
            } else { // Specific item checkbox
                if (this.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                // If no specific items are checked, check "All"
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
            }
            updateBtnLabel();
            if (updateCallback) updateCallback();
        };

        list.addEventListener('change', e => {
            if (e.target.type === 'checkbox') {
                updateHandler.call(e.target);
            }
        });

        function updateBtnLabel() {
            let selected = getCheckboxes().filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ‚ñº";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 15) + (selected[0].length > 15 ? '...' : '') + " ‚ñº";
            } else {
                btn.textContent = selected.length + " selected ‚ñº";
            }
        }
        updateBtnLabel(); // Initial setup
    }

    // Close dropdowns on outside click
    document.addEventListener('click', function (e) {
        document.querySelectorAll('.filter-dropdown.open, .multi.open').forEach(d => {
            if (!d.contains(e.target)) {
                d.classList.remove('open');
            }
        });
    });

    // --- Toast utility ---
    function showToast(message, type = 'info', opts = {}) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.position = 'fixed';
            container.style.right = '1rem';
            container.style.bottom = '1rem';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '0.5rem';
            container.style.zIndex = '9999';
            container.style.pointerEvents = 'none';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.minWidth = '260px';
        toast.style.maxWidth = '92vw';
        toast.style.background = type === 'success' ? '#065f46' : type === 'error' ? '#7f1d1d' : '#1e3a8a';
        toast.style.color = '#f9fafb';
        toast.style.borderRadius = '8px';
        toast.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
        toast.style.padding = '0.75rem 1rem';
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.gap = '0.5rem';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(8px)';
        toast.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        toast.style.pointerEvents = 'auto';
        const msg = document.createElement('div');
        msg.textContent = message;
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úï';
        closeBtn.style.background = 'transparent';
        closeBtn.style.border = 'none';
        closeBtn.style.color = 'inherit';
        closeBtn.style.fontSize = '1.1rem';
        closeBtn.style.lineHeight = '1';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.padding = '0.25rem';
        closeBtn.style.borderRadius = '0.25rem';
        const removeToast = () => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 200); };
        closeBtn.onclick = removeToast;
        toast.appendChild(msg);
        toast.appendChild(closeBtn);
        container.appendChild(toast);
        void toast.offsetHeight; // Force reflow to trigger animation
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        const duration = typeof opts.duration === 'number' ? opts.duration : 3500;
        const timer = setTimeout(removeToast, duration);
        toast.addEventListener('mouseenter', () => clearTimeout(timer)); // Pause timer on hover
    }

    // --- GENERAL ACTION CONFIRMATION (Promise-based, no form submit) ---
    function confirmAction(event, message) {
        if (event && event.preventDefault) {
            event.preventDefault();
        }
        // Check if Swal is defined before using it
        if (typeof Swal !== 'undefined') {
            return Swal.fire({
                title: "Confirm Action",
                html: message,
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "var(--button-bg, #3085d6)",
                cancelButtonColor: "var(--flash-danger-bg, #d33)",
                confirmButtonText: "Yes, proceed",
                cancelButtonText: "No, cancel",
                background: "var(--card-bg, #fff)",
                color: "var(--text-color, #333)",
            }).then((result) => {
                return result.isConfirmed;
            });
        } else {
            // Fallback to simple confirm if Swal is not available
            return Promise.resolve(window.confirm(message));
        }
    }

    // --- NEW GOOGLE DRIVE PICKER FUNCTIONS ---

    /**
     * Called by DOMContentLoaded. Loads Google APIs and token from localStorage.
     */
    function initGoogleAuth() {
        // Load token from local storage
        googleAccessToken = localStorage.getItem('googleAuthToken');

        // Load Google GAPI (for Picker and Drive API)
        if (typeof gapi !== 'undefined') {
            gapi.load('client:picker', gapiLoadedCallback);
        } else {
            console.error('gapi.js failed to load.');
        }

        // Load Google GIS (for Auth)
        if (typeof google !== 'undefined' && google.accounts) {
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: () => {} // Not used for token client
            });
            gisLoadedCallback();
        } else {
            console.error('gsi/client failed to load.');
        }
    }

    /**
     * GAPI library is ready. Loads the 'drive' API.
     */
    function gapiLoadedCallback() {
        // We load 'drive' v3, which includes 'files' and 'permissions'
        gapi.client.load('drive', 'v3', () => {
            googleGapiReady = true;
            console.log('Google Drive API (v3) loaded.');
        });
    }

    /**
     * GIS library is ready. Initializes the token client.
     */
    function gisLoadedCallback() {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES, // Using the new, more powerful scope
            callback: handleAuthResult, // This function is called after user signs in
        });
        googleGisReady = true;
        console.log('Google Identity Services (GIS) initialized.');
    }

    /**
     * Called when user clicks a Drive button.
     * Stores the target container and attempts to create the picker.
     */
    function initiatePicker(targetContainerId) {
        console.log('Initiating picker for container:', targetContainerId);
        if (!googleGapiReady || !googleGisReady) {
            showToast('Google API is still loading. Please try again in a moment.', 'info');
            return;
        }

        // Store the target container ID for the auth callback
        pendingPickerRequest = targetContainerId;
        
        if (googleAccessToken) {
            console.log('Access token found, creating picker...');
            // If we have a token, try to create the picker
            createPicker(targetContainerId);
        } else {
            console.log('No access token, requesting auth...');
            // If we don't have a token, request one
            handleAuthClick();
        }
    }

    /**
     * Forces the Google Sign-In prompt.
     */
    function handleAuthClick() {
        if (googleTokenClient) {
            console.log('Requesting Google access token...');
            // 'consent' is needed to ensure they approve the new 'drive' scope if needed
            googleTokenClient.requestAccessToken({ prompt: 'consent' }); 
        } else {
            console.error('Google Token Client not initialized.');
            showToast('Google Auth is not ready. Please refresh.', 'error');
        }
    }

    /**
     * Callback function after user authorizes.
     * Saves the token and retries the picker.
     */
    function handleAuthResult(response) {
        console.log('Auth result received:', response);
        if (response.error) {
            showToast(`Google Auth Error: ${response.error}`, 'error');
            pendingPickerRequest = null; // Clear the pending request
            return;
        }
        
        // Save the new token
        googleAccessToken = response.access_token;
        localStorage.setItem('googleAuthToken', googleAccessToken);
        console.log('Google access token saved to localStorage.');

        // If a picker was waiting for auth, launch it now
        if (pendingPickerRequest) {
            console.log('Pending picker request found, creating picker now...');
            createPicker(pendingPickerRequest);
            pendingPickerRequest = null; // Clear the request
        }
    }

    /**
     * Creates and displays the Google Picker.
     * Assumes `googleAccessToken` is valid.
     */
    function createPicker(targetContainerId) {
        if (!googleAccessToken) {
            console.warn('createPicker called without access token. Re-initiating auth.');
            // This shouldn't be called without a token, but as a safeguard:
            initiatePicker(targetContainerId);
            return;
        }
        if (!google.picker) {
            console.error('Google Picker API not loaded.');
            showToast('Picker API failed to load. Please refresh.', 'error');
            return;
        }

        console.log('Creating Google Picker...');
        const view = new google.picker.View(google.picker.ViewId.DOCS);
        const picker = new google.picker.PickerBuilder()
            .setAppId(GOOGLE_APP_ID)
            .setDeveloperKey(GOOGLE_API_KEY)
            .setOAuthToken(googleAccessToken) // Use the stored token
            .addView(view)
            .setCallback((data) => pickerCallback(data, targetContainerId)) // Pass containerId to callback
            .build();
        
        picker.setVisible(true);
        console.log('Google Picker is visible.');
    }
    
    /**
     * Helper function to handle Google API errors (like 401/403)
     */
    async function handleGoogleApiError(err, targetContainerId) {
        console.error('Google API Error:', err);
        if (err.status === 401 || err.status === 403) {
            // Token expired or insufficient permissions!
            showToast('Google session expired or needs new permissions. Please sign in again.', 'error');
            localStorage.removeItem('googleAuthToken'); // Clear bad token
            googleAccessToken = null;
            // Ask user to re-auth and store this request
            pendingPickerRequest = targetContainerId;
            handleAuthClick(); // This will re-prompt for the NEW scopes
        } else {
            showToast(`An error occurred: ${err.result?.error?.message || 'Check console.'}`, 'error');
        }
    }


    /**
     * Handles the callback when the user interacts with the Picker.
     * Includes logic to auto-share the file.
     */
    async function pickerCallback(data, targetContainerId) {
        console.log('Picker callback data:', data);
        if (data.action === google.picker.Action.PICKED) {
            const doc = data[google.picker.Response.DOCUMENTS][0];
            const fileId = doc[google.picker.Document.ID];
            
            showToast('File selected. Fetching link and updating permissions...', 'info');

            let file;
            try {
                // Step 1: Get file metadata
                console.log(`Fetching metadata for fileId: ${fileId}`);
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    fields: 'id, name, webViewLink' // webViewLink is the user-friendly link
                });
                file = response.result;
                console.log('File metadata fetched:', file);

            } catch (err) {
                console.error(`Error fetching metadata for fileId ${fileId}:`, err);
                return handleGoogleApiError(err, targetContainerId); // Auth error or file not found
            }

            try {
                // Step 2: Make the file public (anyone with link can read)
                console.log(`Attempting to set permissions for fileId: ${fileId}`);
                await gapi.client.drive.permissions.create({
                    fileId: fileId,
                    resource: {
                        'role': 'reader',
                        'type': 'anyone'
                    }
                });
                console.log(`Permissions set successfully for fileId: ${fileId}`);
                showToast('File successfully made public!', 'success');

            } catch (err) {
                console.error(`Error setting permissions for fileId ${fileId}:`, err);
                // Check if it's an auth error (401/403)
                if (err.status === 401 || err.status === 403) {
                    return handleGoogleApiError(err, targetContainerId);
                }
                // If it's a different error (e.g., user doesn't own file, domain policy)
                // just warn them and add the file anyway. The link might not work publicly.
                showToast('Could not auto-share file. Please share it manually from Google Drive.', 'error');
            }

            // Step 3: Add the attachment to the UI
            const link = file.webViewLink; // Use the webViewLink
            const name = file.name;
            const container = document.getElementById(targetContainerId);
            // Determine prefix based on the container ID (for edit vs. add modal)
            const prefix = (targetContainerId === 'edit-attachments-container') ? 'edit-' : '';

            if (container) {
                console.log(`Adding attachment field to container '${targetContainerId}' with prefix '${prefix}'`);
                // Call your existing function to add the attachment field, pre-filled
                addAttachmentField(container, prefix, {
                    type: 'link', // Set type to 'link'
                    name: name,   // Pre-fill name
                    url: link     // Pre-fill URL
                });
            } else {
                console.error(`Target container '${targetContainerId}' not found.`);
            }

        } else if (data.action === google.picker.Action.CANCEL) {
            console.log('Picker cancelled by user.');
            showToast('File selection cancelled.', 'info');
        }
    }

    // --- END NEW GOOGLE DRIVE PICKER FUNCTIONS ---


    // --- API Calls ---
    async function fetchExams() {
        try {
            let url = '/admin/api/exams-data';
            if (filterGroupId) {
                url += `?group_id=${filterGroupId}`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch exams');
            const data = await response.json();
            return data || [];
        } catch (error) {
            console.error('Error fetching exams:', error);
            return [];
        }
    }

    // --- Intercept form submit to POST without refresh ---
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('#examModal form');
        if (!form) return;
        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Posting...'; }
            try {
                const formData = new FormData(form);

                // Process attachments (Your existing logic seems correct)
                const attachmentItems = document.querySelectorAll('#attachments-container .attachment-item');
                let attachmentCount = 0;
                attachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counterMatch = itemId.match(/(\d+)$/); // Get trailing number
                    if (!counterMatch) return;
                    const counter = counterMatch[1];

                    const nameInput = item.querySelector(`input[name="attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`attachments[${attachmentCount}][name]`, nameInput.value);
                        formData.append(`attachments[${attachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`attachments[${attachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`attachments[${attachmentCount}][url]`, linkInput.value);
                        }
                        attachmentCount++;
                    }
                });

                const resp = await fetch('/admin/online/exam', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.success && data.exam) {
                    allExams.unshift(data.exam);
                    filterExams();
                    modal.classList.remove('show');
                    form.reset();
                    document.getElementById('attachments-container').innerHTML = ''; // Clear attachments
                    attachmentCounter = 0; // Reset counter
                    const msSchoolsBtn = document.getElementById('ms-schools-btn');
                    if (msSchoolsBtn) {
                        msSchoolsBtn.textContent = 'All Groups ‚ñº'; // Reset dropdown label
                    }
                    showToast(data.message || 'Exam created successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to create exam', 'error');
                }
            } catch (err) {
                console.error('Create exam failed', err);
                showToast('Failed to create exam', 'error');
            } finally {
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Add Exam'; }
            }
        });
    });

    async function fetchFilters() {
        try {
            const response = await fetch('/admin/api/filters');
            if (!response.ok) throw new Error('Failed to fetch filters');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching filters:', error);
            return { groups: [] }; // Return default structure on error
        }
    }

    // --- SETTINGS MODAL FUNCTION ---
    async function openSettingsModal(examId) {
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalBody = document.getElementById('settingsModalBody');

        settingsModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>`;
        settingsModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/exam/${examId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch exam data', 'error');
                settingsModal.classList.remove('show');
                return;
            }

            const exam = data.exam;
            const createdAt = exam.created_at ? exam.created_at : 'N/A';
            const modifiedAt = exam.last_edited_at ? exam.last_edited_at : 'N/A';
            const createdBy = exam.created_by || 'N/A';
            const modifiedBy = exam.last_edited_by || 'N/A';
            const currentStatus = exam.status === 'Show' ? 'Visible' : 'Hidden';
            const toggleAction = exam.status === 'Show' ? 'Hide' : 'Show';

            settingsModalBody.innerHTML = `
                <div class="settings-info">
                    <div class="settings-info-item"><span class="settings-info-label">Created By:</span><span class="settings-info-value">${escapeHtml(String(createdBy))}</span></div>
                    <div class="settings-info-item"><span class="settings-info-label">Created At:</span><span class="settings-info-value">${createdAt}</span></div>
                    <div class="settings-info-item"><span class="settings-info-label">Last Modified By:</span><span class="settings-info-value">${escapeHtml(String(modifiedBy))}</span></div>
                    <div class="settings-info-item"><span class="settings-info-label">Last Modified At:</span><span class="settings-info-value">${modifiedAt}</span></div>
                    <div class="settings-info-item"><span class="settings-info-label">Status:</span><span class="settings-info-value">${currentStatus}</span></div>
                </div>
                <div class="settings-actions">
                    <button class="settings-action-btn edit-action" data-action="edit" data-id="${exam.id}">...</button>
                    <button class="settings-action-btn edit-action" data-action="repost" data-id="${exam.id}">...</button>
                    <button class="settings-action-btn toggle-action" data-action="toggle" data-id="${exam.id}">...</button>
                    <button class="settings-action-btn delete-action" data-action="delete" data-id="${exam.id}">...</button>
                </div>`; // SVGs omitted for brevity, assume they are correct

            // Add event listeners (Your existing logic seems correct)
             settingsModalBody.querySelectorAll('.settings-action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const action = btn.getAttribute('data-action');
                    const id = btn.getAttribute('data-id');

                    if (action === 'edit') {
                        settingsModal.classList.remove('show');
                        openEditModal(parseInt(id));
                    } else if (action === 'repost') {
                         settingsModal.classList.remove('show');
                         // TODO: Implement openRepostModal if needed for exams
                         console.warn("Repost functionality not fully implemented for exams yet.");
                    } else if (action === 'delete') {
                        const confirmed = await confirmAction(e, 'Are you sure you want to delete this exam? This cannot be undone.');
                        if (!confirmed) return;
                        settingsModal.classList.remove('show');
                        try {
                            const resp = await fetch(`/admin/online/exam/delete/${id}`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                            const data = await resp.json().catch(() => ({}));
                            if (resp.ok && data.success) {
                                allExams = allExams.filter(e => String(e.id) !== String(id));
                                filterExams();
                                showToast(data.message || 'Exam deleted', 'success');
                            } else { showToast((data && data.message) || 'Failed to delete exam', 'error'); }
                        } catch (err) { console.error('Delete failed', err); showToast('Failed to delete exam', 'error'); }

                    } else if (action === 'toggle') {
                         const confirmed = await confirmAction(e, `Are you sure you want to ${exam.status === 'Show' ? 'hide' : 'show'} this exam?`);
                         if (!confirmed) return;
                         settingsModal.classList.remove('show');
                         try {
                            const resp = await fetch(`/admin/online/exam/toggle/${id}`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                            const data = await resp.json().catch(() => ({}));
                            if (resp.ok && data.success) {
                                const idx = allExams.findIndex(e => String(e.id) === String(id));
                                if (idx >= 0) { allExams[idx].status = data.status; }
                                filterExams(); // Re-render to show status change
                                showToast(data.message || 'Visibility updated', 'success');
                            } else { showToast((data && data.message) || 'Failed to update visibility', 'error'); }
                        } catch (err) { console.error('Toggle failed', err); showToast('Failed to update visibility', 'error'); }
                    }
                });
            });

        } catch (error) {
            console.error('Error opening settings modal:', error);
            showToast('Failed to load exam settings', 'error');
            settingsModal.classList.remove('show');
        }
    }

    // --- EDIT EXAM FUNCTIONS ---
    async function openEditModal(examId) {
        currentEditingExamId = examId;
        const editModal = document.getElementById('editExamModal');
        const editModalBody = document.getElementById('editModalBody');
        const editModalFooter = document.getElementById('editModalFooter');

        editModalBody.innerHTML = `<!-- Skeleton -->`; // Show skeleton
        editModalFooter.style.display = 'none';
        editModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/exam/${examId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch exam data', 'error');
                editModal.classList.remove('show');
                return;
            }

            populateEditForm(data.exam); // Populate form with data
            editModalFooter.style.display = 'flex'; // Show footer
        } catch (error) {
            console.error('Error opening edit modal:', error);
            showToast('Failed to load exam data', 'error');
            editModal.classList.remove('show');
        }
    }

    function populateEditForm(exam) {
        const editModalBody = document.getElementById('editModalBody');
        editAttachmentCounter = 0; // Reset counter for new attachments

        editModalBody.innerHTML = `
            <div><label class="form-label">Title</label><input type="text" name="title" required value="${escapeHtml(exam.title || '')}" class="form-input"></div>
            <div><label class="form-label">Description</label><textarea name="description" rows="4" class="form-textarea">${escapeHtml(exam.description || '')}</textarea></div>
            <div><label class="form-label"><input type="checkbox" name="student_whatsapp" value="true" ${exam.student_whatsapp ? 'checked' : ''}> Send WhatsApp to student</label></div>
            <div><label class="form-label"><input type="checkbox" name="parent_whatsapp" value="true" ${exam.parent_whatsapp ? 'checked' : ''}> Send WhatsApp to parent</label></div>
            <div><label class="form-label"><input type="checkbox" name="close_after_deadline" value="true" ${exam.close_after_deadline ? 'checked' : ''}> Close after deadline</label></div>
            <div><label class="form-label">Out of</label><input type="number" name="out_of" placeholder="0" value="${exam.out_of || ''}" class="form-input"></div>
            <div><label class="form-label">Group</label><div id="edit-ms-groups-container"></div><div id="edit-group-ids-container"></div></div>
            <div><label class="form-label">Exam Date</label><input type="datetime-local" name="deadline_date" required value="${exam.deadline_date ? exam.deadline_date.replace(' ', 'T').substring(0, 16) : ''}" class="form-input"></div>
            <div><label class="form-label">Current Attachments</label><div id="edit-existing-attachments">${renderExistingAttachments(exam.attachments || [], exam.id)}</div></div>
            <div>
                <label class="form-label">Add New Attachments</label>
                <div id="edit-attachments-container"></div>
                <button type="button" class="btn btn-secondary" id="edit-add-attachment-btn" style="margin-top: 0.5rem;">+ Add Attachment</button>
                <!-- NEW GOOGLE DRIVE BUTTON -->
                <button type="button" class="btn btn-google-drive" id="edit-add-drive-attachment-btn">
                    <img src="https://www.google.com/images/icons/product/drive-32.png" alt="Google Drive icon"> Choose from Google Drive
                </button>
                <!-- END NEW BUTTON -->
            </div>
            <div><label class="form-label">Points</label><input type="number" name="points" placeholder="0" value="${exam.points || ''}" class="form-input"></div>
        `;

        setupEditGroupMultiSelect(exam.groups_mm || [], groups); // Setup multi-select
    }

    function setupEditGroupMultiSelect(selectedGroups, availableGroups) {
        // This function remains largely the same as in assignments.html
        // Ensure IDs used (e.g., 'edit-multiSelectGroups', 'edit-dropdownListGroups') are unique if needed,
        // or ensure this function is only called when the edit exam modal is active.
        // The version from assignments.html seems robust.
        let editSelectedGroups = selectedGroups.map(s => ({ id: String(s.id), name: s.name }));

        const container = document.getElementById('edit-ms-groups-container');
        container.innerHTML = ''; // Clear previous content

        const multiSelect = document.createElement('div');
        multiSelect.className = 'multi-select';
        multiSelect.onclick = () => toggleEditGroupDropdown();

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Type or select groups...';
        input.oninput = () => filterEditGroups();

        multiSelect.appendChild(input);

        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-list';
        dropdown.style.display = 'none'; // Initially hidden

        availableGroups.forEach(group => {
            const div = document.createElement('div');
            div.dataset.id = String(group.id);
            div.textContent = group.name;
            dropdown.appendChild(div);
        });

        dropdown.onclick = (e) => {
            if (e.target.dataset.id) {
                const id = e.target.dataset.id;
                const name = e.target.textContent;
                if (!editSelectedGroups.find(s => s.id === id)) {
                    editSelectedGroups.push({ id, name });
                    renderEditGroupTags();
                }
                input.value = '';
                filterEditGroups();
                dropdown.style.display = 'none';
            }
        };

        container.appendChild(multiSelect);
        container.appendChild(dropdown);

        function renderEditGroupTags() {
             // Clear existing tags but keep the input
            while (multiSelect.firstChild && multiSelect.firstChild !== input) {
                multiSelect.removeChild(multiSelect.firstChild);
            }
            // Add current selected tags before the input
            editSelectedGroups.forEach(s => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '√ó';
                btn.onclick = (event) => {
                    event.stopPropagation(); // Prevent dropdown toggle
                    editSelectedGroups = editSelectedGroups.filter(group => group.id !== s.id);
                    renderEditGroupTags();
                };
                tag.textContent = s.name + ' ';
                tag.appendChild(btn);
                multiSelect.insertBefore(tag, input); // Insert tag before input
            });

            // Update hidden inputs for form submission
            const hiddenContainer = document.getElementById('edit-group-ids-container');
            hiddenContainer.innerHTML = ''; // Clear existing hidden inputs
            editSelectedGroups.forEach(s => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'groups[]'; // Ensure name matches backend expectation
                hiddenInput.value = s.id;
                hiddenContainer.appendChild(hiddenInput);
            });
        }

        window.toggleEditGroupDropdown = () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (dropdown.style.display === 'block') input.focus();
        };

        window.filterEditGroups = () => {
            const filter = input.value.toLowerCase();
            Array.from(dropdown.children).forEach(option => {
                const isSelected = editSelectedGroups.some(s => s.id === option.dataset.id);
                option.style.display = (!isSelected && option.textContent.toLowerCase().includes(filter)) ? 'block' : 'none';
            });
             // Keep dropdown open while typing
            if (input.value) {
                dropdown.style.display = 'block';
            }
        };

        renderEditGroupTags(); // Initial render

        // Global click listener to close dropdown
        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }

    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text); // Ensure it's a string
        return div.innerHTML;
    }

    function renderExistingAttachments(attachments, examId) {
        if (!attachments || attachments.length === 0) {
            return '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
        }
        return attachments.map((attachment, index) => {
             let name, type, url;
            // Handle both potential formats
            if (typeof attachment === 'string') {
                name = attachment; type = attachment.startsWith('http') ? 'link' : 'file'; url = type === 'link' ? attachment : '#'; // Assuming file links aren't directly viewable like this
            } else {
                name = attachment.name || 'Unnamed'; type = attachment.type || 'unknown'; url = attachment.url || '#';
            }
            return `
                <div class="existing-attachment-item" data-index="${index}">
                    <div class="existing-attachment-info">
                        <span class="existing-attachment-name">${escapeHtml(name)}</span>
                        <span class="existing-attachment-type">${type.toUpperCase()}</span>
                        ${type === 'link' ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">View Link</a>` : ''}
                    </div>
                    <button type="button" class="existing-attachment-delete" onclick="deleteExistingAttachment(event, ${examId}, ${index})">Delete</button>
                </div>`;
        }).join('');
    }

    // Make deleteExistingAttachment globally available
    window.deleteExistingAttachment = async function (event, examId, attachmentIndex) {
        const confirmed = await confirmAction(event, 'Are you sure you want to delete this attachment?');
        if (!confirmed) return;

        try {
            const filterGroupId = document.getElementById('examsScript').dataset.filterGroupId;
            let deleteUrl = filterGroupId
                ? `/admin/group/${filterGroupId}/online/exam/delete-attachment/${examId}/${attachmentIndex}`
                : `/admin/online/exam/delete-attachment/${examId}/${attachmentIndex}`;

            const resp = await fetch(deleteUrl, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
            const data = await resp.json().catch(() => ({}));

            if (resp.ok && data.success) {
                const attachmentItem = document.querySelector(`#edit-existing-attachments .existing-attachment-item[data-index="${attachmentIndex}"]`);
                if (attachmentItem) attachmentItem.remove();
                // Check if any remain
                if (!document.querySelector('#edit-existing-attachments .existing-attachment-item')) {
                    document.getElementById('edit-existing-attachments').innerHTML = '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
                }
                showToast(data.message || 'Attachment deleted', 'success');
            } else {
                showToast((data && data.message) || 'Failed to delete attachment', 'error');
            }
        } catch (err) {
            console.error('Delete attachment failed', err);
            showToast('Failed to delete attachment', 'error');
        }
    };

    // Handle edit form submission
    document.addEventListener('DOMContentLoaded', function () {
        const editForm = document.getElementById('editExamForm');
        if (!editForm) return;

        editForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!currentEditingExamId) return;

            const submitBtn = editForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Saving...'; }

            try {
                const formData = new FormData(editForm);

                // Process new attachments for edit form (Your existing logic seems correct)
                const editAttachmentItems = document.querySelectorAll('#edit-attachments-container .attachment-item');
                let newAttachmentCount = 0;
                editAttachmentItems.forEach((item) => {
                     const itemId = item.id;
                     const counterMatch = itemId.match(/(\d+)$/);
                     if (!counterMatch) return;
                     const counter = counterMatch[1];

                     const nameInput = item.querySelector(`input[name="edit-attachment_name_${counter}"]`);
                     const typeInput = item.querySelector(`input[name="edit-attachment_type_${counter}"]`);
                     const fileInput = item.querySelector(`input[name="edit-attachment_file_${counter}"]`);
                     const linkInput = item.querySelector(`input[name="edit-attachment_link_${counter}"]`);

                     if (nameInput && typeInput) {
                        formData.append(`new_attachments[${newAttachmentCount}][name]`, nameInput.value);
                        formData.append(`new_attachments[${newAttachmentCount}][type]`, typeInput.value);
                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`new_attachments[${newAttachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`new_attachments[${newAttachmentCount}][url]`, linkInput.value);
                        }
                        newAttachmentCount++;
                    }
                });

                const resp = await fetch(`/admin/online/exam/edit/${currentEditingExamId}`, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.success && data.exam) {
                    const idx = allExams.findIndex(e => e.id === currentEditingExamId);
                    if (idx >= 0) allExams[idx] = data.exam;
                    filterExams();
                    editModal.classList.remove('show');
                    // No need to reset form here, modal closes
                    showToast(data.message || 'Exam updated successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to update exam', 'error');
                }
            } catch (err) {
                console.error('Update exam failed', err);
                showToast('Failed to update exam', 'error');
            } finally {
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Save Changes'; }
                currentEditingExamId = null; // Reset after attempt
            }
        });
    });

    // --- RENDER FUNCTION ---
    function renderExams(exams) {
        const grid = document.getElementById('examsGrid');
        if (!grid) return; // Exit if grid not found
        if (!exams || exams.length === 0) {
            grid.innerHTML = `<div class="no-exams-message"><h3>No exams found.</h3><p>Try adjusting filters or create one.</p></div>`;
            return;
        }

        grid.innerHTML = exams.map(e => {
            const groupsStr = (e.groups && e.groups.length) ? e.groups.join(', ') : 'All Groups';
            const due = e.deadline_date ? new Date(e.deadline_date).toLocaleString() : 'Not set'; // Format date
            const hiddenClass = e.status !== 'Show' ? 'hidden-exam' : '';
            const viewHref = filterGroupId ? `/admin/online/exam/submissions/${e.id}?group_id=${filterGroupId}` : `/admin/online/exam/submissions/${e.id}`;
            const missing = Math.max(0, (e.qualified_students_count || 0) - (e.submitted_students_count || 0)); // Ensure non-negative

            // Simplified card structure
            return `
            <div class="exam-card ${hiddenClass}" data-href="${viewHref}" data-group="${e.groups ? e.groups.join(',') : ''}" data-title="${(e.title || '').toLowerCase()}">
                <div class="card-main-content">
                    <div class="card-header">
                        <div>
                            <h3 class="exam-title">${escapeHtml(e.title || 'Untitled Exam')}</h3>
                            <p class="exam-due">Due: ${due}</p>
                            <p>Out of: ${e.out_of || 'N/A'}</p>
                            <p>Points: ${e.points || '0'}</p>
                            <p>Close after deadline: <span style="font-weight:bold; color:${e.close_after_deadline ? 'green' : 'red'};">${e.close_after_deadline ? 'Yes' : 'No'}</span></p>
                        </div>
                        <div class="card-actions">
                             ${e.status !== 'Show' ? '<span class="badge badge-orange">HIDDEN</span>' : ''}
                             <button data-settings-id="${e.id}" class="btn-action js-settings" title="Settings">‚öôÔ∏è</button> <!-- Simplified icon -->
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="detail-item"><strong>Group(s):</strong> ${escapeHtml(groupsStr)}</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="stat-item"><span class="stat-value green">${e.submitted_students_count || 0}</span><span class="stat-label">Submitted</span></div>
                    <div class="stat-item"><span class="stat-value red">${missing}</span><span class="stat-label">Missing</span></div>
                </div>
            </div>`;
        }).join('');
    }

    // --- FILTERING LOGIC ---
    function getCheckedValues(listId) {
        const list = document.getElementById(listId);
        if (!list) return [];
        const allCheckbox = list.querySelector('input[type="checkbox"][value=""]');
        if (!allCheckbox || allCheckbox.checked) return []; // Return empty if "All" is checked
        return Array.from(list.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value)
            .filter(Boolean); // Filter out empty value from "All" if somehow checked
    }

    function filterExams() {
        const searchInput = document.getElementById('searchInput');
        const search = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedGroupNames = getCheckedValues('schoolDropdownList'); // Get selected group names

        const filtered = allExams.filter(exam => {
            const titleMatch = (exam.title || '').toLowerCase().includes(search);
            // Match if no groups selected OR if exam groups intersect with selected group names
            const groupMatch = selectedGroupNames.length === 0 ||
                               (exam.groups && exam.groups.some(examGroupName => selectedGroupNames.includes(examGroupName)));

            return titleMatch && groupMatch;
        });
        renderExams(filtered);
    }

    function enableFilters() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.disabled = false;
        const schoolDropdown = document.getElementById('schoolDropdown');
        if (schoolDropdown) schoolDropdown.classList.remove('disabled');
        isLoading = false;
    }

    function populateFilterDropdowns() {
        const schoolList = document.getElementById('schoolDropdownList');
        if (schoolList) {
            // Clear existing options except "All"
            schoolList.querySelectorAll('label:not(.dropdown-all)').forEach(l => l.remove());
            // Add options based on fetched groups
            groups.forEach(group => {
                const label = document.createElement('label');
                // Use group NAME as the value for filtering
                label.innerHTML = `<input type="checkbox" value="${escapeHtml(group.name)}"> ${escapeHtml(group.name)}`;
                schoolList.appendChild(label);
            });
        }
    }

    function populateModalDropdowns() {
        const schoolList = document.getElementById('ms-schools-list');
        if (schoolList) {
            // Clear existing options except "All"
            schoolList.querySelectorAll('label:not(.multi-all)').forEach(l => l.remove());
            // Add options based on fetched groups
            groups.forEach(group => {
                const label = document.createElement('label');
                 // Use group ID as the value for form submission
                label.innerHTML = `<input type="checkbox" name="groups[]" value="${group.id}"> ${escapeHtml(group.name)}`;
                schoolList.appendChild(label);
            });
        }
    }

    async function initializePage() {
        try {
            // --- Initialize Google Auth First ---
            initGoogleAuth();
            // ---

            const [examsData, filtersData] = await Promise.all([
                fetchExams(),
                fetchFilters()
            ]);

            allExams = examsData;
            groups = filtersData.groups || [];

            populateFilterDropdowns();
            populateModalDropdowns();

            // Setup filter dropdown if present
            if (document.getElementById('schoolDropdown')) {
                setupDropdown('schoolDropdown', 'schoolDropdownBtn', 'schoolDropdownList', 'All Groups', filterExams);
            }
            // Setup modal multi-select if present
            if (document.getElementById('ms-schools')) {
                // Use group ID for the value in the modal form
                setupDropdown('ms-schools', 'ms-schools-btn', 'ms-schools-list', 'All Groups');
            }

            renderExams(allExams); // Initial render
            enableFilters();

            // Add search input listener
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.addEventListener('input', filterExams);

            // Add grid click listener for navigation and settings
            const gridEl = document.getElementById('examsGrid');
            if(gridEl) {
                gridEl.addEventListener('click', async function (e) {
                    const settingsBtn = e.target.closest('.js-settings');
                    const card = e.target.closest('.exam-card');

                    if (settingsBtn) {
                        e.preventDefault(); // Prevent card navigation
                        e.stopPropagation(); // Stop event bubbling
                        const id = settingsBtn.getAttribute('data-settings-id');
                        if (id) openSettingsModal(parseInt(id));
                    } else if (card && card.dataset.href) {
                        window.location.href = card.dataset.href; // Navigate on card click
                    }
                });
            }

        } catch (error) {
            console.error('Error initializing exams page:', error);
            const grid = document.getElementById('examsGrid');
            if (grid) grid.innerHTML = `<div class="no-exams-message"><h3>Error loading exams.</h3><p>Please refresh the page.</p></div>`;
            enableFilters(); // Still enable search/filters even if data fails
        }
    }

    // Initialize everything when the DOM is ready
    document.addEventListener('DOMContentLoaded', initializePage);
</script>
{% endblock %}
