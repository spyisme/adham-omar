{% extends "admin/dashboard.html" %}
{% block title %}Manage Exams{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* --- Page & Filter Layout --- */
    .container {
        padding-top: 1.5rem;
    }

    .filters-card {
        margin-bottom: 2rem;
    }

    .search-row-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    #searchInput {
        width: 100%;
        max-width: 800px;
        font-size: 1rem;
    }

    .filters-row-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
    }

    .filters-row-wrapper .filter-dropdown {
        min-width: 200px;
        flex-grow: 1;
    }

    .filter-dropdown.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .multi.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    /* --- Skeleton Loader --- */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 0.4rem;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    .skeleton-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .skeleton-h3 {
        height: 1.5rem;
        width: 60%;
        margin-bottom: 1rem;
    }

    .skeleton-p {
        height: 1rem;
        width: 80%;
        margin-bottom: 0.5rem;
    }

    .skeleton-p.short {
        width: 40%;
    }

    .skeleton-footer {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .skeleton-badge {
        height: 1.5rem;
        width: 70px;
    }

    .skeleton-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1rem 0;
    }

    /* --- Multi-select dropdown styles for edit modal --- */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-size: 0.9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    #edit-ms-groups-container,
    #repost-ms-groups-container {
        position: relative;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }

    /* --- Settings Modal Styles --- */
    .settings-info {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .settings-info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .settings-info-item:last-child {
        border-bottom: none;
    }

    .settings-info-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .settings-info-value {
        color: #334155;
        font-size: 0.875rem;
        text-align: right;
    }

    .settings-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .settings-action-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
        text-align: left;
    }

    .settings-action-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        transform: translateX(4px);
    }

    .settings-action-btn.edit-action:hover {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .settings-action-btn.toggle-action:hover {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #f59e0b;
    }

    .settings-action-btn.delete-action:hover {
        background: #fef2f2;
        border-color: #ef4444;
        color: #ef4444;
    }

    .settings-action-btn svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    /* --- Attachment System Styles --- */
    .attachment-item {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        position: relative;
    }

    .attachment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .attachment-item-number {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
    }

    .attachment-remove-btn {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        color: #ef4444;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .attachment-remove-btn:hover {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .attachment-fields {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .attachment-name-input {
        width: 100%;
    }

    .attachment-type-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .attachment-type-btn {
        flex: 1;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .attachment-type-btn.active {
        background: #eef2ff;
        border-color: #4338ca;
        color: #4338ca;
    }

    .attachment-input-wrapper {
        position: relative;
    }

    .attachment-file-input,
    .attachment-link-input {
        width: 100%;
    }

    #add-attachment-btn {
        background: #fff;
        border: 2px dashed #cbd5e1;
        color: #64748b;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    #add-attachment-btn:hover {
        border-color: #94a3b8;
        background: #f8fafc;
        color: #475569;
    }

    .existing-attachment-item {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .existing-attachment-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .existing-attachment-name {
        font-weight: 600;
        color: #0c4a6e;
    }

    .existing-attachment-type {
        font-size: 0.75rem;
        color: #0284c7;
        text-transform: uppercase;
    }

    .existing-attachment-delete {
        color: #ef4444;
        text-decoration: none;
        font-weight: 500;
        padding: 0.25rem 0.75rem;
        border: 1px solid #ef4444;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .existing-attachment-delete:hover {
        background: #ef4444;
        color: #fff;
    }

    /* --- Exams Grid & Cards --- */
    .exams-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .exam-card {
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        cursor: pointer;
        overflow: hidden;
    }

    .exam-card.hidden-exam {
        opacity: 0.7;
        background-color: #fafafa;
    }

    .exam-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .card-main-content {
        padding: 1.5rem;
        flex-grow: 1;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .exam-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-primary, #333);
        margin: 0;
    }

    .exam-due {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #666);
        margin-top: 0.25rem;
    }

    .card-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .detail-item {
        color: var(--color-text-secondary, #666);
    }

    .detail-item strong {
        display: block;
        color: var(--color-text, #333);
        margin-bottom: 0.15rem;
    }

    .card-actions {
        position: relative;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-footer {
        border-top: 1px solid var(--color-border, #e0e0e0);
        background-color: #f9fafb;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-around;
        text-align: center;
    }

    .stat-item .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        display: block;
    }

    .stat-item .stat-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--color-text-secondary, #666);
    }

    .stat-value.green {
        color: var(--color-success, #28a745);
    }

    .stat-value.red {
        color: var(--color-danger, #dc3545);
    }

    /* --- No Exams Message --- */
    .no-exams-message {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        background-color: #fff;
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        color: var(--color-text-secondary, #666);
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .filters-row-wrapper .filter-dropdown {
            min-width: 150px;
        }
    }

    @media (max-width: 600px) {
        .filters-row-wrapper {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .exams-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .card-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">{% if filter_group_id %}{{ group.name }} Exams{% else %}All Exams{% endif %}</h1>
        <button id="openAddExamDesktop" class="btn btn-primary">Create Exam</button>
    </div>
</header>

<main class="container">
    <div class="card filters-card">
        <div class="card-content">
            <div class="search-row-wrapper">
                <input type="text" id="searchInput" class="form-input" placeholder="Search by exam title..." disabled>
            </div>
            {% if not filter_group_id %}
            <div class="filters-row-wrapper">
                <div class="filter-dropdown disabled" id="schoolDropdown">
                    <button type="button" class="btn form-input filter-dropdown-btn" id="schoolDropdownBtn">All Groups
                        ▼</button>
                    <div class="filter-dropdown-list" id="schoolDropdownList">
                        <label class="dropdown-all"><input type="checkbox" value="" checked>All Groups</label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="examsGrid" class="exams-grid">
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="skeleton skeleton-h3"></div>
            <div class="skeleton skeleton-p"></div>
            <div class="skeleton skeleton-p short"></div>
            <div class="skeleton-footer">
                <div class="skeleton skeleton-badge"></div>
                <div class="skeleton skeleton-badge"></div>
            </div>
        </div>
    </div>
</main>

<div id="examModal" class="modal-overlay">
    <div class="modal-content">
        <form method="POST" enctype="multipart/form-data">
            {% if filter_group_id %}
            <input type="hidden" name="locked_group_id" value="{{ filter_group_id }}">
            {% endif %}
            <div class="modal-header">
                <h2>Add New Exam</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <label class="form-label">Title</label>
                    <input type="text" name="title" required placeholder="e.g., Midterm Exam" class="form-input">
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea name="description" rows="4" placeholder="Provide instructions, topics, or details here..."
                        class="form-textarea"></textarea>
                </div>

                <div>
                    <label class="form-label">
                        <input type="checkbox" name="student_whatsapp" value="true" checked>
                        Send WhatsApp notification to student
                    </label>
                </div>
                <div>
                    <label class="form-label">
                        <input type="checkbox" name="parent_whatsapp" value="true" checked>
                        Send WhatsApp notification to parent
                    </label>
                </div>

                <div>
                    <label class="form-label">
                        <input type="checkbox" name="close_after_deadline" value="true" checked>
                        Close after deadline (Disable submissions after deadline)
                    </label>
                </div>
                <div>
                    <label class="form-label">Out of</label>
                    <input type="number" name="out_of" placeholder="e.g., 100 (leave empty for ungraded exam)"
                        class="form-input">
                </div>
                <div>
                    <label class="form-label">Group</label>
                    {% if filter_group_id %}
                    <div class="form-input" style="background-color: #f0f0f0; cursor: not-allowed; opacity: 0.7;">
                        {{ group.name }}
                    </div>
                    <input type="hidden" name="groups[]" value="{{ filter_group_id }}">
                    {% else %}
                    <div class="multi" id="ms-schools">
                        <button type="button" class="btn form-input multi-btn" id="ms-schools-btn">All Groups
                            ▼</button>
                        <div class="multi-list" id="ms-schools-list">
                            <label class="multi-all"><input type="checkbox" value="" checked>All Groups</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <label class="form-label">Exam Date</label>
                    <input type="datetime-local" name="deadline_date" required class="form-input">
                </div>
                <div>
                    <label class="form-label">Attachments</label>
                    <div id="attachments-container">
                        <!-- Dynamic attachment fields will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" id="add-attachment-btn" style="margin-top: 0.5rem;">
                        + Add Attachment
                    </button>
                </div>
                <div>
                    <label class="form-label">Points (Optional)</label>
                    <input type="number" name="points" placeholder="0" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Exam Modal -->
<div id="editExamModal" class="modal-overlay">
    <div class="modal-content">
        <form id="editExamForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Edit Exam</h2>
                <button type="button" class="modal-close" id="editModalClose">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- Skeleton loader will be shown initially -->
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="editModalFooter" style="display: none;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Exam Settings</h2>
            <button type="button" class="modal-close" id="settingsModalClose">&times;</button>
        </div>
        <div class="modal-body" id="settingsModalBody">
            <!-- Skeleton loader will be shown initially -->
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        </div>
    </div>
</div>

<!-- Repost Exam Modal -->
<div id="repostExamModal" class="modal-overlay">
    <div class="modal-content">
        <form id="repostExamForm" method="POST" enctype="multipart/form-data">
            <div class="modal-header">
                <h2>Repost Exam</h2>
                <button type="button" class="modal-close" id="repostModalClose">&times;</button>
            </div>
            <div class="modal-body" id="repostModalBody">
                <div class="skeleton-form">
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                    <div class="skeleton skeleton-p"></div>
                </div>
            </div>
            <div class="modal-footer" id="repostModalFooter" style="display: none;">
                <button type="button" class="btn btn-secondary" id="repostModalCancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Repost Exam</button>
            </div>
        </form>
    </div>
</div>

<script id="examsScript" data-filter-group-id="{% if filter_group_id %}{{ filter_group_id }}{% endif %}">
    // Global state
    let allExams = [];
    let groups = [];
    let isLoading = true;
    let currentEditingExamId = null;
    const filterGroupId = document.getElementById('examsScript').dataset.filterGroupId ? parseInt(document.getElementById('examsScript').dataset.filterGroupId) : null;

    // --- Modal Logic ---
    const modal = document.getElementById('examModal');
    const editModal = document.getElementById('editExamModal');
    const settingsModal = document.getElementById('settingsModal');
    const repostModal = document.getElementById('repostExamModal');
    const openModalBtns = [document.getElementById('openAddExamDesktop')];
    const closeModalBtn = document.querySelector('.modal-close');
    const editModalCloseBtn = document.getElementById('editModalClose');
    const settingsModalCloseBtn = document.getElementById('settingsModalClose');
    const repostModalCloseBtn = document.getElementById('repostModalClose');
    const repostModalCancelBtn = document.getElementById('repostModalCancelBtn');

    openModalBtns.forEach(btn => {
        if (btn) btn.onclick = () => { modal.classList.add('show'); };
    });
    if (closeModalBtn) closeModalBtn.onclick = () => { modal.classList.remove('show'); };
    if (editModalCloseBtn) editModalCloseBtn.onclick = () => { editModal.classList.remove('show'); };
    if (settingsModalCloseBtn) settingsModalCloseBtn.onclick = () => { settingsModal.classList.remove('show'); };
    if (repostModalCloseBtn) repostModalCloseBtn.onclick = () => { repostModal.classList.remove('show'); };
    if (repostModalCancelBtn) repostModalCancelBtn.onclick = () => { repostModal.classList.remove('show'); };

    modal.onclick = e => {
        if (e.target === modal) modal.classList.remove('show');
    };
    editModal.onclick = e => {
        if (e.target === editModal) editModal.classList.remove('show');
    };
    settingsModal.onclick = e => {
        if (e.target === settingsModal) settingsModal.classList.remove('show');
    };
    repostModal.onclick = e => {
        if (e.target === repostModal) repostModal.classList.remove('show');
    };

    // --- Attachment Management System ---
    let attachmentCounter = 0;
    let editAttachmentCounter = 0;
    let repostAttachmentCounter = 0;

    function addAttachmentField(container, prefix = '', existingData = null) {
        let counter;
        if (prefix === 'edit-') {
            counter = ++editAttachmentCounter;
        } else if (prefix === 'repost-') {
            counter = ++repostAttachmentCounter;
        } else {
            counter = ++attachmentCounter;
        }
        
        const attachmentId = `${prefix}attachment-${counter}`;

        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.id = attachmentId;

        const defaultType = existingData ? existingData.type : 'file';
        const defaultName = existingData ? existingData.name : '';
        const defaultUrl = existingData && existingData.type === 'link' ? existingData.url : '';

        attachmentItem.innerHTML = `
            <div class="attachment-item-header">
                <span class="attachment-item-number">Attachment #${counter}</span>
                <button type="button" class="attachment-remove-btn" onclick="removeAttachment('${attachmentId}')">
                    Remove
                </button>
            </div>
            <div class="attachment-fields">
                <input type="text" 
                       name="${prefix}attachment_name_${counter}" 
                       placeholder="Enter attachment name (e.g., Chapter 5 Notes)" 
                       class="form-input attachment-name-input"
                       value="${defaultName}"
                       required>
                
                <div class="attachment-type-selector">
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'file' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'file')">
                        📁 File Upload
                    </button>
                    <button type="button" 
                            class="attachment-type-btn ${defaultType === 'link' ? 'active' : ''}" 
                            onclick="toggleAttachmentType('${attachmentId}', 'link')">
                        🔗 External Link
                    </button>
                </div>
                
                <div class="attachment-input-wrapper">
                    <input type="file" 
                           name="${prefix}attachment_file_${counter}" 
                           class="form-input attachment-file-input"
                           style="display: ${defaultType === 'file' ? 'block' : 'none'};">
                    
                    <input type="url" 
                           name="${prefix}attachment_link_${counter}" 
                           placeholder="https://example.com/resource" 
                           class="form-input attachment-link-input"
                           value="${defaultUrl}"
                           style="display: ${defaultType === 'link' ? 'block' : 'none'};">
                </div>
                
                <input type="hidden" 
                       name="${prefix}attachment_type_${counter}" 
                       value="${defaultType}">
            </div>
        `;

        container.appendChild(attachmentItem);
    }

    // Make removeAttachment globally available
    window.removeAttachment = function (attachmentId) {
        const element = document.getElementById(attachmentId);
        if (element) {
            element.remove();
        }
    };

    // Make toggleAttachmentType globally available
    window.toggleAttachmentType = function (attachmentId, type) {
        const attachmentItem = document.getElementById(attachmentId);
        if (!attachmentItem) return;

        const fileBtn = attachmentItem.querySelector('.attachment-type-btn:first-child');
        const linkBtn = attachmentItem.querySelector('.attachment-type-btn:last-child');
        const fileInput = attachmentItem.querySelector('.attachment-file-input');
        const linkInput = attachmentItem.querySelector('.attachment-link-input');
        const typeInput = attachmentItem.querySelector('input[type="hidden"]');

        if (type === 'file') {
            fileBtn.classList.add('active');
            linkBtn.classList.remove('active');
            fileInput.style.display = 'block';
            linkInput.style.display = 'none';
            linkInput.value = ''; // Clear link input
        } else {
            fileBtn.classList.remove('active');
            linkBtn.classList.add('active');
            fileInput.style.display = 'none';
            linkInput.style.display = 'block';
            fileInput.value = ''; // Clear file input
        }

        typeInput.value = type;
    };

    // Add attachment button event listeners using event delegation
    document.addEventListener('click', function (e) {
        // Handle add attachment button for main modal
        if (e.target && e.target.id === 'add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('attachments-container');
            addAttachmentField(container);
        }

        // Handle add attachment button for edit modal
        if (e.target && e.target.id === 'edit-add-attachment-btn') {
            e.preventDefault();
            const container = document.getElementById('edit-attachments-container');
            if (container) {
                addAttachmentField(container, 'edit-');
            }
        }
    });

    // --- Dropdown/Multiselect Logic ---
    function setupDropdown(dropdownId, btnId, listId, labelAll, updateCallback) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');

        const getCheckboxes = () => Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            if (dropdown.classList.contains('disabled')) return;
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.filter-dropdown, .multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) {
                dropdown.classList.add('open');
            }
        };

        const updateHandler = function () {
            const checkboxes = getCheckboxes();
            if (this.value === "") {
                if (this.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
            } else {
                if (this.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
            }
            updateBtnLabel();
            if (updateCallback) updateCallback();
        };

        list.addEventListener('change', e => {
            if (e.target.type === 'checkbox') {
                updateHandler.call(e.target);
            }
        });

        function updateBtnLabel() {
            let selected = getCheckboxes().filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ▼";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 15) + (selected[0].length > 15 ? '...' : '') + " ▼";
            } else {
                btn.textContent = selected.length + " selected ▼";
            }
        }
        updateBtnLabel();
    }

    // Close dropdowns on outside click
    document.addEventListener('click', function (e) {
        document.querySelectorAll('.filter-dropdown.open, .multi.open').forEach(d => {
            if (!d.contains(e.target)) {
                d.classList.remove('open');
            }
        });
    });

    // --- Toast utility ---
    function showToast(message, type = 'info', opts = {}) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.position = 'fixed';
            container.style.right = '1rem';
            container.style.bottom = '1rem';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '0.5rem';
            container.style.zIndex = '9999';
            container.style.pointerEvents = 'none';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.minWidth = '260px';
        toast.style.maxWidth = '92vw';
        toast.style.background = type === 'success' ? '#065f46' : type === 'error' ? '#7f1d1d' : '#1e3a8a';
        toast.style.color = '#f9fafb';
        toast.style.borderRadius = '8px';
        toast.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
        toast.style.padding = '0.75rem 1rem';
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.gap = '0.5rem';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(8px)';
        toast.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        toast.style.pointerEvents = 'auto';
        const msg = document.createElement('div');
        msg.textContent = message;
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '✕';
        closeBtn.style.background = 'transparent';
        closeBtn.style.border = 'none';
        closeBtn.style.color = 'inherit';
        closeBtn.style.fontSize = '1.1rem';
        closeBtn.style.lineHeight = '1';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.padding = '0.25rem';
        closeBtn.style.borderRadius = '0.25rem';
        const removeToast = () => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 200); };
        closeBtn.onclick = removeToast;
        toast.appendChild(msg);
        toast.appendChild(closeBtn);
        container.appendChild(toast);
        void toast.offsetHeight;
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        const duration = typeof opts.duration === 'number' ? opts.duration : 3500;
        const timer = setTimeout(removeToast, duration);
        toast.addEventListener('mouseenter', () => clearTimeout(timer));
    }

    // --- GENERAL ACTION CONFIRMATION (Promise-based, no form submit) ---
    function confirmAction(event, message) {
        if (event && event.preventDefault) {
            event.preventDefault();
        }
        return Swal.fire({
            title: "Confirm Action",
            html: message,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "var(--button-bg, #3085d6)",
            cancelButtonColor: "var(--flash-danger-bg, #d33)",
            confirmButtonText: "Yes, proceed",
            cancelButtonText: "No, cancel",
            background: "var(--card-bg, #fff)",
            color: "var(--text-color, #333)",
        }).then((result) => {
            return result.isConfirmed;
        });
    }

    // --- API Calls ---
    async function fetchExams() {
        try {
            let url = '/admin/api/exams-data';
            if (filterGroupId) {
                url += `?group_id=${filterGroupId}`;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch exams');
            const data = await response.json();
            return data || [];
        } catch (error) {
            console.error('Error fetching exams:', error);
            return [];
        }
    }

    // --- Intercept form submit to POST without refresh ---
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('#examModal form');
        if (!form) return;
        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Posting...'; }
            try {
                const formData = new FormData(form);

                // Process attachments
                const attachmentItems = document.querySelectorAll('#attachments-container .attachment-item');
                let attachmentCount = 0;
                attachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counter = itemId.replace('attachment-', '');

                    const nameInput = item.querySelector(`input[name="attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`attachments[${attachmentCount}][name]`, nameInput.value);
                        formData.append(`attachments[${attachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`attachments[${attachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`attachments[${attachmentCount}][url]`, linkInput.value);
                        }
                        attachmentCount++;
                    }
                });

                const resp = await fetch('/admin/online/exam', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.success && data.exam) {
                    allExams.unshift(data.exam);
                    filterExams();
                    modal.classList.remove('show');
                    form.reset();
                    document.getElementById('attachments-container').innerHTML = '';
                    attachmentCounter = 0;
                    // Reset modal dropdown button labels
                    const msSchoolsBtn = document.getElementById('ms-schools-btn');
                    if (msSchoolsBtn) {
                        msSchoolsBtn.textContent = 'All Groups ▼';
                    }
                    showToast(data.message || 'Exam created successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to create exam', 'error');
                }
            } catch (err) {
                console.error('Create exam failed', err);
                showToast('Failed to create exam', 'error');
            } finally {
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Add Exam'; }
            }
        });
    });

    async function fetchFilters() {
        try {
            const response = await fetch('/admin/api/filters');
            if (!response.ok) throw new Error('Failed to fetch filters');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching filters:', error);
            return { groups: [] };
        }
    }

    // --- SETTINGS MODAL FUNCTION ---
    async function openSettingsModal(examId) {
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalBody = document.getElementById('settingsModalBody');

        // Show modal with skeleton loader
        settingsModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        `;
        settingsModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/exam/${examId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch exam data', 'error');
                settingsModal.classList.remove('show');
                return;
            }

            const exam = data.exam;
            const createdAt = exam.created_at ? exam.created_at : 'N/A';
            const modifiedAt = exam.last_edited_at ? exam.last_edited_at : 'N/A';
            const createdBy = exam.created_by || 'N/A';
            const modifiedBy = exam.last_edited_by || 'N/A';
            const currentStatus = exam.status === 'Show' ? 'Visible' : 'Hidden';
            const toggleAction = exam.status === 'Show' ? 'Hide' : 'Show';

            settingsModalBody.innerHTML = `
                <div class="settings-info">
                    <div class="settings-info-item">
                        <span class="settings-info-label">Created By:</span>
                        <span class="settings-info-value">${escapeHtml(String(createdBy))}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Created At:</span>
                        <span class="settings-info-value">${createdAt}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Last Modified By:</span>
                        <span class="settings-info-value">${escapeHtml(String(modifiedBy))}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Last Modified At:</span>
                        <span class="settings-info-value">${modifiedAt}</span>
                    </div>
                    <div class="settings-info-item">
                        <span class="settings-info-label">Status:</span>
                        <span class="settings-info-value">${currentStatus}</span>
                    </div>
                </div>

                <div class="settings-actions">
                    <button class="settings-action-btn edit-action" data-action="edit" data-id="${exam.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
                            <path d="m15 5 4 4"/>
                        </svg>
                        <span>Edit Exam</span>
                    </button>

                    <button class="settings-action-btn edit-action" data-action="repost" data-id="${exam.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                        </svg>
                        <span>Repost Exam</span>
                    </button>

                    <button class="settings-action-btn toggle-action" data-action="toggle" data-id="${exam.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            ${exam.status === 'Show' ? `
                                <path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/>
                                <path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/>
                                <path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/>
                                <path d="m2 2 20 20"/>
                            ` : `
                                <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                                <circle cx="12" cy="12" r="3"/>
                            `}
                        </svg>
                        <span>${toggleAction} Exam</span>
                    </button>

                    <button class="settings-action-btn delete-action" data-action="delete" data-id="${exam.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            <path d="M3 6h18"/>
                            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        <span>Delete Exam</span>
                    </button>
                </div>
            `;

            // Add event listeners for action buttons
            settingsModalBody.querySelectorAll('.settings-action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const action = btn.getAttribute('data-action');
                    const id = btn.getAttribute('data-id');

                    if (action === 'edit') {
                        settingsModal.classList.remove('show');
                        openEditModal(parseInt(id));
                    } else if (action === 'repost') {
                        settingsModal.classList.remove('show');
                        openRepostModal(parseInt(id));
                    } else if (action === 'delete') {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'You want to delete this exam? This action cannot be undone.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (!result.isConfirmed) return;

                        settingsModal.classList.remove('show');

                        try {
                            const resp = await fetch(`/admin/online/exam/delete/${id}`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                            const data = await resp.json().catch(() => ({}));
                            if (resp.ok && data.success) {
                                allExams = allExams.filter(e => String(e.id) !== String(id));
                                filterExams();
                                showToast(data.message || 'Exam deleted', 'success');
                            } else {
                                showToast((data && data.message) || 'Failed to delete exam', 'error');
                            }
                        } catch (err) {
                            console.error('Delete failed', err);
                            showToast('Failed to delete exam', 'error');
                        }
                    } else if (action === 'toggle') {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'You want to toggle the visibility of this exam?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Yes, toggle it!',
                            cancelButtonText: 'Cancel'
                        });

                        if (!result.isConfirmed) return;

                        settingsModal.classList.remove('show');

                        try {
                            const resp = await fetch(`/admin/online/exam/toggle/${id}`, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                            const data = await resp.json().catch(() => ({}));
                            if (resp.ok && data.success) {
                                const idx = allExams.findIndex(e => String(e.id) === String(id));
                                if (idx >= 0) { allExams[idx].status = data.status; }
                                filterExams();
                                showToast(data.message || 'Visibility updated', 'success');
                            } else {
                                showToast((data && data.message) || 'Failed to update visibility', 'error');
                            }
                        } catch (err) {
                            console.error('Toggle failed', err);
                            showToast('Failed to update visibility', 'error');
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Error fetching exam:', error);
            showToast('Failed to fetch exam data', 'error');
            settingsModal.classList.remove('show');
        }
    }

    // --- EDIT EXAM FUNCTIONS ---
    async function openEditModal(examId) {
        currentEditingExamId = examId;
        const editModal = document.getElementById('editExamModal');
        const editModalBody = document.getElementById('editModalBody');
        const editModalFooter = document.getElementById('editModalFooter');

        // Show modal with skeleton loader
        editModalBody.innerHTML = `
            <div class="skeleton-form">
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
                <div class="skeleton skeleton-p"></div>
            </div>
        `;
        editModalFooter.style.display = 'none';
        editModal.classList.add('show');

        try {
            const response = await fetch(`/admin/api/exam/${examId}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                showToast(data.message || 'Failed to fetch exam data', 'error');
                editModal.classList.remove('show');
                return;
            }

            populateEditForm(data.exam);
            editModalFooter.style.display = 'flex';
        } catch (error) {
            console.error('Error fetching exam:', error);
            showToast('Failed to fetch exam data', 'error');
            editModal.classList.remove('show');
        }
    }

    function populateEditForm(exam) {
        const editModalBody = document.getElementById('editModalBody');

        editModalBody.innerHTML = `
            <div>
                <label class="form-label">Title</label>
                <input type="text" name="title" required value="${escapeHtml(exam.title || '')}" class="form-input">
            </div>
            <div>
                <label class="form-label">Description</label>
                <textarea name="description" rows="4" class="form-textarea">${escapeHtml(exam.description || '')}</textarea>
            </div>

            <div>
                <label class="form-label">
                    <input type="checkbox" name="student_whatsapp" value="true" ${exam.student_whatsapp ? 'checked' : ''}>
                    Send WhatsApp notification to student
                </label>
            </div>
            <div>
                <label class="form-label">
                    <input type="checkbox" name="parent_whatsapp" value="true" ${exam.parent_whatsapp ? 'checked' : ''}>
                    Send WhatsApp notification to parent
                </label>
            </div>
            <div>
                <label class="form-label">
                    <input type="checkbox" name="close_after_deadline" value="true" ${exam.close_after_deadline ? 'checked' : ''}>
                    Close after deadline (Disable submissions after deadline)
                </label>
            </div>

            <div>
                <label class="form-label">Out of</label>
                <input type="number" name="out_of" placeholder="0" value="${exam.out_of || ''}" class="form-input">
            </div>

            <div>
                <label class="form-label">Group</label>
                <div id="edit-ms-groups-container" style="position: relative;"></div>
                <div id="edit-group-ids-container"></div>
            </div>
            <div>
                <label class="form-label">Exam Date</label>
                <input type="datetime-local" name="deadline_date" required value="${exam.deadline_date || ''}" class="form-input">
            </div>
            <div>
                <label class="form-label">Current Attachments</label>
                <div id="edit-existing-attachments">
                    ${renderExistingAttachments(exam.attachments || [], exam.id)}
                </div>
            </div>
            <div>
                <label class="form-label">Add New Attachments</label>
                <div id="edit-attachments-container">
                    <!-- Dynamic attachment fields will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" id="edit-add-attachment-btn" style="margin-top: 0.5rem;">
                    + Add Attachment
                </button>
            </div>
        `;

        // Setup group multi-select with tags
        setupEditGroupMultiSelect(exam.groups_mm || [], groups);
    }

    function setupEditGroupMultiSelect(selectedGroups, availableGroups) {
        let editSelectedGroups = selectedGroups.map(s => ({ id: String(s.id), name: s.name }));

        const multiSelect = document.createElement('div');
        multiSelect.className = 'multi-select';
        multiSelect.id = 'edit-multiSelectGroups';
        multiSelect.onclick = () => toggleEditGroupDropdown();

        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'edit-multiInputGroups';
        input.placeholder = 'Type or select groups...';
        input.oninput = () => filterEditGroups();

        multiSelect.appendChild(input);

        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-list';
        dropdown.id = 'edit-dropdownListGroups';
        dropdown.style.display = 'none';

        availableGroups.forEach(group => {
            const div = document.createElement('div');
            div.dataset.id = String(group.id);
            div.textContent = group.name;
            dropdown.appendChild(div);
        });

        dropdown.onclick = (e) => {
            if (e.target.dataset.id) {
                const id = e.target.dataset.id;
                const name = e.target.textContent;
                if (!editSelectedGroups.find(s => s.id === id)) {
                    editSelectedGroups.push({ id, name });
                    renderEditGroupTags();
                }
                input.value = '';
                filterEditGroups();
                dropdown.style.display = 'none';
            }
        };

        const container = document.getElementById('edit-ms-groups-container');
        const existingMultiSelect = container.querySelector('.multi-select');
        const existingDropdown = container.querySelector('.dropdown-list');

        if (existingMultiSelect) existingMultiSelect.remove();
        if (existingDropdown) existingDropdown.remove();

        container.appendChild(multiSelect);
        container.appendChild(dropdown);

        function renderEditGroupTags() {
            while (multiSelect.firstChild && multiSelect.firstChild !== input) {
                multiSelect.removeChild(multiSelect.firstChild);
            }
            editSelectedGroups.forEach(s => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '×';
                btn.onclick = () => {
                    editSelectedGroups = editSelectedGroups.filter(group => group.id !== s.id);
                    renderEditGroupTags();
                };
                tag.textContent = s.name + ' ';
                tag.appendChild(btn);
                multiSelect.insertBefore(tag, input);
            });

            // Update hidden inputs for form submission
            const hiddenContainer = document.getElementById('edit-group-ids-container');
            hiddenContainer.innerHTML = '';
            editSelectedGroups.forEach(s => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'groups[]';
                hiddenInput.value = s.id;
                hiddenContainer.appendChild(hiddenInput);
            });
        }

        window.toggleEditGroupDropdown = () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            if (dropdown.style.display === 'block') input.focus();
        };

        window.filterEditGroups = () => {
            const filter = input.value.toLowerCase();
            Array.from(dropdown.children).forEach(option => {
                const isSelected = editSelectedGroups.some(s => s.id === option.dataset.id);
                if (isSelected) {
                    option.style.display = 'none';
                } else {
                    option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
                }
            });
            dropdown.style.display = 'block';
        };

        renderEditGroupTags();

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.getElementById('edit-ms-groups-container');
            if (container && !container.contains(e.target) && dropdown) {
                dropdown.style.display = 'none';
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderExistingAttachments(attachments, examId) {
        if (!attachments || attachments.length === 0) {
            return '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
        }

        // Handle both old format (array of strings) and new format (array of objects)
        return attachments.map((attachment, index) => {
            let name, type, url;

            if (typeof attachment === 'string') {
                // Old format - backward compatibility
                name = attachment;
                type = attachment.startsWith('http') ? 'link' : 'file';
                url = type === 'link' ? attachment : `/student/assignments/uploads/${attachment}`;
            } else {
                // New format
                name = attachment.name || 'Unnamed Attachment';
                type = attachment.type || 'file';
                url = attachment.url || '#';
            }

            return `
                <div class="existing-attachment-item" data-index="${index}">
                    <div class="existing-attachment-info">
                        <span class="existing-attachment-name">${escapeHtml(name)}</span>
                        <span class="existing-attachment-type">${type}</span>
                    </div>
                    <button type="button" 
                            class="existing-attachment-delete" 
                            onclick="deleteExistingAttachment(event, ${examId}, ${index})">
                        Delete
                    </button>
                </div>
            `;
        }).join('');
    }

    // Make deleteExistingAttachment globally available
    window.deleteExistingAttachment = async function (event, examId, attachmentIndex) {
        const confirmed = await confirmAction(event, 'Are you sure you want to delete this attachment?');
        if (!confirmed) return;

        try {
            // Check if we're on a group-filtered page
            const filterGroupId = document.getElementById('examsScript').dataset.filterGroupId;
            let deleteUrl;

            if (filterGroupId) {
                deleteUrl = `/admin/group/${filterGroupId}/online/exam/delete-attachment/${examId}/${attachmentIndex}`;
            } else {
                deleteUrl = `/admin/online/exam/delete-attachment/${examId}/${attachmentIndex}`;
            }

            const resp = await fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            });

            const data = await resp.json().catch(() => ({}));

            if (resp.ok && data.success) {
                // Remove the attachment from the DOM
                const attachmentItem = document.querySelector(`#edit-existing-attachments .existing-attachment-item[data-index="${attachmentIndex}"]`);
                if (attachmentItem) {
                    attachmentItem.remove();
                }

                // Check if there are no more attachments
                const remainingAttachments = document.querySelectorAll('#edit-existing-attachments .existing-attachment-item');
                if (remainingAttachments.length === 0) {
                    document.getElementById('edit-existing-attachments').innerHTML = '<p style="color: #94a3b8; font-style: italic;">No existing attachments</p>';
                }

                showToast(data.message || 'Attachment deleted successfully', 'success');
            } else {
                showToast((data && data.message) || 'Failed to delete attachment', 'error');
            }
        } catch (err) {
            console.error('Delete attachment failed', err);
            showToast('Failed to delete attachment', 'error');
        }
    };

    // Handle edit form submission
    document.addEventListener('DOMContentLoaded', function () {
        const editForm = document.getElementById('editExamForm');
        if (!editForm) return;

        editForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentEditingExamId) return;

            const submitBtn = editForm.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            }

            try {
                const formData = new FormData(editForm);

                // Process new attachments for edit form
                const editAttachmentItems = document.querySelectorAll('#edit-attachments-container .attachment-item');
                let editAttachmentCount = 0;
                editAttachmentItems.forEach((item) => {
                    const itemId = item.id;
                    const counter = itemId.replace('edit-attachment-', '');

                    const nameInput = item.querySelector(`input[name="edit-attachment_name_${counter}"]`);
                    const typeInput = item.querySelector(`input[name="edit-attachment_type_${counter}"]`);
                    const fileInput = item.querySelector(`input[name="edit-attachment_file_${counter}"]`);
                    const linkInput = item.querySelector(`input[name="edit-attachment_link_${counter}"]`);

                    if (nameInput && typeInput) {
                        formData.append(`new_attachments[${editAttachmentCount}][name]`, nameInput.value);
                        formData.append(`new_attachments[${editAttachmentCount}][type]`, typeInput.value);

                        if (typeInput.value === 'file' && fileInput && fileInput.files.length > 0) {
                            formData.append(`new_attachments[${editAttachmentCount}][file]`, fileInput.files[0]);
                        } else if (typeInput.value === 'link' && linkInput) {
                            formData.append(`new_attachments[${editAttachmentCount}][url]`, linkInput.value);
                        }
                        editAttachmentCount++;
                    }
                });

                const resp = await fetch(`/admin/online/exam/edit/${currentEditingExamId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data.success && data.exam) {
                    // Update the exam in the list
                    const idx = allExams.findIndex(e => e.id === currentEditingExamId);
                    if (idx >= 0) {
                        allExams[idx] = data.exam;
                    }
                    filterExams();
                    editModal.classList.remove('show');
                    editForm.reset();
                    document.getElementById('edit-attachments-container').innerHTML = '';
                    editAttachmentCounter = 0;
                    currentEditingExamId = null;
                    showToast(data.message || 'Exam updated successfully', 'success');
                } else {
                    showToast((data && data.message) || 'Failed to update exam', 'error');
                }
            } catch (err) {
                console.error('Update exam failed', err);
                showToast('Failed to update exam', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText || 'Save Changes';
                }
            }
        });
    });

    // --- RENDER FUNCTION ---
    function renderExams(exams) {
        const grid = document.getElementById('examsGrid');
        if (!exams || !exams.length) {
            grid.innerHTML = `<div class="no-exams-message"><h3>No exams found.</h3><p>Try adjusting your filters or create a new exam to get started.</p></div>`;
            return;
        }

        grid.innerHTML = exams.map(e => {
            const groupsstr = (e.groups && e.groups.length) ? e.groups.join(', ') : 'All Groups';
            const due = e.deadline_date ? e.deadline_date : 'Not set';
            const hiddenClass = e.status !== 'Show' ? 'hidden-exam' : '';
            const viewHref = filterGroupId ? `/admin/online/exam/submissions/${e.id}?group_id=${filterGroupId}` : `/admin/online/exam/submissions/${e.id}`;
            const editHref = filterGroupId ? `/admin/online/exam/edit/${e.id}?group_id=${filterGroupId}` : `/admin/online/exam/edit/${e.id}`;
            const missing = (e.qualified_students_count || 0) - (e.submitted_students_count || 0);

            return `
            <div class="exam-card ${hiddenClass}" 
                 data-href="${viewHref}"
                 data-group="${e.groups ? e.groups.join(',') : ''}" 
                 data-title="${(e.title || '').toLowerCase()}">
                
                <div class="card-main-content">
                    <div class="card-header">
                        <div>
                            <h3 class="exam-title">${e.title}</h3>
                            <p class="exam-due">Due: ${due}</p>
                            <p class="exam-out-of">Out of: ${e.out_of || 'N/A'}</p>
                            <p class="exam-points">Points: ${e.points || 'N/A'}</p>
                            <p class="exam-close_after_deadline">Close after deadline: <span style="color: ${e.close_after_deadline ? 'green' : 'red'}; font-weight: bold;">${e.close_after_deadline ? 'Yes' : 'No'}</span></p>

                            <p class="exam-student_whatsapp">Messages are sent to students via WhatsApp: <span style="color: ${e.student_whatsapp ? 'green' : 'red'}; font-weight: bold;">${e.student_whatsapp ? 'Yes' : 'No'}</span></p>
                            <p class="exam-parent_whatsapp">Messages are sent to parents via WhatsApp: <span style="color: ${e.parent_whatsapp ? 'green' : 'red'}; font-weight: bold;">${e.parent_whatsapp ? 'Yes' : 'No'}</span></p>
                        </div>
                        <div class="card-actions">
                            <div class="action-buttons">
                                ${e.status !== 'Show' ? '<span class="badge badge-orange">HIDDEN</span>' : ''}
                        {% if current_user.role == "super_admin" %}

                                <button data-settings-id="${e.id}" class="btn-action js-settings" title="Settings">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="detail-item"><strong>Group(s)</strong> ${groupsstr}</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="stat-item">
                        <span class="stat-value green">${e.submitted_students_count || 0}</span>
                        <span class="stat-label">Submitted</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value red">${missing < 0 ? 0 : missing}</span>
                        <span class="stat-label">Missing</span>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // --- FILTERING LOGIC ---
    function getCheckedValues(listId) {
        const list = document.getElementById(listId);
        if (!list) return [];
        const allCheckbox = list.querySelector('input[type="checkbox"][value=""]');
        if (!allCheckbox || allCheckbox.checked) return [];
        return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value).filter(Boolean);
    }

    function filterExams() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sSchools = getCheckedValues('schoolDropdownList');

        const filteredExams = allExams.filter(exam => {
            const title = (exam.title || '').toLowerCase();
            const groups = exam.groups || [];

            const searchMatch = title.includes(search);
            const groupMatch = sSchools.length === 0 || (groups.length > 0 && sSchools.some(val => groups.includes(val)));

            const groupCatchAll = sSchools.length === 0 && groups.length === 0;

            return searchMatch && (groupMatch || groupCatchAll);
        });

        renderExams(filteredExams);
    }

    function enableFilters() {
        document.getElementById('searchInput').disabled = false;
        const schoolDropdown = document.getElementById('schoolDropdown');
        if (schoolDropdown) {
            schoolDropdown.classList.remove('disabled');
        }
        isLoading = false;
    }

    function populateFilterDropdowns() {
        const schoolList = document.getElementById('schoolDropdownList');
        if (schoolList) {
            schoolList.querySelectorAll('label:not(.dropdown-all)').forEach(l => l.remove());
            groups.forEach(group => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${group.name}"> ${group.name}`;
                schoolList.appendChild(label);
            });
        }
    }

    function populateModalDropdowns() {
        const schoolList = document.getElementById('ms-schools-list');
        if (schoolList) {
            schoolList.querySelectorAll('label:not(.multi-all)').forEach(l => l.remove());
            groups.forEach(group => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="schools[]" value="${group.id}"> ${group.name}`;
                schoolList.appendChild(label);
            });
        }
    }

    async function initializePage() {
        try {
            const [examsData, filtersData] = await Promise.all([
                fetchExams(),
                fetchFilters()
            ]);

            allExams = examsData;
            groups = filtersData.groups || [];

            populateFilterDropdowns();
            populateModalDropdowns();

            // Only setup group dropdown if it exists (not present when filtering by specific group)
            if (document.getElementById('schoolDropdown')) {
                setupDropdown('schoolDropdown', 'schoolDropdownBtn', 'schoolDropdownList', 'All Groups', filterExams);
            }
            // Only setup group multi-select if it exists (not present when filtering by specific group)
            if (document.getElementById('ms-schools')) {
                setupDropdown('ms-schools', 'ms-schools-btn', 'ms-schools-list', 'All Groups');
            }

            renderExams(allExams);
            enableFilters();

            document.getElementById('searchInput').addEventListener('input', filterExams);

            const gridEl = document.getElementById('examsGrid');
            gridEl.addEventListener('click', async function (e) {
                const card = e.target.closest('.exam-card');

                const settingsBtn = e.target.closest('.js-settings');
                if (settingsBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = settingsBtn.getAttribute('data-settings-id');
                    openSettingsModal(parseInt(id));
                    return;
                }

                if (card && card.dataset.href) {
                    window.location.href = card.dataset.href;
                }
            });

        } catch (error) {
            console.error('Error initializing exams page:', error);
            const grid = document.getElementById('examsGrid');
            grid.innerHTML = `<div class="no-exams-message"><h3>Error loading exams.</h3><p>Please refresh the page to try again.</p></div>`;
            enableFilters();
        }
    }
    document.addEventListener('DOMContentLoaded', initializePage);
</script>
{% endblock %}