{% extends "admin/dashboard.html" %}
{% block title %}Submissions for {{ exam.title }}{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    .assistant-assignment-panel {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
    }

    .assistant-assignment-panel h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: var(--space-4);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assistants-grid {
        display: grid;
        gap: var(--space-4);
    }

    .assistant-card {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        border: 1px solid var(--color-border);
        transition: all 0.2s;
    }

    .assistant-card:hover {
        border-color: var(--color-primary);
        box-shadow: var(--shadow-md);
    }

    .assistant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .assistant-info h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 0.25rem;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assistant-info p {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assistant-stats {
        text-align: right;
    }

    .assistant-stats .assigned-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assignment-form {
        display: grid;
        grid-template-columns: 1fr 1fr auto auto;
        gap: 0.75rem;
        align-items: end;
    }

    .assignment-form .form-group {
        margin-bottom: 0;
    }

    .assignment-form label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-primary);
        margin-bottom: 0.375rem;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assignment-form input[type="number"] {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        transition: all 0.2s;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--color-white);
    }

    .assignment-form input[type="number"]:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px hsla(217, 91%, 60%, 0.2);
    }

    .btn-assign {
        padding: 0.625rem 1.25rem;
        background: var(--color-primary);
        color: var(--color-white);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .btn-assign:hover {
        background: var(--color-primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-unassign {
        padding: 0.625rem 1.25rem;
        background: var(--color-danger);
        color: var(--color-white);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .btn-unassign:hover {
        background: hsl(0, 84%, 54%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .stats-grid-new {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .stat-card-new {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border);
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }

    .stat-card-new:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-card-new.unassigned {
        border-left-color: var(--color-text-secondary);
    }

    .stat-card-new.approved {
        border-left-color: var(--color-success);
    }

    .stat-card-new.waiting {
        border-left-color: var(--color-danger);
    }

    .stat-card-new.not-corrected {
        border-left-color: var(--color-warning);
    }

    .stat-label-new {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-bottom: 0.5rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .stat-value-new {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--color-text-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assigned-to-column {
        color: var(--color-primary);
        font-weight: 500;
        font-size: 0.875rem;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .assigned-to-column.unassigned {
        color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
        .assignment-form {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}

{% set total_students = submissions|length + not_submitted_students|length %}
{% set submitted_count = submissions|length %}
{% set missing_count = not_submitted_students|length %}
{% set late_count = namespace(value=0) %}
{% for sub in submissions %}
{% if sub.upload_time > sub.assignment.deadline_date %}
{% set late_count.value = late_count.value + 1 %}
{% endif %}
{% endfor %}

<header class="page-header">
    <div class="page-header-content">
        {% if group_id and group %}
        <a href="{{ url_for('admin.group_exams', group_id=group_id) }}" class="back-button">← Back to {{ group.name }} Exams</a>
        {% else %}
        <a href="{{ url_for('admin.online_exam') }}" class="back-button">← Back to Exams</a>
        {% endif %}
        <h1 class="page-title">Exam Details</h1>
    </div>
</header>

<div class="container">
    <div class="card info-card">
        <div class="info-card-details">
            <h2>{{ exam.title }}</h2>
            <div class="info-card-meta">
                <span class="meta-item"><span class="meta-dot" style="background-color: var(--color-info);"></span> Due:
                    {{ exam.deadline_date.strftime('%b %d, %Y at %I:%M %p') }}</span>
                <span class="meta-item"><span class="meta-dot" style="background-color: var(--color-warning);"></span>
                    {{ exam.points }} Points</span>
            </div>
        </div>
        <div>
            Completion:
            <strong style="font-size: 1.5rem;">
                {% if total_students > 0 %}{{ "%.0f"|format((submitted_count / total_students) * 100) }}{% else %}0{% endif %}%
            </strong>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/student.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Total Students</p>
                <p class="value">{{ total_students }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/submit.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Submitted</p>
                <p class="value">{{ submitted_count }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/incomplete.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Missing</p>
                <p class="value">{{ missing_count }}</p>
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-card-icon"><img src="/static/images/admin/assignments/overdue.png" alt=""></div>
            <div class="stat-card-info">
                <p class="label">Late</p>
                <p class="value">{{ late_count.value }}</p>
            </div>
        </div>
    </div>

    <!-- New Assignment Statistics -->
    <div class="stats-grid-new">
        {% if current_user.role == "super_admin" %}
        <div class="stat-card-new unassigned">
            <div class="stat-label-new">Unassigned Submissions</div>
            <div class="stat-value-new">{{ unassigned_count }}</div>
        </div>
        {% endif %}
        <div class="stat-card-new approved">
            <div class="stat-label-new">Approved Submissions</div>
            <div class="stat-value-new">{{ approved_count }}</div>
        </div>
        <div class="stat-card-new waiting">
            <div class="stat-label-new">Waiting Approval</div>
            <div class="stat-value-new">{{ waiting_approval_count }}</div>
        </div>
        <div class="stat-card-new not-corrected">
            <div class="stat-label-new">Not Corrected (Assigned)</div>
            <div class="stat-value-new">{{ not_corrected_assigned }}</div>
        </div>
    </div>

    <!-- Assistant Assignment Panel (Super Admin Only) -->
    {% if current_user.role == "super_admin" and assistants %}
    <div class="assistant-assignment-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSection('assistantsSection')">
            <h3>📋 Assign Submissions to Assistants</h3>
            <span id="assistantsToggle" style="font-size: 1.5rem; transition: transform 0.3s;">▼</span>
        </div>
        <div id="assistantsSection" class="assistants-grid" style="display: none; margin-top: 1rem;">
            {% for assistant in assistants %}
            {% set assistant_assigned = submissions|selectattr('assigned_to_id', 'equalto', assistant.id)|list %}
            {% set assistant_assigned_count = assistant_assigned|length %}
            <div class="assistant-card">
                <div class="assistant-header">
                    <div class="assistant-info">
                        <h4>{{ assistant.name }}</h4>
                        <p>{{ assistant.email }}</p>
                    </div>
                    <div class="assistant-stats">
                        <div class="assigned-count">{{ assistant_assigned_count }}</div>
                        <small style="color: #718096;">assigned</small>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('admin.assign_submissions_to_assistant', assignment_id=exam.id) }}" class="assignment-form">
                    <input type="hidden" name="assistant_id" value="{{ assistant.id }}">
                    {% if group_id %}
                    <input type="hidden" name="group_id" value="{{ group_id }}">
                    {% endif %}
                    <div class="form-group">
                        <label for="start_{{ assistant.id }}">Start Index</label>
                        <input type="number" id="start_{{ assistant.id }}" name="start_index" min="1" max="{{ total_submissions }}" placeholder="1" required>
                    </div>
                    <div class="form-group">
                        <label for="end_{{ assistant.id }}">End Index</label>
                        <input type="number" id="end_{{ assistant.id }}" name="end_index" min="1" max="{{ total_submissions }}" placeholder="{{ total_submissions }}" required>
                    </div>
                    <button type="submit" class="btn-assign">
                        ✓ Assign
                    </button>
                    {% if assistant_assigned_count > 0 %}
                    <button type="submit" formaction="{{ url_for('admin.unassign_submissions', assignment_id=exam.id) }}" class="btn-unassign" onclick="return confirm('Unassign all submissions from {{ assistant.name }}?')">
                        ✗ Unassign
                    </button>
                    {% endif %}
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
