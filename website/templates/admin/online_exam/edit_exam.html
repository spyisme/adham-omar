{% extends "admin/dashboard.html" %}
{% block title %}Edit Exam{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* Multi-select dropdown styles */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: .5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: .4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: .25rem .65rem;
        font-size: .9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: .4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    .dropdown {
        position: relative;
        width: 100%;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: .5rem .75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }

    .late-exception-card {
        border-top: 1px solid #e2e8f0;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }

    .late-exception-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.95rem;
    }

    .late-exception-table th,
    .late-exception-table td {
        padding: 0.6rem 0.75rem;
        border: 1px solid #e2e8f0;
        text-align: left;
    }

    .late-exception-table th {
        background: #f1f5f9;
        font-weight: 600;
    }

    .late-exception-status-active {
        color: #15803d;
        font-weight: 600;
    }

    .late-exception-status-expired {
        color: #dc2626;
        font-weight: 600;
    }

    .late-exception-actions form {
        display: inline-flex;
    }

    .late-exception-form {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1.25rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px dashed #cbd5f5;
    }

    .late-exception-form label {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .late-exception-form input[type="text"],
    .late-exception-form input[type="datetime-local"] {
        flex: 1 1 220px;
        min-width: 200px;
    }

    .late-exception-form button {
        flex: 0 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <div class="page-header-content">
        {% if group_id and group %}
        <a href="{{ url_for('admin.group_exams', group_id=group_id) }}" class="back-button">← Back to {{ group.name }}
            Exams</a>
        {% else %}
        <a href="{{ url_for('admin.online_exam') }}" class="back-button">← Back to Exams</a>
        {% endif %}
        <h1 class="page-title">Edit Exam</h1>
    </div>
</header>

<main class="container">
    <div class="card" style="max-width: 700px; margin: 0 auto;">
        <form class="card-content" method="POST" enctype="multipart/form-data">
            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div>
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" value="{{ exam.title }}" required class="form-input" />
                </div>

                <div>
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-textarea"
                        style="min-height:90px; resize:vertical;">{{ exam.description }}</textarea>
                </div>

                <div>
                    <label for="out_of" class="form-label">Out of</label>
                    <input type="number" id="out_of" name="out_of" class="form-input" min="1"
                        value="{{ exam.out_of or '' }}" required />
                </div>


                <div>
                    <label for="deadline_date" class="form-label">Deadline</label>
                    <input type="datetime-local" id="deadline_date" name="deadline_date"
                        value="{{ exam.deadline_date.strftime('%Y-%m-%dT%H:%M') if exam.deadline_date else '' }}"
                        class="form-input">
                </div>

                <div>
                    <label for="subject" class="form-label">Subject</label>
                    <div class="multi" id="ms-subjects">
                        <button type="button" class="btn form-input multi-btn" id="ms-subjects-btn">
                            {{ exam.subject.name if exam.subject else 'Select Subject' }} ▼
                        </button>
                        <div class="multi-list" id="ms-subjects-list">
                            {% for subject in subjects %}
                            <label>
                                <input type="radio" name="subject" value="{{ subject.id }}" required {% if exam.subject
                                    and exam.subject.id==subject.id %}checked{% endif %}>
                                {{ subject.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Schools</label>
                    <div class="dropdown">
                        <div id="multiSelectSchools" class="multi-select" onclick="toggleSchoolDropdown()">
                            <input type="text" id="multiInputSchools" placeholder="Type or select schools..."
                                oninput="filterSchools()">
                        </div>
                        <div id="dropdownListSchools" class="dropdown-list">
                            {% for school in schools %}
                            <div data-id="{{ school.id }}">{{ school.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="school_ids" id="selectedSchools">
                    {% if exam.schools_mm %}
                    <script type="application/json" id="preselected-schools-data">
                        [{% for school in exam.schools_mm %}{"id": "{{ school.id }}", "name": "{{ school.name|e }}"}{{ "," if not loop.last }}{% endfor %}]
                    </script>
                    {% endif %}
                </div>

                <div>
                    <label class="form-label">Years</label>
                    <div class="multi" id="ms-stages">
                        <button type="button" class="btn form-input multi-btn" id="ms-stages-btn">All Stages ▼</button>
                        <div class="multi-list" id="ms-stages-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not exam.stages_mm
                                    %}checked{% endif %}>All Stages</label>
                            {% for stage in stages %}
                            <label>
                                <input type="checkbox" name="stages[]" value="{{ stage.id }}" {% if exam.stages_mm and
                                    stage in exam.stages_mm %}checked{% endif %}>
                                {{ stage.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Classes</label>
                    <div class="multi" id="ms-groups">
                        <button type="button" class="btn form-input multi-btn" id="ms-groups-btn">All Classes ▼</button>
                        <div class="multi-list" id="ms-groups-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not exam.groups_mm
                                    %}checked{% endif %}>All Classes</label>
                            {% for group in groups %}
                            <label>
                                <input type="checkbox" name="groups[]" value="{{ group.id }}" {% if exam.groups_mm and
                                    group in exam.groups_mm %}checked{% endif %}>
                                {{ group.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <hr style="margin: var(--space-2) 0;">

                <div>
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-4);">Attachments</h3>
                    {% if attachments %}
                    <ul
                        style="list-style: none; padding: 0; margin: 0 0 1rem 0; display: flex; flex-direction: column; gap: 0.5rem;">
                        {% for filename in attachments %}
                        <li
                            style="display: flex; justify-content: space-between; align-items: center; background: var(--color-bg-secondary); padding: 0.5rem 1rem; border-radius: var(--radius-md);">
                            <a href="{{ url_for('student.assignment_media', filename=filename) }}" target="_blank"
                                style="word-break: break-all;">{{ filename }}</a>
                            <a href="{{ url_for('admin.edit_exam', exam_id=exam.id, delete_attachment=filename) }}"
                                style="color: var(--color-danger); text-decoration: none; font-weight: 500; margin-left: 1rem;">Delete</a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem;">No existing attachments.</p>
                    {% endif %}
                    <label for="attachments" class="form-label">Add New Attachments</label>
                    <input type="file" id="attachments" name="attachments" multiple class="form-input" />
                </div>

                <div class="late-exception-card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--space-2);">Late Submission Exceptions</h3>
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        Grant selected students extra time to submit this exam after the deadline. You can optionally set a custom deadline for each student.
                    </p>

                    {% if late_exceptions %}
                    <div style="overflow-x: auto;">
                        <table class="late-exception-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Extension Deadline</th>
                                    <th>Status</th>
                                    <th style="width: 140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in late_exceptions %}
                                <tr>
                                    <td>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 600;">{{ item.student.name or 'Unnamed' }}</span>
                                            <span style="font-size: 0.85rem; color: var(--color-text-secondary);">{{ item.student.email }}</span>
                                            <span style="font-size: 0.8rem; color: var(--color-text-secondary);">ID: {{ item.student.id }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.aware_deadline %}
                                        {{ item.aware_deadline.strftime('%B %d, %Y at %I:%M %p') }}
                                        {% else %}
                                        <em>No deadline</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_active %}
                                        <span class="late-exception-status-active">Active</span>
                                        {% else %}
                                        <span class="late-exception-status-expired">Expired</span>
                                        {% endif %}
                                    </td>
                                    <td class="late-exception-actions">
                                        <form method="POST" action="{{ url_for('admin.remove_late_exception', assignment_id=exam.id, exception_id=item.exception.id) }}" onsubmit="return confirm('Remove late submission exception for {{ item.student.name or item.student.email }}?');">
                                            <input type="hidden" name="source" value="exam_edit">
                                            <input type="hidden" name="exception_student_id" value="{{ item.student.id }}">
                                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p style="color: var(--color-text-secondary); font-size: 0.9rem;">No late submission exceptions have been granted yet.</p>
                    {% endif %}

                    <form method="POST" action="{{ url_for('admin.add_late_exception', assignment_id=exam.id) }}" class="late-exception-form">
                        <input type="hidden" name="source" value="exam_edit">
                        <label for="student-identifier">Student ID or Email</label>
                        <input type="text" id="student-identifier" name="student_identifier" placeholder="e.g. 1024 or user@example.com" required>
                        <label for="extended-deadline">Extended Deadline (optional)</label>
                        <input type="datetime-local" id="extended-deadline" name="extended_deadline">
                        <button type="submit" class="btn btn-secondary">Grant Exception</button>
                    </form>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
    // Multi-select schools functionality
    const schoolDropdown = document.getElementById('dropdownListSchools');
    const schoolMultiSelect = document.getElementById('multiSelectSchools');
    const schoolInput = document.getElementById('multiInputSchools');
    const schoolHiddenInput = document.getElementById('selectedSchools');
    let selectedSchools = [];

    function toggleSchoolDropdown() {
        schoolDropdown.style.display = schoolDropdown.style.display === 'block' ? 'none' : 'block';
        if (schoolDropdown.style.display === 'block') {
            schoolInput.focus();
        }
    }

    function filterSchools() {
        const filter = schoolInput.value.toLowerCase();
        Array.from(schoolDropdown.children).forEach(option => {
            const isSelected = selectedSchools.some(s => s.id === option.dataset.id);
            if (isSelected) {
                option.style.display = 'none';
            } else {
                option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
            }
        });
        schoolDropdown.style.display = 'block';
    }

    schoolDropdown.addEventListener('click', (e) => {
        if (e.target.dataset.id) {
            const id = e.target.dataset.id;
            const name = e.target.textContent;
            if (!selectedSchools.find(s => s.id === id)) {
                selectedSchools.push({ id, name });
                renderSchoolTags();
            }
            schoolInput.value = '';
            filterSchools();
            schoolDropdown.style.display = 'none';
        }
    });

    function renderSchoolTags() {
        // Clear current tags, but keep the input
        while (schoolMultiSelect.firstChild && schoolMultiSelect.firstChild !== schoolInput) {
            schoolMultiSelect.removeChild(schoolMultiSelect.firstChild);
        }

        selectedSchools.forEach(s => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${s.name} <button type="button" onclick="removeSchoolTag('${s.id}')">×</button>`;
            schoolMultiSelect.insertBefore(tag, schoolInput);
        });
        schoolHiddenInput.value = selectedSchools.map(s => s.id).join(',');
    }

    function removeSchoolTag(id) {
        selectedSchools = selectedSchools.filter(s => s.id !== id);
        renderSchoolTags();
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
        if (!schoolMultiSelect.parentElement.contains(e.target)) {
            schoolDropdown.style.display = 'none';
        }
    });

    // Pre-populate selected schools if editing
    document.addEventListener('DOMContentLoaded', function () {
        const preselectedData = document.getElementById('preselected-schools-data');
        if (preselectedData) {
            try {
                selectedSchools = JSON.parse(preselectedData.textContent);
                renderSchoolTags();
            } catch (e) {
                console.error('Error parsing preselected schools data:', e);
            }
        }
    });

    function setupDropdown(dropdownId, btnId, listId, labelAll) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');
        const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) dropdown.classList.add('open');
        };

        if (allCheckbox) {
            allCheckbox.onchange = function () {
                if (allCheckbox.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
                updateBtnLabel();
            };
        }

        checkboxes.forEach(cb => {
            cb.onchange = function () {
                if (cb.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
                updateBtnLabel();
            };
        });

        function updateBtnLabel() {
            let selected = checkboxes.filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ▼";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 20) + (selected[0].length > 20 ? '...' : '') + " ▼";
            } else {
                btn.textContent = selected.length + " selected ▼";
            }
        }
        updateBtnLabel();
    }

    document.addEventListener('click', function (e) {
        document.querySelectorAll('.multi.open').forEach(d => {
            if (!d.contains(e.target)) d.classList.remove('open');
        });
    });

    // Setup for multi-selects (keeping stages and groups with old system)
    setupDropdown('ms-stages', 'ms-stages-btn', 'ms-stages-list', 'All Stages');
    setupDropdown('ms-groups', 'ms-groups-btn', 'ms-groups-list', 'All Classes');

    // Setup for single-select (radio)
    const subjectDropdown = document.getElementById('ms-subjects');
    const subjectBtn = document.getElementById('ms-subjects-btn');
    const subjectList = document.getElementById('ms-subjects-list');

    if (subjectDropdown) {
        subjectBtn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = subjectDropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) subjectDropdown.classList.add('open');
        };
        subjectList.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.onchange = function () {
                const selectedLabel = this.parentElement.textContent.trim();
                subjectBtn.textContent = selectedLabel + " ▼";
                subjectDropdown.classList.remove('open');
            };
        });
    }
</script>
{% endblock %}
