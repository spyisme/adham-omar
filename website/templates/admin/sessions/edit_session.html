{% extends "admin/dashboard.html" %}
{% block title %}Edit Session{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}">
<style>
    /* Multi-select dropdown styles */
    .multi-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: .5rem;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: .4rem;
        cursor: text;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 1rem;
        background: transparent;
    }

    .tag {
        background: #eef2ff;
        color: #4338ca;
        border-radius: 999px;
        padding: .25rem .65rem;
        font-size: .9em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: .4rem;
    }

    .tag button {
        border: none;
        background: none;
        font-size: 1rem;
        cursor: pointer;
        color: #4338ca;
        padding: 0;
        line-height: 1;
    }

    .dropdown {
        position: relative;
        width: 100%;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
    }

    .dropdown-list div {
        padding: .5rem .75rem;
        cursor: pointer;
    }

    .dropdown-list div:hover {
        background: #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <div class="page-header-content">
        <a href="{{ url_for('admin.session_details', session_id=session.id) }}" class="back-button">← Back to
            Session</a>
        <h1 class="page-title">Edit Session</h1>
    </div>
</header>

<main class="container">
    <div class="card" style="max-width: 700px; margin: 0 auto;">
        <form class="card-content" method="POST" enctype="multipart/form-data">
            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div>
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" value="{{ session.title }}" required
                        class="form-input" />
                </div>

                <div>
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-textarea"
                        style="min-height:90px; resize:vertical;">{{ session.description }}</textarea>
                </div>

                <div>
                    <label for="subject" class="form-label">Subject</label>
                    <div class="multi" id="ms-subjects">
                        <button type="button" class="btn form-input multi-btn" id="ms-subjects-btn">
                            {{ session.subject.name if session.subject else 'Select Subject' }} ▼
                        </button>
                        <div class="multi-list" id="ms-subjects-list">
                            {% for subject in subjects %}
                            <label>
                                <input type="radio" name="subject" value="{{ subject.id }}" required {% if
                                    session.subject and session.subject.id==subject.id %}checked{% endif %}>
                                {{ subject.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Schools</label>
                    <div class="dropdown">
                        <div id="multiSelectSchools" class="multi-select" onclick="toggleSchoolDropdown()">
                            <input type="text" id="multiInputSchools" placeholder="Type or select schools..."
                                oninput="filterSchools()">
                        </div>
                        <div id="dropdownListSchools" class="dropdown-list">
                            {% for school in schools %}
                            <div data-id="{{ school.id }}">{{ school.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="school_ids" id="selectedSchools">
                    {% if session.schools_mm %}
                    <script type="application/json" id="preselected-schools-data">
                        [{% for school in session.schools_mm %}{"id": "{{ school.id }}", "name": "{{ school.name|e }}"}{{ "," if not loop.last }}{% endfor %}]
                    </script>
                    {% endif %}
                </div>

                <div>
                    <label class="form-label">Years</label>
                    <div class="multi" id="ms-stages">
                        <button type="button" class="btn form-input multi-btn" id="ms-stages-btn">All Stages ▼</button>
                        <div class="multi-list" id="ms-stages-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not session.stages_mm
                                    %}checked{% endif %}>All Stages</label>
                            {% for stage in stages %}
                            <label>
                                <input type="checkbox" name="stages[]" value="{{ stage.id }}" {% if session.stages_mm
                                    and stage in session.stages_mm %}checked{% endif %}>
                                {{ stage.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">Classes</label>
                    <div class="multi" id="ms-groups">
                        <button type="button" class="btn form-input multi-btn" id="ms-groups-btn">All Classes ▼</button>
                        <div class="multi-list" id="ms-groups-list">
                            <label class="multi-all"><input type="checkbox" value="" {% if not session.groups_mm
                                    %}checked{% endif %}>All Classes</label>
                            {% for group in groups %}
                            <label>
                                <input type="checkbox" name="groups[]" value="{{ group.id }}" {% if session.groups_mm
                                    and group in session.groups_mm %}checked{% endif %}>
                                {{ group.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div>
                    <label for="thumbnail" class="form-label">Session Thumbnail</label>
                    {% if session.id %}
                    <div style="margin-bottom: 0.5rem;">
                        <img src="{{ url_for('static', filename='sessions') }}/session_{{ session.id }}.jpg"
                            alt="Current thumbnail"
                            style="max-width: 200px; max-height: 100px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #e5e7eb;"
                            onerror="this.style.display='none'">
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0.25rem 0;">Current
                            thumbnail (upload a new one to replace)</p>
                    </div>
                    {% endif %}
                    <input type="file" id="thumbnail" name="thumbnail" accept="image/*" class="form-input" />
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
    // Multi-select schools functionality
    const schoolDropdown = document.getElementById('dropdownListSchools');
    const schoolMultiSelect = document.getElementById('multiSelectSchools');
    const schoolInput = document.getElementById('multiInputSchools');
    const schoolHiddenInput = document.getElementById('selectedSchools');
    let selectedSchools = [];

    function toggleSchoolDropdown() {
        schoolDropdown.style.display = schoolDropdown.style.display === 'block' ? 'none' : 'block';
        if (schoolDropdown.style.display === 'block') {
            schoolInput.focus();
        }
    }

    function filterSchools() {
        const filter = schoolInput.value.toLowerCase();
        Array.from(schoolDropdown.children).forEach(option => {
            const isSelected = selectedSchools.some(s => s.id === option.dataset.id);
            if (isSelected) {
                option.style.display = 'none';
            } else {
                option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
            }
        });
        schoolDropdown.style.display = 'block';
    }

    schoolDropdown.addEventListener('click', (e) => {
        if (e.target.dataset.id) {
            const id = e.target.dataset.id;
            const name = e.target.textContent;
            if (!selectedSchools.find(s => s.id === id)) {
                selectedSchools.push({ id, name });
                renderSchoolTags();
            }
            schoolInput.value = '';
            filterSchools();
            schoolDropdown.style.display = 'none';
        }
    });

    function renderSchoolTags() {
        // Clear current tags, but keep the input
        while (schoolMultiSelect.firstChild && schoolMultiSelect.firstChild !== schoolInput) {
            schoolMultiSelect.removeChild(schoolMultiSelect.firstChild);
        }

        selectedSchools.forEach(s => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${s.name} <button type="button" onclick="removeSchoolTag('${s.id}')">×</button>`;
            schoolMultiSelect.insertBefore(tag, schoolInput);
        });
        schoolHiddenInput.value = selectedSchools.map(s => s.id).join(',');
    }

    function removeSchoolTag(id) {
        selectedSchools = selectedSchools.filter(s => s.id !== id);
        renderSchoolTags();
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
        if (!schoolMultiSelect.parentElement.contains(e.target)) {
            schoolDropdown.style.display = 'none';
        }
    });

    // Pre-populate selected schools if editing
    document.addEventListener('DOMContentLoaded', function () {
        const preselectedData = document.getElementById('preselected-schools-data');
        if (preselectedData) {
            try {
                selectedSchools = JSON.parse(preselectedData.textContent);
                renderSchoolTags();
            } catch (e) {
                console.error('Error parsing preselected schools data:', e);
            }
        }
    });

    function setupDropdown(dropdownId, btnId, listId, labelAll) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const btn = document.getElementById(btnId);
        const list = document.getElementById(listId);
        const allCheckbox = list.querySelector('label input[type="checkbox"][value=""]');
        const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);

        btn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = dropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) dropdown.classList.add('open');
        };

        if (allCheckbox) {
            allCheckbox.onchange = function () {
                if (allCheckbox.checked) {
                    checkboxes.forEach(cb => cb.checked = false);
                }
                updateBtnLabel();
            };
        }

        checkboxes.forEach(cb => {
            cb.onchange = function () {
                if (cb.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (allCheckbox && !checkboxes.some(c => c.checked)) {
                    allCheckbox.checked = true;
                }
                updateBtnLabel();
            };
        });

        function updateBtnLabel() {
            let selected = checkboxes.filter(cb => cb.checked).map(cb => cb.parentElement.textContent.trim());
            if (!allCheckbox || allCheckbox.checked || selected.length === 0) {
                btn.textContent = labelAll + " ▼";
            } else if (selected.length === 1) {
                btn.textContent = selected[0].substring(0, 20) + (selected[0].length > 20 ? '...' : '') + " ▼";
            } else {
                btn.textContent = selected.length + " selected ▼";
            }
        }
        updateBtnLabel();
    }

    document.addEventListener('click', function (e) {
        document.querySelectorAll('.multi.open').forEach(d => {
            if (!d.contains(e.target)) d.classList.remove('open');
        });
    });

    // Setup for multi-selects (keeping stages and groups with old system)
    setupDropdown('ms-stages', 'ms-stages-btn', 'ms-stages-list', 'All Stages');
    setupDropdown('ms-groups', 'ms-groups-btn', 'ms-groups-list', 'All Classes');

    // Setup for single-select (radio)
    const subjectDropdown = document.getElementById('ms-subjects');
    const subjectBtn = document.getElementById('ms-subjects-btn');
    const subjectList = document.getElementById('ms-subjects-list');

    if (subjectDropdown) {
        subjectBtn.onclick = function (e) {
            e.stopPropagation();
            const isCurrentlyOpen = subjectDropdown.classList.contains('open');
            document.querySelectorAll('.multi').forEach(d => d.classList.remove('open'));
            if (!isCurrentlyOpen) subjectDropdown.classList.add('open');
        };
        subjectList.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.onchange = function () {
                const selectedLabel = this.parentElement.textContent.trim();
                subjectBtn.textContent = selectedLabel + " ▼";
                subjectDropdown.classList.remove('open');
            };
        });
    }
</script>
{% endblock %}